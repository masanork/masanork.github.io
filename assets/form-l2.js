var mn=Object.create;var{getPrototypeOf:en,defineProperty:e,getOwnPropertyNames:an}=Object;var nc=Object.prototype.hasOwnProperty;var a=(n,c,t)=>{t=n!=null?mn(en(n)):{};let f=c||!n||!n.__esModule?e(t,"default",{value:n,enumerable:!0}):t;for(let h of an(n))if(!nc.call(f,h))e(f,h,{get:()=>n[h],enumerable:!0});return f};var cc=(n,c)=>()=>(c||n((c={exports:{}}).exports,c),c.exports);var tc=(n,c)=>{for(var t in c)e(n,t,{get:c[t],enumerable:!0,configurable:!0,set:(f)=>c[t]=()=>f})};var uc=(n,c)=>()=>(n&&(c=n(n=0)),c);var fc=((n)=>typeof require!=="undefined"?require:typeof Proxy!=="undefined"?new Proxy(n,{get:(c,t)=>(typeof require!=="undefined"?require:c)[t]}):n)(function(n){if(typeof require!=="undefined")return require.apply(this,arguments);throw Error('Dynamic require of "'+n+'" is not supported')});var nn=cc((tt,Hn)=>{Hn.exports=function n(c){if(typeof c==="number"&&isNaN(c))throw new Error("NaN is not allowed");if(typeof c==="number"&&!isFinite(c))throw new Error("Infinity is not allowed");if(c===null||typeof c!=="object")return JSON.stringify(c);if(c.toJSON instanceof Function)return n(c.toJSON());if(Array.isArray(c))return`[${c.reduce((h,H,u)=>{return`${h}${u===0?"":","}${n(H===void 0||typeof H==="symbol"?null:H)}`},"")}]`;return`{${Object.keys(c).sort().reduce((f,h)=>{if(c[h]===void 0||typeof c[h]==="symbol")return f;let H=f.length===0?"":",";return`${f}${H}${n(h)}:${n(c[h])}`},"")}}`}});var Un={};tc(Un,{win32:()=>un,toNamespacedPath:()=>bc,sep:()=>Vc,resolve:()=>Yc,relative:()=>Gc,posix:()=>b,parse:()=>Sc,normalize:()=>Bc,join:()=>Lc,isAbsolute:()=>Dc,format:()=>Nc,extname:()=>zc,dirname:()=>Oc,delimiter:()=>Ac,default:()=>Uc,basename:()=>Kc});var Ic,Mn,Cc,lc,vc,Qc,jc=(n,c)=>()=>(c||n((c={exports:{}}).exports,c),c.exports),Jc=(n,c,t,f)=>{if(c&&typeof c=="object"||typeof c=="function")for(let h of lc(c))!Qc.call(n,h)&&h!==t&&Mn(n,h,{get:()=>c[h],enumerable:!(f=Cc(c,h))||f.enumerable});return n},Mc=(n,c,t)=>(t=n!=null?Ic(vc(n)):{},Jc(c||!n||!n.__esModule?Mn(t,"default",{value:n,enumerable:!0}):t,n)),Xc,Xn,J,Zc,Jn=function(n){return n},Zn=function(){throw new Error("Not implemented")},b,un,Uc,Yc,Bc,Dc,Lc,Gc,bc,Oc,Kc,zc,Nc,Sc,Vc,Ac;var Yn=uc(()=>{Ic=Object.create,Mn=Object.defineProperty,Cc=Object.getOwnPropertyDescriptor,lc=Object.getOwnPropertyNames,vc=Object.getPrototypeOf,Qc=Object.prototype.hasOwnProperty,Xc=jc((n,c)=>{function t(u){if(typeof u!="string")throw new TypeError("Path must be a string. Received "+JSON.stringify(u))}function f(u,o){for(var $="",x=0,q=-1,P=0,C,I=0;I<=u.length;++I){if(I<u.length)C=u.charCodeAt(I);else{if(C===47)break;C=47}if(C===47){if(!(q===I-1||P===1))if(q!==I-1&&P===2){if($.length<2||x!==2||$.charCodeAt($.length-1)!==46||$.charCodeAt($.length-2)!==46){if($.length>2){var v=$.lastIndexOf("/");if(v!==$.length-1){v===-1?($="",x=0):($=$.slice(0,v),x=$.length-1-$.lastIndexOf("/")),q=I,P=0;continue}}else if($.length===2||$.length===1){$="",x=0,q=I,P=0;continue}}o&&($.length>0?$+="/..":$="..",x=2)}else $.length>0?$+="/"+u.slice(q+1,I):$=u.slice(q+1,I),x=I-q-1;q=I,P=0}else C===46&&P!==-1?++P:P=-1}return $}function h(u,o){var $=o.dir||o.root,x=o.base||(o.name||"")+(o.ext||"");return $?$===o.root?$+x:$+u+x:x}var H={resolve:function(){for(var u="",o=!1,$,x=arguments.length-1;x>=-1&&!o;x--){var q;x>=0?q=arguments[x]:($===void 0&&($=process.cwd()),q=$),t(q),q.length!==0&&(u=q+"/"+u,o=q.charCodeAt(0)===47)}return u=f(u,!o),o?u.length>0?"/"+u:"/":u.length>0?u:"."},normalize:function(u){if(t(u),u.length===0)return".";var o=u.charCodeAt(0)===47,$=u.charCodeAt(u.length-1)===47;return u=f(u,!o),u.length===0&&!o&&(u="."),u.length>0&&$&&(u+="/"),o?"/"+u:u},isAbsolute:function(u){return t(u),u.length>0&&u.charCodeAt(0)===47},join:function(){if(arguments.length===0)return".";for(var u,o=0;o<arguments.length;++o){var $=arguments[o];t($),$.length>0&&(u===void 0?u=$:u+="/"+$)}return u===void 0?".":H.normalize(u)},relative:function(u,o){if(t(u),t(o),u===o||(u=H.resolve(u),o=H.resolve(o),u===o))return"";for(var $=1;$<u.length&&u.charCodeAt($)===47;++$);for(var x=u.length,q=x-$,P=1;P<o.length&&o.charCodeAt(P)===47;++P);for(var C=o.length,I=C-P,v=q<I?q:I,j=-1,Q=0;Q<=v;++Q){if(Q===v){if(I>v){if(o.charCodeAt(P+Q)===47)return o.slice(P+Q+1);if(Q===0)return o.slice(P+Q)}else q>v&&(u.charCodeAt($+Q)===47?j=Q:Q===0&&(j=0));break}var X=u.charCodeAt($+Q),m=o.charCodeAt(P+Q);if(X!==m)break;X===47&&(j=Q)}var U="";for(Q=$+j+1;Q<=x;++Q)(Q===x||u.charCodeAt(Q)===47)&&(U.length===0?U+="..":U+="/..");return U.length>0?U+o.slice(P+j):(P+=j,o.charCodeAt(P)===47&&++P,o.slice(P))},_makeLong:function(u){return u},dirname:function(u){if(t(u),u.length===0)return".";for(var o=u.charCodeAt(0),$=o===47,x=-1,q=!0,P=u.length-1;P>=1;--P)if(o=u.charCodeAt(P),o===47){if(!q){x=P;break}}else q=!1;return x===-1?$?"/":".":$&&x===1?"//":u.slice(0,x)},basename:function(u,o){if(o!==void 0&&typeof o!="string")throw new TypeError('"ext" argument must be a string');t(u);var $=0,x=-1,q=!0,P;if(o!==void 0&&o.length>0&&o.length<=u.length){if(o.length===u.length&&o===u)return"";var C=o.length-1,I=-1;for(P=u.length-1;P>=0;--P){var v=u.charCodeAt(P);if(v===47){if(!q){$=P+1;break}}else I===-1&&(q=!1,I=P+1),C>=0&&(v===o.charCodeAt(C)?--C===-1&&(x=P):(C=-1,x=I))}return $===x?x=I:x===-1&&(x=u.length),u.slice($,x)}else{for(P=u.length-1;P>=0;--P)if(u.charCodeAt(P)===47){if(!q){$=P+1;break}}else x===-1&&(q=!1,x=P+1);return x===-1?"":u.slice($,x)}},extname:function(u){t(u);for(var o=-1,$=0,x=-1,q=!0,P=0,C=u.length-1;C>=0;--C){var I=u.charCodeAt(C);if(I===47){if(!q){$=C+1;break}continue}x===-1&&(q=!1,x=C+1),I===46?o===-1?o=C:P!==1&&(P=1):o!==-1&&(P=-1)}return o===-1||x===-1||P===0||P===1&&o===x-1&&o===$+1?"":u.slice(o,x)},format:function(u){if(u===null||typeof u!="object")throw new TypeError('The "pathObject" argument must be of type Object. Received type '+typeof u);return h("/",u)},parse:function(u){t(u);var o={root:"",dir:"",base:"",ext:"",name:""};if(u.length===0)return o;var $=u.charCodeAt(0),x=$===47,q;x?(o.root="/",q=1):q=0;for(var P=-1,C=0,I=-1,v=!0,j=u.length-1,Q=0;j>=q;--j){if($=u.charCodeAt(j),$===47){if(!v){C=j+1;break}continue}I===-1&&(v=!1,I=j+1),$===46?P===-1?P=j:Q!==1&&(Q=1):P!==-1&&(Q=-1)}return P===-1||I===-1||Q===0||Q===1&&P===I-1&&P===C+1?I!==-1&&(C===0&&x?o.base=o.name=u.slice(1,I):o.base=o.name=u.slice(C,I)):(C===0&&x?(o.name=u.slice(1,P),o.base=u.slice(1,I)):(o.name=u.slice(C,P),o.base=u.slice(C,I)),o.ext=u.slice(P,I)),C>0?o.dir=u.slice(0,C-1):x&&(o.dir="/"),o},sep:"/",delimiter:":",win32:null,posix:null};H.posix=H,c.exports=H}),Xn=Mc(Xc()),J=Xn,Zc=Xn;J.parse??=Zn;Zc.parse??=Zn;b={resolve:J.resolve.bind(J),normalize:J.normalize.bind(J),isAbsolute:J.isAbsolute.bind(J),join:J.join.bind(J),relative:J.relative.bind(J),toNamespacedPath:Jn,dirname:J.dirname.bind(J),basename:J.basename.bind(J),extname:J.extname.bind(J),format:J.format.bind(J),parse:J.parse.bind(J),sep:"/",delimiter:":",win32:void 0,posix:void 0,_makeLong:Jn},un={sep:"\\",delimiter:";",win32:void 0,...b,posix:b};b.win32=un.win32=un;b.posix=b;Uc=b,{resolve:Yc,normalize:Bc,isAbsolute:Dc,join:Lc,relative:Gc,toNamespacedPath:bc,dirname:Oc,basename:Kc,extname:zc,format:Nc,parse:Sc,sep:Vc,delimiter:Ac}=b});var rn=a(nn(),1);var l;function E(n){let c=l.__externref_table_alloc();return l.__wbindgen_externrefs.set(c,n),c}function O(n,c){return n=n>>>0,S().subarray(n/1,n/1+c)}function N(n,c){return n=n>>>0,oc(n,c)}var k=null;function S(){if(k===null||k.byteLength===0)k=new Uint8Array(l.memory.buffer);return k}function F(n,c){try{return n.apply(this,c)}catch(t){let f=E(t);l.__wbindgen_exn_store(f)}}function w(n){return n===void 0||n===null}function G(n,c){let t=c(n.length*1,1)>>>0;return S().set(n,t/1),M=n.length,t}function R(n,c,t){if(t===void 0){let o=y.encode(n),$=c(o.length,1)>>>0;return S().subarray($,$+o.length).set(o),M=o.length,$}let f=n.length,h=c(f,1)>>>0,H=S(),u=0;for(;u<f;u++){let o=n.charCodeAt(u);if(o>127)break;H[h+u]=o}if(u!==f){if(u!==0)n=n.slice(u);h=t(h,f,f=u+n.length*3,1)>>>0;let o=S().subarray(h+u,h+f),$=y.encodeInto(n,o);u+=$.written,h=t(h,f,u,1)>>>0}return M=u,h}function K(n){let c=l.__wbindgen_externrefs.get(n);return l.__externref_table_dealloc(n),c}var d=new TextDecoder("utf-8",{ignoreBOM:!0,fatal:!0});d.decode();var hc=2146435072,cn=0;function oc(n,c){if(cn+=c,cn>=hc)d=new TextDecoder("utf-8",{ignoreBOM:!0,fatal:!0}),d.decode(),cn=c;return d.decode(S().subarray(n,n+c))}var y=new TextEncoder;if(!("encodeInto"in y))y.encodeInto=function(n,c){let t=y.encode(n);return c.set(t),{read:n.length,written:t.length}};var M=0;function $n(n,c,t,f,h){let H,u;try{let x=R(n,l.__wbindgen_malloc,l.__wbindgen_realloc),q=M,P=G(c,l.__wbindgen_malloc),C=M,I=R(t,l.__wbindgen_malloc,l.__wbindgen_realloc),v=M,j=R(f,l.__wbindgen_malloc,l.__wbindgen_realloc),Q=M,X=R(h,l.__wbindgen_malloc,l.__wbindgen_realloc),m=M,U=l.build_l2_envelope_wasm(x,q,P,C,I,v,j,Q,X,m);var o=U[0],$=U[1];if(U[3])throw o=0,$=0,K(U[2]);return H=o,u=$,N(o,$)}finally{l.__wbindgen_free(H,u,1)}}function xn(n,c,t){let f,h;try{let x=R(n,l.__wbindgen_malloc,l.__wbindgen_realloc),q=M,P=G(c,l.__wbindgen_malloc),C=M;var H=w(t)?0:G(t,l.__wbindgen_malloc),u=M;let I=l.decrypt_l2_envelope_wasm(x,q,P,C,H,u);var o=I[0],$=I[1];if(I[3])throw o=0,$=0,K(I[2]);return f=o,h=$,N(o,$)}finally{l.__wbindgen_free(f,h,1)}}function Pn(){let n=l.ed25519_generate_keypair();if(n[3])throw K(n[2]);var c=O(n[0],n[1]).slice();return l.__wbindgen_free(n[0],n[1]*1,1),c}function qn(n){let c=G(n,l.__wbindgen_malloc),t=M,f=l.ed25519_public_key_to_x25519_public_key(c,t);if(f[3])throw K(f[2]);var h=O(f[0],f[1]).slice();return l.__wbindgen_free(f[0],f[1]*1,1),h}function In(n){return l.get_padding_target_size(n)>>>0}function tn(){let n,c;try{let t=l.get_version();return n=t[0],c=t[1],N(t[0],t[1])}finally{l.__wbindgen_free(n,c,1)}}function Cn(n,c,t,f){let h=G(n,l.__wbindgen_malloc),H=M,u=G(c,l.__wbindgen_malloc),o=M,$=G(t,l.__wbindgen_malloc),x=M,q=l.hkdf_sha256_wasm(h,H,u,o,$,x,f);if(q[3])throw K(q[2]);var P=O(q[0],q[1]).slice();return l.__wbindgen_free(q[0],q[1]*1,1),P}function ln(){let n=l.x25519_generate_keypair();if(n[3])throw K(n[2]);var c=O(n[0],n[1]).slice();return l.__wbindgen_free(n[0],n[1]*1,1),c}function vn(n){let c=G(n,l.__wbindgen_malloc),t=M,f=l.x25519_get_public_key(c,t);if(f[3])throw K(f[2]);var h=O(f[0],f[1]).slice();return l.__wbindgen_free(f[0],f[1]*1,1),h}var Hc=new Set(["basic","cors","default"]);async function $c(n,c){if(typeof Response==="function"&&n instanceof Response){if(typeof WebAssembly.instantiateStreaming==="function")try{return await WebAssembly.instantiateStreaming(n,c)}catch(f){if(n.ok&&Hc.has(n.type)&&n.headers.get("Content-Type")!=="application/wasm")console.warn("`WebAssembly.instantiateStreaming` failed because your server does not serve Wasm with `application/wasm` MIME type. Falling back to `WebAssembly.instantiate` which is slower. Original error:\n",f);else throw f}let t=await n.arrayBuffer();return await WebAssembly.instantiate(t,c)}else{let t=await WebAssembly.instantiate(n,c);if(t instanceof WebAssembly.Instance)return{instance:t,module:n};else return t}}function xc(){let n={};return n.wbg={},n.wbg.__wbg___wbindgen_is_function_8d400b8b1af978cd=function(c){return typeof c==="function"},n.wbg.__wbg___wbindgen_is_object_ce774f3490692386=function(c){let t=c;return typeof t==="object"&&t!==null},n.wbg.__wbg___wbindgen_is_string_704ef9c8fc131030=function(c){return typeof c==="string"},n.wbg.__wbg___wbindgen_is_undefined_f6b95eab589e0269=function(c){return c===void 0},n.wbg.__wbg___wbindgen_throw_dd24417ed36fc46e=function(c,t){throw new Error(N(c,t))},n.wbg.__wbg_call_3020136f7a2d6e44=function(){return F(function(c,t,f){return c.call(t,f)},arguments)},n.wbg.__wbg_call_abb4ff46ce38be40=function(){return F(function(c,t){return c.call(t)},arguments)},n.wbg.__wbg_crypto_574e78ad8b13b65f=function(c){return c.crypto},n.wbg.__wbg_getRandomValues_b8f5dbd5f3995a9e=function(){return F(function(c,t){c.getRandomValues(t)},arguments)},n.wbg.__wbg_length_22ac23eaec9d8053=function(c){return c.length},n.wbg.__wbg_msCrypto_a61aeb35a24c1329=function(c){return c.msCrypto},n.wbg.__wbg_new_no_args_cb138f77cf6151ee=function(c,t){return new Function(N(c,t))},n.wbg.__wbg_new_with_length_aa5eaf41d35235e5=function(c){return new Uint8Array(c>>>0)},n.wbg.__wbg_node_905d3e251edff8a2=function(c){return c.node},n.wbg.__wbg_process_dc0fbacc7c1c06f7=function(c){return c.process},n.wbg.__wbg_prototypesetcall_dfe9b766cdc1f1fd=function(c,t,f){Uint8Array.prototype.set.call(O(c,t),f)},n.wbg.__wbg_randomFillSync_ac0988aba3254290=function(){return F(function(c,t){c.randomFillSync(t)},arguments)},n.wbg.__wbg_require_60cc747a6bc5215a=function(){return F(function(){return qc.require},arguments)},n.wbg.__wbg_static_accessor_GLOBAL_769e6b65d6557335=function(){let c=typeof global==="undefined"?null:global;return w(c)?0:E(c)},n.wbg.__wbg_static_accessor_GLOBAL_THIS_60cf02db4de8e1c1=function(){let c=typeof globalThis==="undefined"?null:globalThis;return w(c)?0:E(c)},n.wbg.__wbg_static_accessor_SELF_08f5a74c69739274=function(){let c=typeof self==="undefined"?null:self;return w(c)?0:E(c)},n.wbg.__wbg_static_accessor_WINDOW_a8924b26aa92d024=function(){let c=typeof window==="undefined"?null:window;return w(c)?0:E(c)},n.wbg.__wbg_subarray_845f2f5bce7d061a=function(c,t,f){return c.subarray(t>>>0,f>>>0)},n.wbg.__wbg_versions_c01dfd4722a88165=function(c){return c.versions},n.wbg.__wbindgen_cast_2241b6af4c4b2941=function(c,t){return N(c,t)},n.wbg.__wbindgen_cast_cb9088102bce6b30=function(c,t){return O(c,t)},n.wbg.__wbindgen_init_externref_table=function(){let c=l.__wbindgen_externrefs,t=c.grow(4);c.set(0,void 0),c.set(t+0,void 0),c.set(t+1,null),c.set(t+2,!0),c.set(t+3,!1)},n}function Pc(n,c){return l=n.exports,Qn.__wbindgen_wasm_module=c,k=null,l.__wbindgen_start(),l}async function Qn(n){if(l!==void 0)return l;if(typeof n!=="undefined")if(Object.getPrototypeOf(n)===Object.prototype)({module_or_path:n}=n);else console.warn("using deprecated parameters for the initialization function; pass a single object instead");if(typeof n==="undefined")n=new URL("weba_crypto_wasm_bg.wasm",import.meta.url);let c=xc();if(typeof n==="string"||typeof Request==="function"&&n instanceof Request||typeof URL==="function"&&n instanceof URL)n=fetch(n);let{instance:t,module:f}=await $c(await n,c);return Pc(t,f)}var i=Qn;var jn="";var Z=!1;async function Y(n){if(Z)return;if(n)await i(n);else if(typeof window!=="undefined"&&window.__WEBA_MANIFEST){let t=window.__WEBA_MANIFEST.blobs?.find((f)=>f.id==="weba-crypto-wasm");if(t){let f=document.getElementById("weba-blob-"+t.digest.split(":")[1]);if(f){let h=atob(f.textContent.trim()),H=new Uint8Array(h.length);for(let u=0;u<h.length;u++)H[u]=h.charCodeAt(u);await i(H),Z=!0,console.log(`WASM Crypto Initialized from Manifest: ${tn()}`);return}}await W()}else if(typeof process!=="undefined"&&process.versions&&process.versions.node){let c=await import("node:fs"),f=(await Promise.resolve().then(() => (Yn(),Un))).join(import.meta.dirname,"wasm_bindings/weba_crypto_wasm_bg.wasm"),h=c.readFileSync(f);await i(h)}else try{await W()}catch(c){throw new Error("WASM source must be provided in browser environment")}if(Z=!0,!Z)console.log(`WASM Crypto Initialized: ${tn()}`)}async function W(){if(Z)return;let n=atob(jn),c=new Uint8Array(n.length);for(let t=0;t<n.length;t++)c[t]=n.charCodeAt(t);await Y(c)}function Bn(){if(!Z)throw new Error("WASM not initialized");let n=ln();return{privateKey:n.slice(0,32),publicKey:n.slice(32,64)}}function p(n){if(!Z)throw new Error("WASM not initialized");return vn(n)}function Dn(){if(!Z)throw new Error("WASM not initialized");let n=Pn();return{privateKey:n.slice(0,32),publicKey:n.slice(32,64)}}function B(n,c,t,f){if(!Z)throw new Error("WASM not initialized");return Cn(n,c||new Uint8Array(0),t,f)}function fn(n){if(!Z)throw new Error("WASM not initialized");return In(n)}function _(n,c,t,f,h){if(!Z)throw new Error("WASM not initialized");return $n(n,c,t,f,h)}function r(n,c,t){if(!Z)throw new Error("WASM not initialized");return xn(n,c,t)}function Ln(n){if(!Z)throw new Error("WASM not initialized");return qn(n)}var Kn=a(nn(),1);var Gn=typeof Buffer!=="undefined";function hn(n){if(Gn)return Buffer.from(n).toString("base64").replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/g,"");let c="";return n.forEach((t)=>{c+=String.fromCharCode(t)}),btoa(c).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/g,"")}function on(n){let t=(n.length%4===0?n:n+"=".repeat(4-n.length%4)).replace(/-/g,"+").replace(/_/g,"/");if(Gn)return Uint8Array.from(Buffer.from(t,"base64"));let f=atob(t),h=new Uint8Array(f.length);for(let H=0;H<f.length;H++)h[H]=f.charCodeAt(H);return h}function Fc(n){if(n.length===0)return new Uint8Array;let c=[0];for(let h of n){let H="123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz".indexOf(h);if(H<0)throw new Error(`Invalid base58 character: ${h}`);let u=H;for(let o=0;o<c.length;o++){let $=c[o]*58+u;c[o]=$&255,u=$>>8}while(u>0)c.push(u&255),u>>=8}let t=0;for(let h of n){if(h!=="1")break;t+=1}let f=new Uint8Array(t+c.length);for(let h=0;h<c.length;h++)f[f.length-1-h]=c[h];return f}function bn(n){if(!n.startsWith("z"))throw new Error(`Unsupported multibase prefix in ${n}`);return Fc(n.slice(1))}var Ec="0.1";function On(n){return hn(n)}function zn(n){return on(n)}function kc(n){let c=Kn.default(n);if(c===void 0)throw new Error("Failed to canonicalize JSON");return c}async function Nn(){return await Y(),Bn()}async function wc(){return await Y(),Dn()}async function Sn(n,c,t,f,h){await Y();let u=h?.userSk??(await wc()).privateKey,o=h?.meta?.created_at||new Date().toISOString(),$={enabled:!0,recipient_kid:f,recipient_x25519:On(c),recipient_pqc:h?.pqc?On(h.pqc.recipientPublicKey):void 0,layer1_ref:t,weba_version:Ec,campaign_id:h?.meta?.campaign_id},x=h?.userKid||(h?.userSk?"user#sig-custom":"user#sig-1"),q=_(kc(n.layer2_plain),u,x,JSON.stringify($),o);return JSON.parse(q)}class Vn{seenNonces=new Set;store;constructor(n){this.store=n}async checkAndMark(n){if(this.store){if(await this.store.has(n))return!1;return await this.store.add(n),!0}if(this.seenNonces.has(n))return!1;return this.seenNonces.add(n),!0}async reset(){if(this.store)await this.store.reset();this.seenNonces.clear()}}async function An(n,c,t){if(await Y(),n.layer2.enc!=="HPKE-v1")throw new Error(`Unsupported layer2.enc: ${n.layer2.enc}`);if(!t?.skipReplayCheck){let H=t?.replayGuard;if(!H)console.warn("SECURITY WARNING: No ReplayGuard provided to decryptLayer2. Using in-memory ephemeral store. Replays will only be detected within this process lifetime."),H=new Vn;if(!await H.checkAndMark(n.meta.nonce))throw new Error("Security Error: Replay detected (nonce used).")}let f=JSON.stringify(n),h=t?.pqc?.recipientPrivateKey;try{let H=r(f,c,h);return JSON.parse(H)}catch(H){let u=H instanceof Error?H.message:String(H);if(u.includes("Missing PQC KEM")||u.includes("AAD mismatch"))throw new Error(u);throw new Error("Decryption failed")}}function Rc(n){let c=0,t=0;for(let f=0;f<n.length;f++){let h=n[f];if(h===void 0)break;if(c|=(h&127)<<t,(h&128)===0)return{value:c,length:f+1};t+=7}throw new Error("Invalid varint encoding")}function yc(n){let{value:c,length:t}=Rc(n);return{code:c,data:n.slice(t)}}function Fn(n){let c=new Map;if(Array.isArray(n.verificationMethod))n.verificationMethod.forEach((t)=>{if(t?.id)c.set(t.id,t)});if(Array.isArray(n.assertionMethod))n.assertionMethod.forEach((t)=>{if(t&&typeof t==="object"&&"id"in t){let f=t;if(f.id)c.set(f.id,f)}});return c}function En(n){let t=n.split("#")[0]||"";if(!t.startsWith("did:key:"))throw new Error(`Unsupported DID method for did:key decoding: ${n}`);let f=t.slice(8),h=yc(bn(f));return{code:h.code,publicKey:h.data}}async function kn(n,c=fetch){if(n.startsWith("did:key:")){let u=n.slice(8);return{id:n,verificationMethod:[{id:`${n}#${u}`,type:"Multikey",controller:n,publicKeyMultibase:u}],assertionMethod:[`${n}#${u}`]}}if(!n.startsWith("did:web:"))return null;let t=n.split(":")[2];if(!t)return null;let f=n.split(":").slice(3),h=f.length>0?f.join("/"):".well-known",H=`https://${t}/${h}/did.json`;try{let u=await c(H);if(!u.ok)return null;return await u.json()}catch(u){return console.warn(`Failed to resolve DID ${n}:`,u),null}}async function Tc(n){if(n.startsWith("did:key:"))try{let{code:u,publicKey:o}=En(n);if(u===236)return{publicKey:o,kid:`${n}#${n.split(":").pop()}`};if(u===237)return{publicKey:Ln(o),kid:`${n}#${n.split(":").pop()}`};throw new Error(`Unsupported did:key type (multicodec: 0x${u.toString(16)})`)}catch(u){throw new Error(`Failed to resolve did:key: ${u.message||u}`)}let c=await kn(n,fetch);if(!c)throw new Error(`Failed to resolve DID: ${n}`);if(!c.keyAgreement||c.keyAgreement.length===0)throw new Error("No keyAgreement found in DID Document");let t=c.keyAgreement[0],f;if(typeof t==="string")f=t;else if(t&&typeof t==="object"&&"id"in t)f=t.id;else throw new Error("Invalid keyAgreement format in DID Document");let h=Fn(c),H=h.get(f);if(!H){let u=f.split("#").pop();if(u){for(let[o,$]of h.entries())if(o.endsWith(`#${u}`)){H=$;break}}}if(!H&&typeof t==="object"&&"publicKeyJwk"in t)H=t;if(!H)throw new Error(`KeyAgreement method not found: ${f}`);if(H.publicKeyJwk&&typeof H.publicKeyJwk==="object"){let u=H.publicKeyJwk;if(u.kty==="OKP"&&u.crv==="X25519"&&u.x)return{publicKey:zn(u.x),kid:H.id}}throw new Error("No X25519 encryption key found in DID Document")}async function wn(n,c,t){await Y(fetch("weba_crypto_wasm_bg.wasm"));let f=localStorage.getItem(`guest-did:${n}`);if(!f)throw new Error("Credential ID not found for DID");let H={layer2_plain:{type:"https://schema.org/Message",ext:{"com.example.rsvp":{attending:!0,count:1}},text:t,timestamp:new Date().toISOString()},layer2_sig:{alg:"none",kid:"guest-passkey",sig:"",created_at:new Date().toISOString()}};console.log("Resolving recipient...",c);let{publicKey:u,kid:o}=await Tc(c);console.log("Encrypting...",o);let $=await Sn(H,u,`ref:${Date.now()}`,o,{userSk:new Uint8Array(0),userKid:"guest-passkey"}),q=await(await fetch(g,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({query:"query GetChallenge($did: ID!) { getChallenge(did: $did) { nonce } }",variables:{did:n}})})).json();if(q.errors)throw new Error(q.errors[0].message);let P=q.data.getChallenge.nonce,C=T(P);console.log("Requesting Passkey signature...");let I=await navigator.credentials.get({publicKey:{challenge:C,allowCredentials:[{id:T(f),type:"public-key"}],userVerification:"required"}});if(!I)throw new Error("Authentication failed");let v=I.response,j=`
        mutation GuestPostMessage(
            $did: ID!, 
            $credentialId: String!, 
            $signature: String!, 
            $authenticatorData: String!, 
            $clientDataJSON: String!,
            $recipientDid: String!,
            $envelope: String!
        ) {
            guestPostMessage(
                did: $did, 
                credentialId: $credentialId, 
                signature: $signature, 
                authenticatorData: $authenticatorData, 
                clientDataJSON: $clientDataJSON,
                recipientDid: $recipientDid,
                envelope: $envelope
            ) {
                id
            }
        }
    `,X=await(await fetch(g,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({query:j,variables:{did:n,credentialId:f,signature:V(v.signature),authenticatorData:V(v.authenticatorData),clientDataJSON:V(v.clientDataJSON),recipientDid:c,envelope:JSON.stringify($)}})})).json();if(X.errors)throw new Error(X.errors[0].message);return console.log("Guest Message Sent!",X.data.guestPostMessage.id),X.data.guestPostMessage}var gc=typeof window!=="undefined"&&(window.location.hostname==="localhost"||window.location.hostname==="127.0.0.1"),g=gc?"http://127.0.0.1:5002/api":"/api",dc="SRN Guest Service";async function ic(){let n=localStorage.length;for(let c=0;c<n;c++){let t=localStorage.key(c);if(!t||!t.startsWith("guest-did:"))continue;if(t.endsWith(":privateKey"))continue;return t.replace("guest-did:","")}return null}async function Rn(n=!1){if(!window.PublicKeyCredential)throw new Error("Passkey not supported on this device");if(!n){let t=await ic();if(t)return console.log("Reusing existing Guest DID"),{did:t,isReused:!0}}return{did:await Wc(),isReused:!1}}async function Wc(){try{let f=function(P){let C="",I=new Uint8Array(P),v=I.length;for(let j=0;j<v;j++)C+=String.fromCharCode(I[j]);return btoa(C)};await Y(fetch("weba_crypto_wasm_bg.wasm"));let n=new Uint8Array(32);crypto.getRandomValues(n);let c=new Uint8Array(16);crypto.getRandomValues(c);let t=await navigator.credentials.create({publicKey:{challenge:n,rp:{name:dc,id:window.location.hostname},user:{id:c,name:"guest@srn.example",displayName:"SRN Guest User"},pubKeyCredParams:[{alg:-7,type:"public-key"}],authenticatorSelection:{authenticatorAttachment:"platform",userVerification:"required",residentKey:"required",requireResidentKey:!0},timeout:60000,attestation:"none"}});if(!t)throw new Error("Passkey creation cancelled");let h=await Nn(),H={kty:"OKP",crv:"X25519",x:yn(h.publicKey)},u=`
      mutation CreateGuestDid($credentialId: String!, $attestationObject: String!, $clientDataJSON: String!, $encryptionPublicKeyJwk: String!) {
        createGuestDid(credentialId: $credentialId, attestationObject: $attestationObject, clientDataJSON: $clientDataJSON, encryptionPublicKeyJwk: $encryptionPublicKeyJwk) {
          did
          expiresAt
        }
      }
    `,$=await(await fetch(g,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({query:u,variables:{credentialId:t.id,attestationObject:f(t.response.attestationObject),clientDataJSON:f(t.response.clientDataJSON),encryptionPublicKeyJwk:JSON.stringify(H)}})})).json();if($.errors)throw new Error(`GraphQL Error: ${$.errors[0].message}`);let{did:x,expiresAt:q}=$.data.createGuestDid;return localStorage.setItem(`guest-did:${x}`,t.id),localStorage.setItem(`guest-did:${x}:privateKey`,yn(h.privateKey)),console.log(`Guest DID created: ${x} (expires: ${q})`),x}catch(n){throw console.error("Failed to create Guest DID:",n),n}}async function pc(n){await Y(fetch("weba_crypto_wasm_bg.wasm"));let c=localStorage.getItem(`guest-did:${n}`);if(!c)throw new Error("Credential ID not found for DID");let f=await(await fetch(g,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({query:"query GetChallenge($did: ID!) { getChallenge(did: $did) { nonce } }",variables:{did:n}})})).json();if(f.errors)throw new Error(f.errors[0].message);let h=f.data.getChallenge.nonce,H=T(h),u=await navigator.credentials.get({publicKey:{challenge:H,allowCredentials:[{id:T(c),type:"public-key"}],userVerification:"required"}});if(!u)throw new Error("Authentication failed");let o=u.response,$=`
        query GuestInbox($did: ID!, $credentialId: String!, $signature: String!, $authenticatorData: String!, $clientDataJSON: String!) {
            guestInbox(did: $did, credentialId: $credentialId, signature: $signature, authenticatorData: $authenticatorData, clientDataJSON: $clientDataJSON) {
                id
                senderDid
                recipientDid
                envelope
                createdAt
            }
        }
    `,q=await(await fetch(g,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({query:$,variables:{did:n,credentialId:c,signature:V(o.signature),authenticatorData:V(o.authenticatorData),clientDataJSON:V(o.clientDataJSON)}})})).json();if(q.errors)throw new Error(q.errors[0].message);let P=q.data.guestInbox,C=localStorage.getItem(`guest-did:${n}:privateKey`);if(C){let I=new Uint8Array(T(C));for(let v of P)if(v.envelope)try{let j=JSON.parse(v.envelope),Q=await An(j,I);if(Q.layer2_plain)v.content=Q.layer2_plain;else v.content=Q;delete v.envelope}catch(j){console.error("Failed to decrypt:",j),v.content={text:"[Decryption Failed: "+j.message+"]"}}}return P}function T(n){let c="=".repeat((4-n.length%4)%4),t=(n+c).replace(/-/g,"+").replace(/_/g,"/"),f=window.atob(t),h=new Uint8Array(f.length);for(let H=0;H<f.length;++H)h[H]=f.charCodeAt(H);return h.buffer}function V(n){let c="",t=new Uint8Array(n),f=t.length;for(let h=0;h<f;h++)c+=String.fromCharCode(t[h]);return window.btoa(c)}function yn(n){let c="",t=n.length;for(let f=0;f<t;f++)c+=String.fromCharCode(n[f]);return btoa(c).replace(/\+/g,"-").replace(/\//g,"_").replace(/=/g,"")}if(typeof window!=="undefined")window.getOrCreateGuestDid=Rn,window.fetchGuestInbox=pc,window.sendGuestMessage=wn,window.submitFormWithGuestDid=async(n,c,t)=>{let{did:f,isReused:h}=await Rn(!1),H=JSON.stringify(n);return await wn(f,t||"did:web:srn.example",H),{senderDid:f}},window.clearAllGuestDids=()=>{let n=Object.keys(localStorage);for(let c of n)if(c.startsWith("guest-did:"))localStorage.removeItem(c)};var _c=(n)=>{let c=n.replace(/-/g,"+").replace(/_/g,"/");while(c.length%4)c+="=";let t=atob(c),f=new Uint8Array(t.length);for(let h=0;h<t.length;h++)f[h]=t.charCodeAt(h);return f.buffer};async function s(n,c){let t=crypto.getRandomValues(new Uint8Array(32)),f=await navigator.credentials.get({publicKey:{challenge:t,allowCredentials:[{id:_c(n),type:"public-key"}],userVerification:"required",extensions:{prf:{eval:{first:c}}}}});if(!f)throw new Error("Assertion failed");let H=f.getClientExtensionResults()?.prf?.results?.first;if(!H)throw new Error("PRF extension not available");return new Uint8Array(H)}function Tn(n){let c=document.getElementById(n);if(!c||!c.textContent)return null;try{return JSON.parse(c.textContent)}catch{return null}}function gn(){let n=Tn("weba-l2-envelope");if(!n)return;let c=Tn("weba-l2-keywrap"),t=document.querySelector(".weba-form-container")||document.body,f=document.createElement("div");f.className="weba-l2-unlock",f.style.cssText="margin-top:2rem;padding:1rem;border:1px solid #cbd5f5;border-radius:10px;background:#f8fafc;";let h=document.createElement("div");h.textContent="Encrypted Submission",h.style.cssText="font-weight:600;color:#334155;margin-bottom:0.5rem;",f.appendChild(h);let H=document.createElement("div");H.textContent="Locked. Unlock with Passkey.",H.style.cssText="color:#64748b;margin-bottom:0.75rem;",f.appendChild(H);let u=document.createElement("button");u.textContent="Unlock (Passkey)",u.style.cssText="padding:0.5rem 1rem;border:1px solid #94a3b8;border-radius:6px;background:#fff;cursor:pointer;",f.appendChild(u);let o=document.createElement("pre");o.style.cssText="margin-top:1rem;padding:1rem;background:#0f172a;color:#e2e8f0;border-radius:8px;overflow:auto;font-size:0.85rem;display:none;",f.appendChild(o);let $=document.createElement("details");$.style.cssText="margin-top:0.75rem; display:none;",$.innerHTML='<summary style="cursor:pointer;color:#64748b;">Show signature</summary><pre style="margin-top:0.5rem;padding:0.75rem;background:#0b1220;color:#cbd5f5;border-radius:6px;overflow:auto;font-size:0.8rem;"></pre>',f.appendChild($);let x=document.createElement("button");x.textContent="Export JSON",x.style.cssText="margin-top:0.75rem;padding:0.45rem 0.9rem;border:1px solid #94a3b8;border-radius:6px;background:#fff;cursor:pointer;display:none;",x.disabled=!0,f.appendChild(x),u.addEventListener("click",async()=>{if(!c){H.textContent="Key wrap package not found.";return}u.disabled=!0,H.textContent="Waiting for passkey...";try{let q=L(c.prf_salt),P=await s(c.credential_id,q),C=await Wn({keywrap:c,prfKey:P}),I=await dn(n,C,{skipReplayCheck:!0});rc(I.layer2_plain),document.body.classList.add("weba-l2-readonly"),o.textContent=JSON.stringify(I.layer2_plain,null,2),o.style.display="block";let v=$.querySelector("pre");if(v)v.textContent=JSON.stringify(I.layer2_sig,null,2);$.style.display="block",x.style.display="inline-block",x.disabled=!1,H.textContent="Unlocked.",x.onclick=()=>{let j=new Blob([JSON.stringify(I,null,2)],{type:"application/json"}),Q=URL.createObjectURL(j),X=document.createElement("a");X.href=Q,X.download="weba-l2-decrypted.json",X.click()}}catch(q){console.error(q),H.textContent="Unlock failed.",u.disabled=!1}}),t.appendChild(f)}function rc(n){if(!n||typeof n!=="object")return;let c=n;document.querySelectorAll("[data-json-path]").forEach((t)=>{let f=t.dataset.jsonPath;if(!f||!(f in c))return;let h=c[f];if(t.type==="checkbox")t.checked=Boolean(h);else if(t.type==="radio")t.checked=t.value===String(h);else t.value=h===null||h===void 0?"":String(h)}),document.querySelectorAll('input[type="radio"]').forEach((t)=>{let f=t.name;if(!f||!(f in c))return;let h=c[f];t.checked=t.value===String(h)}),document.querySelectorAll("table.data-table.dynamic").forEach((t)=>{let f=t.dataset.tableKey;if(!f)return;let h=c[f];if(!Array.isArray(h))return;let H=t.querySelector("tbody");if(!H)return;let u=H.querySelector("tr.template-row");if(!u)return;Array.from(H.querySelectorAll("tr")).forEach((o)=>{if(!o.classList.contains("template-row"))o.remove()}),h.forEach((o,$)=>{let x=$===0?u:u.cloneNode(!0);if($>0){x.classList.remove("template-row");let q=x.querySelector(".remove-row-btn");if(q)q.style.visibility="visible";H.appendChild(x)}if(o&&typeof o==="object")x.querySelectorAll("input, select, textarea").forEach((q)=>{let P=q.dataset.baseKey;if(!P)return;let C=o[P];if(q.type==="checkbox")q.checked=Boolean(C);else q.value=C===null||C===void 0?"":String(C)})})}),document.querySelectorAll("input").forEach((t)=>{if(t.type==="checkbox"||t.type==="radio")t.disabled=!0;else t.readOnly=!0}),document.querySelectorAll("textarea").forEach((t)=>{t.readOnly=!0}),document.querySelectorAll("select").forEach((t)=>{t.disabled=!0}),document.querySelectorAll(".form-toolbar button, .add-row-btn, .remove-row-btn").forEach((t)=>{t.disabled=!0})}function D(n){return document.getElementById(n)}function pn(){if(!D("weba-l2-keywrap-tool"))return;let c=D("kwp-recipient-sk"),t=D("kwp-credential-id"),f=D("kwp-prf-salt"),h=D("kwp-aad"),H=D("kwp-kid"),u=D("kwp-status"),o=D("kwp-output"),$=D("kwp-generate-salt"),x=D("kwp-wrap");if(!c||!t||!f||!u||!o||!x)return;$?.addEventListener("click",()=>{let q=new Uint8Array(32);crypto.getRandomValues(q),f.value=A(q)}),x.addEventListener("click",async()=>{u.textContent="Waiting for passkey...",x.disabled=!0;try{if(!c.value||!t.value||!f.value)throw new Error("Missing required fields.");let q=L(c.value.trim()),P=L(f.value.trim()),C=await s(t.value.trim(),P),I=h?.value?L(h.value.trim()):void 0,v=await _n({recipientSk:q,prfKey:C,aad:I}),j={alg:"WebAuthn-PRF-AESGCM-v1",kid:H?.value||"issuer#passkey-1",credential_id:t.value.trim(),prf_salt:A(P),wrapped_key:A(v),...I?{aad:A(I)}:{}};o.textContent=JSON.stringify(j,null,2),u.textContent="Key wrap ready."}catch(q){console.error(q),u.textContent="Key wrap failed."}finally{x.disabled=!1}})}if(typeof window!=="undefined")window.initL2Viewer=gn,window.initKeywrapTool=pn;class sc{key;nonces;constructor(n="weba_l2_nonces"){this.key=n,this.nonces=new Set,this.load()}load(){let n=localStorage.getItem(this.key);if(n)try{let c=JSON.parse(n);if(Array.isArray(c))this.nonces=new Set(c)}catch(c){console.error("Failed to load replay store from localStorage",c)}}save(){try{localStorage.setItem(this.key,JSON.stringify(Array.from(this.nonces)))}catch(n){console.error("Failed to save replay store to localStorage",n)}}async has(n){return this.nonces.has(n)}async add(n){this.nonces.add(n),this.save()}async reset(){this.nonces.clear(),this.save()}}async function c0(n){return await z(),fn(n)}function mc(){let n=localStorage.getItem("weba_l2_ed25519_sk");if(n)return L(n);let c=new Uint8Array(32);return crypto.getRandomValues(c),localStorage.setItem("weba_l2_ed25519_sk",A(c)),c}function A(n){if(typeof Buffer!=="undefined")return Buffer.from(n).toString("base64").replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/g,"");let c="";return n.forEach((f)=>{c+=String.fromCharCode(f)}),btoa(c).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/g,"")}function L(n){let c=n.length%4===0?"":"=".repeat(4-n.length%4),t=n.replace(/-/g,"+").replace(/_/g,"/")+c;if(typeof Buffer!=="undefined")return new Uint8Array(Buffer.from(t,"base64"));let f=atob(t),h=new Uint8Array(f.length);for(let H=0;H<f.length;H+=1)h[H]=f.charCodeAt(H);return h}function ec(n){let c=rn.default(n);if(c===void 0)throw new Error("Failed to canonicalize JSON");return c}async function z(){await W()}async function t0(n){await z();let c=n.keyPolicy??"campaign+layer1";if(c==="campaign+layer1"&&!n.layer1Ref)throw new Error("layer1_ref is required for campaign+layer1 policy");let t=JSON.stringify({domain:"weba-l2/org-x25519",campaign_id:n.campaignId,key_policy:c,layer1_ref:c==="campaign+layer1"?n.layer1Ref:void 0}),f=new TextEncoder().encode(t),h=B(n.orgRootKey,void 0,f,32);return{publicKey:p(h),privateKey:h,keyPolicy:c}}async function u0(n){await z();let c=new TextEncoder().encode("weba-l2/user-x25519"),t=B(n,void 0,c,32);return{publicKey:p(t),privateKey:t}}async function ac(n,c,t,f){let h=await crypto.subtle.importKey("raw",c,"AES-GCM",!1,["encrypt"]),H=await crypto.subtle.encrypt({name:"AES-GCM",iv:t,additionalData:f},h,n);return new Uint8Array(H)}async function _n(n){await z();let c=B(n.prfKey,void 0,new TextEncoder().encode("weba-l2/prk"),32),t=B(c,void 0,new TextEncoder().encode("weba-l2/kw"),32),f=B(c,void 0,new TextEncoder().encode("weba-l2/kw-iv"),12),h=n.aad??new Uint8Array;return ac(n.recipientSk,t,f,h)}async function nt(n,c,t,f){let h=await crypto.subtle.importKey("raw",c,"AES-GCM",!1,["decrypt"]),H=await crypto.subtle.decrypt({name:"AES-GCM",iv:t,additionalData:f},h,n);return new Uint8Array(H)}async function f0(n){await z();let c=n.user_sk||mc(),t=new Date().toISOString(),f=n.user_kid||"user#sig-1",h={...n.config,recipient_pqc:n.config.recipient_pqc||void 0},H=_(ec(n.layer2_plain),c,f,JSON.stringify(h),t);return JSON.parse(H)}function h0(){let n=document.getElementById("weba-l2-config");if(!n||!n.textContent)return null;try{return JSON.parse(n.textContent)}catch{return null}}class sn{seenNonces=new Set;store;constructor(n){this.store=n}async checkAndMark(n){if(this.store){if(await this.store.has(n))return!1;return await this.store.add(n),!0}if(this.seenNonces.has(n))return!1;return this.seenNonces.add(n),!0}async reset(){if(this.store)await this.store.reset();this.seenNonces.clear()}}async function dn(n,c,t){if(await z(),n.layer2.enc!=="HPKE-v1")throw new Error(`Unsupported layer2.enc: ${n.layer2.enc}`);if(!t?.skipReplayCheck){let H=t?.replayGuard;if(!H)console.warn("SECURITY WARNING: No ReplayGuard provided to decryptLayer2Envelope. Using in-memory ephemeral store. Replays will only be detected within this page session."),H=new sn;if(!await H.checkAndMark(n.meta.nonce))throw new Error("Security Error: Replay detected (nonce used).")}let f=JSON.stringify(n),h=t?.pqcRecipientSk;try{let H=r(f,c,h);return JSON.parse(H)}catch(H){let u=H instanceof Error?H.message:String(H);if(u.includes("Missing PQC KEM")||u.includes("AAD mismatch"))throw new Error(u);throw new Error("Decryption failed")}}async function o0(n){try{let c=await fetch(n);if(!c.ok)throw new Error(`Pre-key fetch failed: ${c.status}`);return await c.json()}catch(c){return console.error("Failed to fetch pre-key",c),null}}async function H0(n){try{let c=await fetch(n);if(!c.ok)return null;return await c.json()}catch(c){return console.warn("Failed to fetch epoch registry:",c),null}}function $0(n){let c=new Date;return n.keys.find((f)=>{let h=new Date(f.validFrom),H=new Date(f.validUntil);return c>=h&&c<=H})||null}async function Wn(n){await z();let c=B(n.prfKey,void 0,new TextEncoder().encode("weba-l2/prk"),32),t=B(c,void 0,new TextEncoder().encode("weba-l2/kw"),32),f=B(c,void 0,new TextEncoder().encode("weba-l2/kw-iv"),12),h=n.keywrap.aad?L(n.keywrap.aad):new Uint8Array,H=L(n.keywrap.wrapped_key);return nt(H,t,f,h)}export{_n as wrapRecipientPrivateKey,Wn as unwrapRecipientPrivateKey,$0 as selectEpochKey,h0 as loadL2Config,c0 as getPaddingTargetSize,o0 as fetchPreKey,H0 as fetchEpochRegistry,t0 as deriveOrgX25519KeyPair,u0 as deriveKeyPairFromPrf,dn as decryptLayer2Envelope,f0 as buildLayer2Envelope,A as b64urlEncode,L as b64urlDecode,sn as ReplayGuard,sc as LocalStorageReplayStore};
