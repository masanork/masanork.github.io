var a$=Object.create;var{getPrototypeOf:t$,defineProperty:W8,getOwnPropertyNames:r$}=Object;var e$=Object.prototype.hasOwnProperty;var H8=($,H,Q)=>{Q=$!=null?a$(t$($)):{};let X=H||!$||!$.__esModule?W8(Q,"default",{value:$,enumerable:!0}):Q;for(let q of r$($))if(!e$.call(X,q))W8(X,q,{get:()=>$[q],enumerable:!0});return X};var $H=($,H)=>()=>(H||$((H={exports:{}}).exports,H),H.exports);var Q8=($,H)=>{for(var Q in H)W8($,Q,{get:H[Q],enumerable:!0,configurable:!0,set:(X)=>H[Q]=()=>X})};var J0=($,H)=>()=>($&&(H=$($=0)),H);var HH=(($)=>typeof require!=="undefined"?require:typeof Proxy!=="undefined"?new Proxy($,{get:(H,Q)=>(typeof require!=="undefined"?require:H)[Q]}):$)(function($){if(typeof require!=="undefined")return require.apply(this,arguments);throw Error('Dynamic require of "'+$+'" is not supported')});var X8=$H((qX,C4)=>{C4.exports=function $(H){if(typeof H==="number"&&isNaN(H))throw new Error("NaN is not allowed");if(typeof H==="number"&&!isFinite(H))throw new Error("Infinity is not allowed");if(H===null||typeof H!=="object")return JSON.stringify(H);if(H.toJSON instanceof Function)return $(H.toJSON());if(Array.isArray(H))return`[${H.reduce((q,Z,Y)=>{return`${q}${Y===0?"":","}${$(Z===void 0||typeof Z==="symbol"?null:Z)}`},"")}]`;return`{${Object.keys(H).sort().reduce((X,q)=>{if(H[q]===void 0||typeof H[q]==="symbol")return X;let Z=X.length===0?"":",";return`${X}${Z}${$(q)}:${$(H[q])}`},"")}}`}});async function S4($){let H=crypto.getRandomValues(new Uint8Array(32)),X=new TextEncoder().encode($),q=await crypto.subtle.digest("SHA-256",X),Z=new Uint8Array(q).slice(0,16),Y=await navigator.credentials.create({publicKey:{challenge:H,rp:{name:"Sorane Web/A Form"},user:{id:Z,name:$,displayName:$},pubKeyCredParams:[{alg:-7,type:"public-key"}],authenticatorSelection:{authenticatorAttachment:"platform",userVerification:"required",residentKey:"required"},timeout:60000,attestation:"none",extensions:{prf:{}}}});if(!Y)throw new Error("Credential creation failed");return{id:Y.id,rawId:O8(Y.rawId),response:Y.response}}async function v4($,H){let Q=await navigator.credentials.get({publicKey:{challenge:H,allowCredentials:[{id:f4($),type:"public-key"}],userVerification:"required"}});if(!Q)throw new Error("Assertion failed");let X=Q.response;return{id:Q.id,signature:O8(X.signature),authenticatorData:O8(X.authenticatorData),clientDataJSON:O8(X.clientDataJSON)}}async function I0($,H){let Q=crypto.getRandomValues(new Uint8Array(32)),X=await navigator.credentials.get({publicKey:{challenge:Q,allowCredentials:[{id:f4($),type:"public-key"}],userVerification:"required",extensions:{prf:{eval:{first:H}}}}});if(!X)throw new Error("Assertion failed");let Z=X.getClientExtensionResults()?.prf?.results?.first;if(!Z)throw new Error("PRF extension not available");return new Uint8Array(Z)}var O8=($)=>{let H=new Uint8Array($);return btoa(String.fromCharCode(...H)).replace(/\+/g,"-").replace(/\//g,"_").replace(/=/g,"")},f4=($)=>{let H=$.replace(/-/g,"+").replace(/_/g,"/");while(H.length%4)H+="=";let Q=atob(H),X=new Uint8Array(Q.length);for(let q=0;q<Q.length;q++)X[q]=Q.charCodeAt(q);return X.buffer};function p0($){let H=D.__externref_table_alloc();return D.__wbindgen_externrefs.set(H,$),H}function e($,H){return $=$>>>0,T0().subarray($/1,$/1+H)}function w0($,H){return $=$>>>0,VH($,H)}function T0(){if(u0===null||u0.byteLength===0)u0=new Uint8Array(D.memory.buffer);return u0}function c0($,H){try{return $.apply(this,H)}catch(Q){let X=p0(Q);D.__wbindgen_exn_store(X)}}function l0($){return $===void 0||$===null}function k($,H){let Q=H($.length*1,1)>>>0;return T0().set($,Q/1),_=$.length,Q}function d0($,H,Q){if(Q===void 0){let U=o0.encode($),G=H(U.length,1)>>>0;return T0().subarray(G,G+U.length).set(U),_=U.length,G}let X=$.length,q=H(X,1)>>>0,Z=T0(),Y=0;for(;Y<X;Y++){let U=$.charCodeAt(Y);if(U>127)break;Z[q+Y]=U}if(Y!==X){if(Y!==0)$=$.slice(Y);q=Q(q,X,X=Y+$.length*3,1)>>>0;let U=T0().subarray(q+Y,q+X),G=o0.encodeInto($,U);Y+=G.written,q=Q(q,X,Y,1)>>>0}return _=Y,q}function s($){let H=D.__wbindgen_externrefs.get($);return D.__externref_table_dealloc($),H}function VH($,H){if(l8+=H,l8>=EH)K8=new TextDecoder("utf-8",{ignoreBOM:!0,fatal:!0}),K8.decode(),l8=H;return K8.decode(T0().subarray($,$+H))}function h4($,H,Q,X){let q=k($,D.__wbindgen_malloc),Z=_,Y=k(H,D.__wbindgen_malloc),U=_,G=k(Q,D.__wbindgen_malloc),L=_,J=k(X,D.__wbindgen_malloc),N=_,M=D.aes_gcm_decrypt(q,Z,Y,U,G,L,J,N);if(M[3])throw s(M[2]);var K=e(M[0],M[1]).slice();return D.__wbindgen_free(M[0],M[1]*1,1),K}function k4($,H,Q,X){let q=k($,D.__wbindgen_malloc),Z=_,Y=k(H,D.__wbindgen_malloc),U=_,G=k(Q,D.__wbindgen_malloc),L=_,J=k(X,D.__wbindgen_malloc),N=_,M=D.aes_gcm_encrypt(q,Z,Y,U,G,L,J,N);if(M[3])throw s(M[2]);var K=e(M[0],M[1]).slice();return D.__wbindgen_free(M[0],M[1]*1,1),K}function b4($,H,Q,X,q){let Z,Y;try{let L=d0($,D.__wbindgen_malloc,D.__wbindgen_realloc),J=_,N=k(H,D.__wbindgen_malloc),M=_,K=d0(Q,D.__wbindgen_malloc,D.__wbindgen_realloc),R=_,x=d0(X,D.__wbindgen_malloc,D.__wbindgen_realloc),j=_,g=d0(q,D.__wbindgen_malloc,D.__wbindgen_realloc),u=_,F=D.build_l2_envelope_wasm(L,J,N,M,K,R,x,j,g,u);var U=F[0],G=F[1];if(F[3])throw U=0,G=0,s(F[2]);return Z=U,Y=G,w0(U,G)}finally{D.__wbindgen_free(Z,Y,1)}}function y4($,H){let Q=k($,D.__wbindgen_malloc),X=_,q=k(H,D.__wbindgen_malloc),Z=_;return D.constant_time_equal(Q,X,q,Z)!==0}function m4($,H,Q){let X,q;try{let L=d0($,D.__wbindgen_malloc,D.__wbindgen_realloc),J=_,N=k(H,D.__wbindgen_malloc),M=_;var Z=l0(Q)?0:k(Q,D.__wbindgen_malloc),Y=_;let K=D.decrypt_l2_envelope_wasm(L,J,N,M,Z,Y);var U=K[0],G=K[1];if(K[3])throw U=0,G=0,s(K[2]);return X=U,q=G,w0(U,G)}finally{D.__wbindgen_free(X,q,1)}}function g4(){let $=D.ed25519_generate_keypair();if($[3])throw s($[2]);var H=e($[0],$[1]).slice();return D.__wbindgen_free($[0],$[1]*1,1),H}function c4($){let H=k($,D.__wbindgen_malloc),Q=_,X=D.ed25519_public_key_to_x25519_public_key(H,Q);if(X[3])throw s(X[2]);var q=e(X[0],X[1]).slice();return D.__wbindgen_free(X[0],X[1]*1,1),q}function p4($,H){let Q=k($,D.__wbindgen_malloc),X=_,q=k(H,D.__wbindgen_malloc),Z=_,Y=D.ed25519_sign(Q,X,q,Z);if(Y[3])throw s(Y[2]);var U=e(Y[0],Y[1]).slice();return D.__wbindgen_free(Y[0],Y[1]*1,1),U}function u4($,H,Q){let X=k($,D.__wbindgen_malloc),q=_,Z=k(H,D.__wbindgen_malloc),Y=_,U=k(Q,D.__wbindgen_malloc),G=_,L=D.ed25519_verify(X,q,Z,Y,U,G);if(L[2])throw s(L[1]);return L[0]!==0}function l4($){return D.get_padding_target_size($)>>>0}function d8(){let $,H;try{let Q=D.get_version();return $=Q[0],H=Q[1],w0(Q[0],Q[1])}finally{D.__wbindgen_free($,H,1)}}function d4($,H,Q,X){let q=k($,D.__wbindgen_malloc),Z=_,Y=k(H,D.__wbindgen_malloc),U=_,G=k(Q,D.__wbindgen_malloc),L=_,J=D.hkdf_sha256_wasm(q,Z,Y,U,G,L,X);if(J[3])throw s(J[2]);var N=e(J[0],J[1]).slice();return D.__wbindgen_free(J[0],J[1]*1,1),N}function o4(){let $=D.ml_dsa_44_generate_keypair();if($[3])throw s($[2]);var H=e($[0],$[1]).slice();return D.__wbindgen_free($[0],$[1]*1,1),H}function n4($,H){let Q=k($,D.__wbindgen_malloc),X=_,q=k(H,D.__wbindgen_malloc),Z=_,Y=D.ml_dsa_44_sign(Q,X,q,Z);if(Y[3])throw s(Y[2]);var U=e(Y[0],Y[1]).slice();return D.__wbindgen_free(Y[0],Y[1]*1,1),U}function s4($,H,Q){let X=k($,D.__wbindgen_malloc),q=_,Z=k(H,D.__wbindgen_malloc),Y=_,U=k(Q,D.__wbindgen_malloc),G=_,L=D.ml_dsa_44_verify(X,q,Z,Y,U,G);if(L[2])throw s(L[1]);return L[0]!==0}function i4($,H){let Q=k($,D.__wbindgen_malloc),X=_,q=k(H,D.__wbindgen_malloc),Z=_,Y=D.ml_kem_768_decapsulate(Q,X,q,Z);if(Y[3])throw s(Y[2]);var U=e(Y[0],Y[1]).slice();return D.__wbindgen_free(Y[0],Y[1]*1,1),U}function a4($){let H=k($,D.__wbindgen_malloc),Q=_,X=D.ml_kem_768_encapsulate(H,Q);if(X[3])throw s(X[2]);var q=e(X[0],X[1]).slice();return D.__wbindgen_free(X[0],X[1]*1,1),q}function t4(){let $=D.ml_kem_768_generate_keypair();if($[3])throw s($[2]);var H=e($[0],$[1]).slice();return D.__wbindgen_free($[0],$[1]*1,1),H}function r4(){let $=D.p256_generate_keypair();if($[3])throw s($[2]);var H=e($[0],$[1]).slice();return D.__wbindgen_free($[0],$[1]*1,1),H}function e4($,H){let Q=k($,D.__wbindgen_malloc),X=_,q=k(H,D.__wbindgen_malloc),Z=_,Y=D.p256_sign(Q,X,q,Z);if(Y[3])throw s(Y[2]);var U=e(Y[0],Y[1]).slice();return D.__wbindgen_free(Y[0],Y[1]*1,1),U}function $$($,H,Q){let X=k($,D.__wbindgen_malloc),q=_,Z=k(H,D.__wbindgen_malloc),Y=_,U=k(Q,D.__wbindgen_malloc),G=_,L=D.p256_verify(X,q,Z,Y,U,G);if(L[2])throw s(L[1]);return L[0]!==0}function H$($){let H=k($,D.__wbindgen_malloc),Q=_,X=D.sha256_wasm(H,Q);var q=e(X[0],X[1]).slice();return D.__wbindgen_free(X[0],X[1]*1,1),q}function Q$(){let $=D.x25519_generate_keypair();if($[3])throw s($[2]);var H=e($[0],$[1]).slice();return D.__wbindgen_free($[0],$[1]*1,1),H}function X$($){let H=k($,D.__wbindgen_malloc),Q=_,X=D.x25519_get_public_key(H,Q);if(X[3])throw s(X[2]);var q=e(X[0],X[1]).slice();return D.__wbindgen_free(X[0],X[1]*1,1),q}function q$($,H){let Q=k($,D.__wbindgen_malloc),X=_,q=k(H,D.__wbindgen_malloc),Z=_,Y=D.x25519_get_shared_secret(Q,X,q,Z);if(Y[3])throw s(Y[2]);var U=e(Y[0],Y[1]).slice();return D.__wbindgen_free(Y[0],Y[1]*1,1),U}async function IH($,H){if(typeof Response==="function"&&$ instanceof Response){if(typeof WebAssembly.instantiateStreaming==="function")try{return await WebAssembly.instantiateStreaming($,H)}catch(X){if($.ok&&jH.has($.type)&&$.headers.get("Content-Type")!=="application/wasm")console.warn("`WebAssembly.instantiateStreaming` failed because your server does not serve Wasm with `application/wasm` MIME type. Falling back to `WebAssembly.instantiate` which is slower. Original error:\n",X);else throw X}let Q=await $.arrayBuffer();return await WebAssembly.instantiate(Q,H)}else{let Q=await WebAssembly.instantiate($,H);if(Q instanceof WebAssembly.Instance)return{instance:Q,module:$};else return Q}}function wH(){let $={};return $.wbg={},$.wbg.__wbg___wbindgen_is_function_8d400b8b1af978cd=function(H){return typeof H==="function"},$.wbg.__wbg___wbindgen_is_object_ce774f3490692386=function(H){let Q=H;return typeof Q==="object"&&Q!==null},$.wbg.__wbg___wbindgen_is_string_704ef9c8fc131030=function(H){return typeof H==="string"},$.wbg.__wbg___wbindgen_is_undefined_f6b95eab589e0269=function(H){return H===void 0},$.wbg.__wbg___wbindgen_throw_dd24417ed36fc46e=function(H,Q){throw new Error(w0(H,Q))},$.wbg.__wbg_call_3020136f7a2d6e44=function(){return c0(function(H,Q,X){return H.call(Q,X)},arguments)},$.wbg.__wbg_call_abb4ff46ce38be40=function(){return c0(function(H,Q){return H.call(Q)},arguments)},$.wbg.__wbg_crypto_574e78ad8b13b65f=function(H){return H.crypto},$.wbg.__wbg_getRandomValues_b8f5dbd5f3995a9e=function(){return c0(function(H,Q){H.getRandomValues(Q)},arguments)},$.wbg.__wbg_length_22ac23eaec9d8053=function(H){return H.length},$.wbg.__wbg_msCrypto_a61aeb35a24c1329=function(H){return H.msCrypto},$.wbg.__wbg_new_no_args_cb138f77cf6151ee=function(H,Q){return new Function(w0(H,Q))},$.wbg.__wbg_new_with_length_aa5eaf41d35235e5=function(H){return new Uint8Array(H>>>0)},$.wbg.__wbg_node_905d3e251edff8a2=function(H){return H.node},$.wbg.__wbg_process_dc0fbacc7c1c06f7=function(H){return H.process},$.wbg.__wbg_prototypesetcall_dfe9b766cdc1f1fd=function(H,Q,X){Uint8Array.prototype.set.call(e(H,Q),X)},$.wbg.__wbg_randomFillSync_ac0988aba3254290=function(){return c0(function(H,Q){H.randomFillSync(Q)},arguments)},$.wbg.__wbg_require_60cc747a6bc5215a=function(){return c0(function(){return _H.require},arguments)},$.wbg.__wbg_static_accessor_GLOBAL_769e6b65d6557335=function(){let H=typeof global==="undefined"?null:global;return l0(H)?0:p0(H)},$.wbg.__wbg_static_accessor_GLOBAL_THIS_60cf02db4de8e1c1=function(){let H=typeof globalThis==="undefined"?null:globalThis;return l0(H)?0:p0(H)},$.wbg.__wbg_static_accessor_SELF_08f5a74c69739274=function(){let H=typeof self==="undefined"?null:self;return l0(H)?0:p0(H)},$.wbg.__wbg_static_accessor_WINDOW_a8924b26aa92d024=function(){let H=typeof window==="undefined"?null:window;return l0(H)?0:p0(H)},$.wbg.__wbg_subarray_845f2f5bce7d061a=function(H,Q,X){return H.subarray(Q>>>0,X>>>0)},$.wbg.__wbg_versions_c01dfd4722a88165=function(H){return H.versions},$.wbg.__wbindgen_cast_2241b6af4c4b2941=function(H,Q){return w0(H,Q)},$.wbg.__wbindgen_cast_cb9088102bce6b30=function(H,Q){return e(H,Q)},$.wbg.__wbindgen_init_externref_table=function(){let H=D.__wbindgen_externrefs,Q=H.grow(4);H.set(0,void 0),H.set(Q+0,void 0),H.set(Q+1,null),H.set(Q+2,!0),H.set(Q+3,!1)},$}function TH($,H){return D=$.exports,Y$.__wbindgen_wasm_module=H,u0=null,D.__wbindgen_start(),D}async function Y$($){if(D!==void 0)return D;if(typeof $!=="undefined")if(Object.getPrototypeOf($)===Object.prototype)({module_or_path:$}=$);else console.warn("using deprecated parameters for the initialization function; pass a single object instead");if(typeof $==="undefined")$=new URL("weba_crypto_wasm_bg.wasm",import.meta.url);let H=wH();if(typeof $==="string"||typeof Request==="function"&&$ instanceof Request||typeof URL==="function"&&$ instanceof URL)$=fetch($);let{instance:Q,module:X}=await IH(await $,H);return TH(Q,X)}var D,u0=null,K8,EH=2146435072,l8=0,o0,_=0,jH,z8;var Z$=J0(()=>{K8=new TextDecoder("utf-8",{ignoreBOM:!0,fatal:!0});K8.decode();o0=new TextEncoder;if(!("encodeInto"in o0))o0.encodeInto=function($,H){let Q=o0.encode($);return H.set(Q),{read:$.length,written:Q.length}};jH=new Set(["basic","cors","default"]);z8=Y$});var U$="";var N$={};Q8(N$,{win32:()=>o8,toNamespacedPath:()=>sH,sep:()=>$Q,resolve:()=>uH,relative:()=>nH,posix:()=>D0,parse:()=>eH,normalize:()=>lH,join:()=>oH,isAbsolute:()=>dH,format:()=>rH,extname:()=>tH,dirname:()=>iH,delimiter:()=>HQ,default:()=>pH,basename:()=>aH});var fH,G$,SH,vH,hH,kH,bH=($,H)=>()=>(H||$((H={exports:{}}).exports,H),H.exports),yH=($,H,Q,X)=>{if(H&&typeof H=="object"||typeof H=="function")for(let q of vH(H))!kH.call($,q)&&q!==Q&&G$($,q,{get:()=>H[q],enumerable:!(X=SH(H,q))||X.enumerable});return $},mH=($,H,Q)=>(Q=$!=null?fH(hH($)):{},yH(H||!$||!$.__esModule?G$(Q,"default",{value:$,enumerable:!0}):Q,$)),gH,L$,i,cH,J$=function($){return $},B$=function(){throw new Error("Not implemented")},D0,o8,pH,uH,lH,dH,oH,nH,sH,iH,aH,tH,rH,eH,$Q,HQ;var M$=J0(()=>{fH=Object.create,G$=Object.defineProperty,SH=Object.getOwnPropertyDescriptor,vH=Object.getOwnPropertyNames,hH=Object.getPrototypeOf,kH=Object.prototype.hasOwnProperty,gH=bH(($,H)=>{function Q(Y){if(typeof Y!="string")throw new TypeError("Path must be a string. Received "+JSON.stringify(Y))}function X(Y,U){for(var G="",L=0,J=-1,N=0,M,K=0;K<=Y.length;++K){if(K<Y.length)M=Y.charCodeAt(K);else{if(M===47)break;M=47}if(M===47){if(!(J===K-1||N===1))if(J!==K-1&&N===2){if(G.length<2||L!==2||G.charCodeAt(G.length-1)!==46||G.charCodeAt(G.length-2)!==46){if(G.length>2){var R=G.lastIndexOf("/");if(R!==G.length-1){R===-1?(G="",L=0):(G=G.slice(0,R),L=G.length-1-G.lastIndexOf("/")),J=K,N=0;continue}}else if(G.length===2||G.length===1){G="",L=0,J=K,N=0;continue}}U&&(G.length>0?G+="/..":G="..",L=2)}else G.length>0?G+="/"+Y.slice(J+1,K):G=Y.slice(J+1,K),L=K-J-1;J=K,N=0}else M===46&&N!==-1?++N:N=-1}return G}function q(Y,U){var G=U.dir||U.root,L=U.base||(U.name||"")+(U.ext||"");return G?G===U.root?G+L:G+Y+L:L}var Z={resolve:function(){for(var Y="",U=!1,G,L=arguments.length-1;L>=-1&&!U;L--){var J;L>=0?J=arguments[L]:(G===void 0&&(G=process.cwd()),J=G),Q(J),J.length!==0&&(Y=J+"/"+Y,U=J.charCodeAt(0)===47)}return Y=X(Y,!U),U?Y.length>0?"/"+Y:"/":Y.length>0?Y:"."},normalize:function(Y){if(Q(Y),Y.length===0)return".";var U=Y.charCodeAt(0)===47,G=Y.charCodeAt(Y.length-1)===47;return Y=X(Y,!U),Y.length===0&&!U&&(Y="."),Y.length>0&&G&&(Y+="/"),U?"/"+Y:Y},isAbsolute:function(Y){return Q(Y),Y.length>0&&Y.charCodeAt(0)===47},join:function(){if(arguments.length===0)return".";for(var Y,U=0;U<arguments.length;++U){var G=arguments[U];Q(G),G.length>0&&(Y===void 0?Y=G:Y+="/"+G)}return Y===void 0?".":Z.normalize(Y)},relative:function(Y,U){if(Q(Y),Q(U),Y===U||(Y=Z.resolve(Y),U=Z.resolve(U),Y===U))return"";for(var G=1;G<Y.length&&Y.charCodeAt(G)===47;++G);for(var L=Y.length,J=L-G,N=1;N<U.length&&U.charCodeAt(N)===47;++N);for(var M=U.length,K=M-N,R=J<K?J:K,x=-1,j=0;j<=R;++j){if(j===R){if(K>R){if(U.charCodeAt(N+j)===47)return U.slice(N+j+1);if(j===0)return U.slice(N+j)}else J>R&&(Y.charCodeAt(G+j)===47?x=j:j===0&&(x=0));break}var g=Y.charCodeAt(G+j),u=U.charCodeAt(N+j);if(g!==u)break;g===47&&(x=j)}var F="";for(j=G+x+1;j<=L;++j)(j===L||Y.charCodeAt(j)===47)&&(F.length===0?F+="..":F+="/..");return F.length>0?F+U.slice(N+x):(N+=x,U.charCodeAt(N)===47&&++N,U.slice(N))},_makeLong:function(Y){return Y},dirname:function(Y){if(Q(Y),Y.length===0)return".";for(var U=Y.charCodeAt(0),G=U===47,L=-1,J=!0,N=Y.length-1;N>=1;--N)if(U=Y.charCodeAt(N),U===47){if(!J){L=N;break}}else J=!1;return L===-1?G?"/":".":G&&L===1?"//":Y.slice(0,L)},basename:function(Y,U){if(U!==void 0&&typeof U!="string")throw new TypeError('"ext" argument must be a string');Q(Y);var G=0,L=-1,J=!0,N;if(U!==void 0&&U.length>0&&U.length<=Y.length){if(U.length===Y.length&&U===Y)return"";var M=U.length-1,K=-1;for(N=Y.length-1;N>=0;--N){var R=Y.charCodeAt(N);if(R===47){if(!J){G=N+1;break}}else K===-1&&(J=!1,K=N+1),M>=0&&(R===U.charCodeAt(M)?--M===-1&&(L=N):(M=-1,L=K))}return G===L?L=K:L===-1&&(L=Y.length),Y.slice(G,L)}else{for(N=Y.length-1;N>=0;--N)if(Y.charCodeAt(N)===47){if(!J){G=N+1;break}}else L===-1&&(J=!1,L=N+1);return L===-1?"":Y.slice(G,L)}},extname:function(Y){Q(Y);for(var U=-1,G=0,L=-1,J=!0,N=0,M=Y.length-1;M>=0;--M){var K=Y.charCodeAt(M);if(K===47){if(!J){G=M+1;break}continue}L===-1&&(J=!1,L=M+1),K===46?U===-1?U=M:N!==1&&(N=1):U!==-1&&(N=-1)}return U===-1||L===-1||N===0||N===1&&U===L-1&&U===G+1?"":Y.slice(U,L)},format:function(Y){if(Y===null||typeof Y!="object")throw new TypeError('The "pathObject" argument must be of type Object. Received type '+typeof Y);return q("/",Y)},parse:function(Y){Q(Y);var U={root:"",dir:"",base:"",ext:"",name:""};if(Y.length===0)return U;var G=Y.charCodeAt(0),L=G===47,J;L?(U.root="/",J=1):J=0;for(var N=-1,M=0,K=-1,R=!0,x=Y.length-1,j=0;x>=J;--x){if(G=Y.charCodeAt(x),G===47){if(!R){M=x+1;break}continue}K===-1&&(R=!1,K=x+1),G===46?N===-1?N=x:j!==1&&(j=1):N!==-1&&(j=-1)}return N===-1||K===-1||j===0||j===1&&N===K-1&&N===M+1?K!==-1&&(M===0&&L?U.base=U.name=Y.slice(1,K):U.base=U.name=Y.slice(M,K)):(M===0&&L?(U.name=Y.slice(1,N),U.base=Y.slice(1,K)):(U.name=Y.slice(M,N),U.base=Y.slice(M,K)),U.ext=Y.slice(N,K)),M>0?U.dir=Y.slice(0,M-1):L&&(U.dir="/"),U},sep:"/",delimiter:":",win32:null,posix:null};Z.posix=Z,H.exports=Z}),L$=mH(gH()),i=L$,cH=L$;i.parse??=B$;cH.parse??=B$;D0={resolve:i.resolve.bind(i),normalize:i.normalize.bind(i),isAbsolute:i.isAbsolute.bind(i),join:i.join.bind(i),relative:i.relative.bind(i),toNamespacedPath:J$,dirname:i.dirname.bind(i),basename:i.basename.bind(i),extname:i.extname.bind(i),format:i.format.bind(i),parse:i.parse.bind(i),sep:"/",delimiter:":",win32:void 0,posix:void 0,_makeLong:J$},o8={sep:"\\",delimiter:";",win32:void 0,...D0,posix:D0};D0.win32=o8.win32=o8;D0.posix=D0;pH=D0,{resolve:uH,normalize:lH,isAbsolute:dH,join:oH,relative:nH,toNamespacedPath:sH,dirname:iH,basename:aH,extname:tH,format:rH,parse:eH,sep:$Q,delimiter:HQ}=D0});var a8={};Q8(a8,{x25519GetSharedSecret:()=>YQ,x25519GetPublicKey:()=>s0,x25519GenerateKeyPair:()=>n8,sha256Hash:()=>OQ,p256Verify:()=>JQ,p256Sign:()=>UQ,p256GenerateKeyPair:()=>ZQ,mlKem768GenerateKeyPair:()=>GQ,mlKem768Encapsulate:()=>LQ,mlKem768Decapsulate:()=>BQ,mlDsa44Verify:()=>CQ,mlDsa44Sign:()=>MQ,mlDsa44GenerateKeyPair:()=>NQ,initWasmFromB64:()=>n0,initWasm:()=>Z0,hkdfSha256:()=>U0,getPaddingTargetSize:()=>D8,ed25519Verify:()=>O$,ed25519Sign:()=>C$,ed25519PublicKeyToX25519PublicKey:()=>i8,ed25519GenerateKeyPair:()=>s8,decryptL2Envelope:()=>a0,constantTimeEqual:()=>QQ,buildL2Envelope:()=>i0,aesGcmEncrypt:()=>XQ,aesGcmDecrypt:()=>qQ});async function Z0($){if(p)return;if($)await z8($);else if(typeof window!=="undefined"&&window.__WEBA_MANIFEST){let Q=window.__WEBA_MANIFEST.blobs?.find((X)=>X.id==="weba-crypto-wasm");if(Q){let X=document.getElementById("weba-blob-"+Q.digest.split(":")[1]);if(X){let q=atob(X.textContent.trim()),Z=new Uint8Array(q.length);for(let Y=0;Y<q.length;Y++)Z[Y]=q.charCodeAt(Y);await z8(Z),p=!0,console.log(`WASM Crypto Initialized from Manifest: ${d8()}`);return}}await n0()}else if(typeof process!=="undefined"&&process.versions&&process.versions.node){let H=await import("node:fs"),X=(await Promise.resolve().then(() => (M$(),N$))).join(import.meta.dirname,"wasm_bindings/weba_crypto_wasm_bg.wasm"),q=H.readFileSync(X);await z8(q)}else try{await n0()}catch(H){throw new Error("WASM source must be provided in browser environment")}if(p=!0,!p)console.log(`WASM Crypto Initialized: ${d8()}`)}async function n0(){if(p)return;let $=atob(U$),H=new Uint8Array($.length);for(let Q=0;Q<$.length;Q++)H[Q]=$.charCodeAt(Q);await Z0(H)}function QQ($,H){if(!p)throw new Error("WASM not initialized");return y4($,H)}function XQ($,H,Q,X){if(!p)throw new Error("WASM not initialized");return k4($,H,Q,X)}function qQ($,H,Q,X){if(!p)throw new Error("WASM not initialized");return h4($,H,Q,X)}function n8(){if(!p)throw new Error("WASM not initialized");let $=Q$();return{privateKey:$.slice(0,32),publicKey:$.slice(32,64)}}function s0($){if(!p)throw new Error("WASM not initialized");return X$($)}function YQ($,H){if(!p)throw new Error("WASM not initialized");return q$($,H)}function s8(){if(!p)throw new Error("WASM not initialized");let $=g4();return{privateKey:$.slice(0,32),publicKey:$.slice(32,64)}}function C$($,H){if(!p)throw new Error("WASM not initialized");return p4($,H)}function O$($,H,Q){if(!p)throw new Error("WASM not initialized");return u4($,H,Q)}function ZQ(){if(!p)throw new Error("WASM not initialized");let $=r4();return{privateKey:$.slice(0,32),publicKey:$.slice(32,97)}}function UQ($,H){if(!p)throw new Error("WASM not initialized");return e4($,H)}function JQ($,H,Q){if(!p)throw new Error("WASM not initialized");return $$($,H,Q)}function GQ(){if(!p)throw new Error("WASM not initialized");let $=t4();return{privateKey:$.slice(0,2400),publicKey:$.slice(2400,3584)}}function LQ($){if(!p)throw new Error("WASM not initialized");let H=a4($);return{sharedSecret:H.slice(0,32),ciphertext:H.slice(32,1120)}}function BQ($,H){if(!p)throw new Error("WASM not initialized");return i4($,H)}function NQ(){if(!p)throw new Error("WASM not initialized");let $=o4();return{privateKey:$.slice(0,2560),publicKey:$.slice(2560,3872)}}function MQ($,H){if(!p)throw new Error("WASM not initialized");return n4($,H)}function CQ($,H,Q){if(!p)throw new Error("WASM not initialized");return s4($,H,Q)}function OQ($){if(!p)throw new Error("WASM not initialized");return H$($)}function U0($,H,Q,X){if(!p)throw new Error("WASM not initialized");return d4($,H||new Uint8Array(0),Q,X)}function D8($){if(!p)throw new Error("WASM not initialized");return l4($)}function i0($,H,Q,X,q){if(!p)throw new Error("WASM not initialized");return b4($,H,Q,X,q)}function a0($,H,Q){if(!p)throw new Error("WASM not initialized");return m4($,H,Q)}function i8($){if(!p)throw new Error("WASM not initialized");return c4($)}var p=!1;var _0=J0(()=>{Z$()});function r8($){if(W$)return Buffer.from($).toString("base64").replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/g,"");let H="";return $.forEach((Q)=>{H+=String.fromCharCode(Q)}),btoa(H).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/g,"")}function e8($){let Q=($.length%4===0?$:$+"=".repeat(4-$.length%4)).replace(/-/g,"+").replace(/_/g,"/");if(W$)return Uint8Array.from(Buffer.from(Q,"base64"));let X=atob(Q),q=new Uint8Array(X.length);for(let Z=0;Z<X.length;Z++)q[Z]=X.charCodeAt(Z);return q}function IQ($){if($.length===0)return new Uint8Array;let H=[0];for(let q of $){let Z="123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz".indexOf(q);if(Z<0)throw new Error(`Invalid base58 character: ${q}`);let Y=Z;for(let U=0;U<H.length;U++){let G=H[U]*58+Y;H[U]=G&255,Y=G>>8}while(Y>0)H.push(Y&255),Y>>=8}let Q=0;for(let q of $){if(q!=="1")break;Q+=1}let X=new Uint8Array(Q+H.length);for(let q=0;q<H.length;q++)X[X.length-1-q]=H[q];return X}function x$($){if(!$.startsWith("z"))throw new Error(`Unsupported multibase prefix in ${$}`);return IQ($.slice(1))}var W$;var $4=J0(()=>{W$=typeof Buffer!=="undefined"});function R$($){return r8($)}function V$($){return e8($)}function TQ($){let H=E$.default($);if(H===void 0)throw new Error("Failed to canonicalize JSON");return H}async function j$(){return await Z0(),n8()}async function _Q(){return await Z0(),s8()}async function I$($,H,Q,X,q){await Z0();let Y=q?.userSk??(await _Q()).privateKey,U=q?.meta?.created_at||new Date().toISOString(),G={enabled:!0,recipient_kid:X,recipient_x25519:R$(H),recipient_pqc:q?.pqc?R$(q.pqc.recipientPublicKey):void 0,layer1_ref:Q,weba_version:wQ,campaign_id:q?.meta?.campaign_id},L=q?.userKid||(q?.userSk?"user#sig-custom":"user#sig-1"),J=i0(TQ($.layer2_plain),Y,L,JSON.stringify(G),U);return JSON.parse(J)}class w${seenNonces=new Set;store;constructor($){this.store=$}async checkAndMark($){if(this.store){if(await this.store.has($))return!1;return await this.store.add($),!0}if(this.seenNonces.has($))return!1;return this.seenNonces.add($),!0}async reset(){if(this.store)await this.store.reset();this.seenNonces.clear()}}async function T$($,H,Q){if(await Z0(),$.layer2.enc!=="HPKE-v1")throw new Error(`Unsupported layer2.enc: ${$.layer2.enc}`);if(!Q?.skipReplayCheck){let Z=Q?.replayGuard;if(!Z)console.warn("SECURITY WARNING: No ReplayGuard provided to decryptLayer2. Using in-memory ephemeral store. Replays will only be detected within this process lifetime."),Z=new w$;if(!await Z.checkAndMark($.meta.nonce))throw new Error("Security Error: Replay detected (nonce used).")}let X=JSON.stringify($),q=Q?.pqc?.recipientPrivateKey;try{let Z=a0(X,H,q);return JSON.parse(Z)}catch(Z){let Y=Z instanceof Error?Z.message:String(Z);if(Y.includes("Missing PQC KEM")||Y.includes("AAD mismatch"))throw new Error(Y);throw new Error("Decryption failed")}}var E$,wQ="0.1";var _$=J0(()=>{E$=H8(X8(),1);$4();_0()});function fQ($){let H=0,Q=0;for(let X=0;X<$.length;X++){let q=$[X];if(q===void 0)break;if(H|=(q&127)<<Q,(q&128)===0)return{value:H,length:X+1};Q+=7}throw new Error("Invalid varint encoding")}function SQ($){let{value:H,length:Q}=fQ($);return{code:H,data:$.slice(Q)}}function f$($){let H=new Map;if(Array.isArray($.verificationMethod))$.verificationMethod.forEach((Q)=>{if(Q?.id)H.set(Q.id,Q)});if(Array.isArray($.assertionMethod))$.assertionMethod.forEach((Q)=>{if(Q&&typeof Q==="object"&&"id"in Q){let X=Q;if(X.id)H.set(X.id,X)}});return H}function S$($){let Q=$.split("#")[0]||"";if(!Q.startsWith("did:key:"))throw new Error(`Unsupported DID method for did:key decoding: ${$}`);let X=Q.slice(8),q=SQ(x$(X));return{code:q.code,publicKey:q.data}}async function v$($,H=fetch){if($.startsWith("did:key:")){let Y=$.slice(8);return{id:$,verificationMethod:[{id:`${$}#${Y}`,type:"Multikey",controller:$,publicKeyMultibase:Y}],assertionMethod:[`${$}#${Y}`]}}if(!$.startsWith("did:web:"))return null;let Q=$.split(":")[2];if(!Q)return null;let X=$.split(":").slice(3),q=X.length>0?X.join("/"):".well-known",Z=`https://${Q}/${q}/did.json`;try{let Y=await H(Z);if(!Y.ok)return null;return await Y.json()}catch(Y){return console.warn(`Failed to resolve DID ${$}:`,Y),null}}var h$=J0(()=>{$4()});var y$={};Q8(y$,{sendGuestMessage:()=>H4,getOrCreateGuestDid:()=>Q4,fetchGuestInbox:()=>b$});async function vQ($){if($.startsWith("did:key:"))try{let{code:Y,publicKey:U}=S$($);if(Y===236)return{publicKey:U,kid:`${$}#${$.split(":").pop()}`};if(Y===237)return{publicKey:i8(U),kid:`${$}#${$.split(":").pop()}`};throw new Error(`Unsupported did:key type (multicodec: 0x${Y.toString(16)})`)}catch(Y){throw new Error(`Failed to resolve did:key: ${Y.message||Y}`)}let H=await v$($,fetch);if(!H)throw new Error(`Failed to resolve DID: ${$}`);if(!H.keyAgreement||H.keyAgreement.length===0)throw new Error("No keyAgreement found in DID Document");let Q=H.keyAgreement[0],X;if(typeof Q==="string")X=Q;else if(Q&&typeof Q==="object"&&"id"in Q)X=Q.id;else throw new Error("Invalid keyAgreement format in DID Document");let q=f$(H),Z=q.get(X);if(!Z){let Y=X.split("#").pop();if(Y){for(let[U,G]of q.entries())if(U.endsWith(`#${Y}`)){Z=G;break}}}if(!Z&&typeof Q==="object"&&"publicKeyJwk"in Q)Z=Q;if(!Z)throw new Error(`KeyAgreement method not found: ${X}`);if(Z.publicKeyJwk&&typeof Z.publicKeyJwk==="object"){let Y=Z.publicKeyJwk;if(Y.kty==="OKP"&&Y.crv==="X25519"&&Y.x)return{publicKey:V$(Y.x),kid:Z.id}}throw new Error("No X25519 encryption key found in DID Document")}async function H4($,H,Q){await Z0(fetch("weba_crypto_wasm_bg.wasm"));let X=localStorage.getItem(`guest-did:${$}`);if(!X)throw new Error("Credential ID not found for DID");let Z={layer2_plain:{type:"https://schema.org/Message",ext:{"com.example.rsvp":{attending:!0,count:1}},text:Q,timestamp:new Date().toISOString()},layer2_sig:{alg:"none",kid:"guest-passkey",sig:"",created_at:new Date().toISOString()}};console.log("Resolving recipient...",H);let{publicKey:Y,kid:U}=await vQ(H);console.log("Encrypting...",U);let G=await I$(Z,Y,`ref:${Date.now()}`,U,{userSk:new Uint8Array(0),userKid:"guest-passkey"}),J=await(await fetch(r0,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({query:"query GetChallenge($did: ID!) { getChallenge(did: $did) { nonce } }",variables:{did:$}})})).json();if(J.errors)throw new Error(J.errors[0].message);let N=J.data.getChallenge.nonce,M=t0(N);console.log("Requesting Passkey signature...");let K=await navigator.credentials.get({publicKey:{challenge:M,allowCredentials:[{id:t0(X),type:"public-key"}],userVerification:"required"}});if(!K)throw new Error("Authentication failed");let R=K.response,x=`
        mutation GuestPostMessage(
            $did: ID!, 
            $credentialId: String!, 
            $signature: String!, 
            $authenticatorData: String!, 
            $clientDataJSON: String!,
            $recipientDid: String!,
            $envelope: String!
        ) {
            guestPostMessage(
                did: $did, 
                credentialId: $credentialId, 
                signature: $signature, 
                authenticatorData: $authenticatorData, 
                clientDataJSON: $clientDataJSON,
                recipientDid: $recipientDid,
                envelope: $envelope
            ) {
                id
            }
        }
    `,g=await(await fetch(r0,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({query:x,variables:{did:$,credentialId:X,signature:S0(R.signature),authenticatorData:S0(R.authenticatorData),clientDataJSON:S0(R.clientDataJSON),recipientDid:H,envelope:JSON.stringify(G)}})})).json();if(g.errors)throw new Error(g.errors[0].message);return console.log("Guest Message Sent!",g.data.guestPostMessage.id),g.data.guestPostMessage}async function bQ(){let $=localStorage.length;for(let H=0;H<$;H++){let Q=localStorage.key(H);if(!Q||!Q.startsWith("guest-did:"))continue;if(Q.endsWith(":privateKey"))continue;return Q.replace("guest-did:","")}return null}async function Q4($=!1){if(!window.PublicKeyCredential)throw new Error("Passkey not supported on this device");if(!$){let Q=await bQ();if(Q)return console.log("Reusing existing Guest DID"),{did:Q,isReused:!0}}return{did:await yQ(),isReused:!1}}async function yQ(){try{let X=function(N){let M="",K=new Uint8Array(N),R=K.length;for(let x=0;x<R;x++)M+=String.fromCharCode(K[x]);return btoa(M)};await Z0(fetch("weba_crypto_wasm_bg.wasm"));let $=new Uint8Array(32);crypto.getRandomValues($);let H=new Uint8Array(16);crypto.getRandomValues(H);let Q=await navigator.credentials.create({publicKey:{challenge:$,rp:{name:kQ,id:window.location.hostname},user:{id:H,name:"guest@srn.example",displayName:"SRN Guest User"},pubKeyCredParams:[{alg:-7,type:"public-key"}],authenticatorSelection:{authenticatorAttachment:"platform",userVerification:"required",residentKey:"required",requireResidentKey:!0},timeout:60000,attestation:"none"}});if(!Q)throw new Error("Passkey creation cancelled");let q=await j$(),Z={kty:"OKP",crv:"X25519",x:k$(q.publicKey)},Y=`
      mutation CreateGuestDid($credentialId: String!, $attestationObject: String!, $clientDataJSON: String!, $encryptionPublicKeyJwk: String!) {
        createGuestDid(credentialId: $credentialId, attestationObject: $attestationObject, clientDataJSON: $clientDataJSON, encryptionPublicKeyJwk: $encryptionPublicKeyJwk) {
          did
          expiresAt
        }
      }
    `,G=await(await fetch(r0,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({query:Y,variables:{credentialId:Q.id,attestationObject:X(Q.response.attestationObject),clientDataJSON:X(Q.response.clientDataJSON),encryptionPublicKeyJwk:JSON.stringify(Z)}})})).json();if(G.errors)throw new Error(`GraphQL Error: ${G.errors[0].message}`);let{did:L,expiresAt:J}=G.data.createGuestDid;return localStorage.setItem(`guest-did:${L}`,Q.id),localStorage.setItem(`guest-did:${L}:privateKey`,k$(q.privateKey)),console.log(`Guest DID created: ${L} (expires: ${J})`),L}catch($){throw console.error("Failed to create Guest DID:",$),$}}async function b$($){await Z0(fetch("weba_crypto_wasm_bg.wasm"));let H=localStorage.getItem(`guest-did:${$}`);if(!H)throw new Error("Credential ID not found for DID");let X=await(await fetch(r0,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({query:"query GetChallenge($did: ID!) { getChallenge(did: $did) { nonce } }",variables:{did:$}})})).json();if(X.errors)throw new Error(X.errors[0].message);let q=X.data.getChallenge.nonce,Z=t0(q),Y=await navigator.credentials.get({publicKey:{challenge:Z,allowCredentials:[{id:t0(H),type:"public-key"}],userVerification:"required"}});if(!Y)throw new Error("Authentication failed");let U=Y.response,G=`
        query GuestInbox($did: ID!, $credentialId: String!, $signature: String!, $authenticatorData: String!, $clientDataJSON: String!) {
            guestInbox(did: $did, credentialId: $credentialId, signature: $signature, authenticatorData: $authenticatorData, clientDataJSON: $clientDataJSON) {
                id
                senderDid
                recipientDid
                envelope
                createdAt
            }
        }
    `,J=await(await fetch(r0,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({query:G,variables:{did:$,credentialId:H,signature:S0(U.signature),authenticatorData:S0(U.authenticatorData),clientDataJSON:S0(U.clientDataJSON)}})})).json();if(J.errors)throw new Error(J.errors[0].message);let N=J.data.guestInbox,M=localStorage.getItem(`guest-did:${$}:privateKey`);if(M){let K=new Uint8Array(t0(M));for(let R of N)if(R.envelope)try{let x=JSON.parse(R.envelope),j=await T$(x,K);if(j.layer2_plain)R.content=j.layer2_plain;else R.content=j;delete R.envelope}catch(x){console.error("Failed to decrypt:",x),R.content={text:"[Decryption Failed: "+x.message+"]"}}}return N}function t0($){let H="=".repeat((4-$.length%4)%4),Q=($+H).replace(/-/g,"+").replace(/_/g,"/"),X=window.atob(Q),q=new Uint8Array(X.length);for(let Z=0;Z<X.length;++Z)q[Z]=X.charCodeAt(Z);return q.buffer}function S0($){let H="",Q=new Uint8Array($),X=Q.length;for(let q=0;q<X;q++)H+=String.fromCharCode(Q[q]);return window.btoa(H)}function k$($){let H="",Q=$.length;for(let X=0;X<Q;X++)H+=String.fromCharCode($[X]);return btoa(H).replace(/\+/g,"-").replace(/\//g,"_").replace(/=/g,"")}var hQ,r0,kQ="SRN Guest Service";var X4=J0(()=>{_$();_0();h$();hQ=typeof window!=="undefined"&&(window.location.hostname==="localhost"||window.location.hostname==="127.0.0.1"),r0=hQ?"http://127.0.0.1:5002/api":"/api";if(typeof window!=="undefined")window.getOrCreateGuestDid=Q4,window.fetchGuestInbox=b$,window.sendGuestMessage=H4,window.submitFormWithGuestDid=async($,H,Q)=>{let{did:X,isReused:q}=await Q4(!1),Z=JSON.stringify($);return await H4(X,Q||"did:web:srn.example",Z),{senderDid:X}},window.clearAllGuestDids=()=>{let $=Object.keys(localStorage);for(let H of $)if(H.startsWith("guest-did:"))localStorage.removeItem(H)}});function m$($){let H=document.getElementById($);if(!H||!H.textContent)return null;try{return JSON.parse(H.textContent)}catch{return null}}function g$(){let $=m$("weba-l2-envelope");if(!$)return;let H=m$("weba-l2-keywrap"),Q=document.querySelector(".weba-form-container")||document.body,X=document.createElement("div");X.className="weba-l2-unlock",X.style.cssText="margin-top:2rem;padding:1rem;border:1px solid #cbd5f5;border-radius:10px;background:#f8fafc;";let q=document.createElement("div");q.textContent="Encrypted Submission",q.style.cssText="font-weight:600;color:#334155;margin-bottom:0.5rem;",X.appendChild(q);let Z=document.createElement("div");Z.textContent="Locked. Unlock with Passkey.",Z.style.cssText="color:#64748b;margin-bottom:0.75rem;",X.appendChild(Z);let Y=document.createElement("button");Y.textContent="Unlock (Passkey)",Y.style.cssText="padding:0.5rem 1rem;border:1px solid #94a3b8;border-radius:6px;background:#fff;cursor:pointer;",X.appendChild(Y);let U=document.createElement("pre");U.style.cssText="margin-top:1rem;padding:1rem;background:#0f172a;color:#e2e8f0;border-radius:8px;overflow:auto;font-size:0.85rem;display:none;",X.appendChild(U);let G=document.createElement("details");G.style.cssText="margin-top:0.75rem; display:none;",G.innerHTML='<summary style="cursor:pointer;color:#64748b;">Show signature</summary><pre style="margin-top:0.5rem;padding:0.75rem;background:#0b1220;color:#cbd5f5;border-radius:6px;overflow:auto;font-size:0.8rem;"></pre>',X.appendChild(G);let L=document.createElement("button");L.textContent="Export JSON",L.style.cssText="margin-top:0.75rem;padding:0.45rem 0.9rem;border:1px solid #94a3b8;border-radius:6px;background:#fff;cursor:pointer;display:none;",L.disabled=!0,X.appendChild(L),Y.addEventListener("click",async()=>{if(!H){Z.textContent="Key wrap package not found.";return}Y.disabled=!0,Z.textContent="Waiting for passkey...";try{let J=N0(H.prf_salt),N=await I0(H.credential_id,J),M=await Y4({keywrap:H,prfKey:N}),K=await q4($,M,{skipReplayCheck:!0});mQ(K.layer2_plain),document.body.classList.add("weba-l2-readonly"),U.textContent=JSON.stringify(K.layer2_plain,null,2),U.style.display="block";let R=G.querySelector("pre");if(R)R.textContent=JSON.stringify(K.layer2_sig,null,2);G.style.display="block",L.style.display="inline-block",L.disabled=!1,Z.textContent="Unlocked.",L.onclick=()=>{let x=new Blob([JSON.stringify(K,null,2)],{type:"application/json"}),j=URL.createObjectURL(x),g=document.createElement("a");g.href=j,g.download="weba-l2-decrypted.json",g.click()}}catch(J){console.error(J),Z.textContent="Unlock failed.",Y.disabled=!1}}),Q.appendChild(X)}function mQ($){if(!$||typeof $!=="object")return;let H=$;document.querySelectorAll("[data-json-path]").forEach((Q)=>{let X=Q.dataset.jsonPath;if(!X||!(X in H))return;let q=H[X];if(Q.type==="checkbox")Q.checked=Boolean(q);else if(Q.type==="radio")Q.checked=Q.value===String(q);else Q.value=q===null||q===void 0?"":String(q)}),document.querySelectorAll('input[type="radio"]').forEach((Q)=>{let X=Q.name;if(!X||!(X in H))return;let q=H[X];Q.checked=Q.value===String(q)}),document.querySelectorAll("table.data-table.dynamic").forEach((Q)=>{let X=Q.dataset.tableKey;if(!X)return;let q=H[X];if(!Array.isArray(q))return;let Z=Q.querySelector("tbody");if(!Z)return;let Y=Z.querySelector("tr.template-row");if(!Y)return;Array.from(Z.querySelectorAll("tr")).forEach((U)=>{if(!U.classList.contains("template-row"))U.remove()}),q.forEach((U,G)=>{let L=G===0?Y:Y.cloneNode(!0);if(G>0){L.classList.remove("template-row");let J=L.querySelector(".remove-row-btn");if(J)J.style.visibility="visible";Z.appendChild(L)}if(U&&typeof U==="object")L.querySelectorAll("input, select, textarea").forEach((J)=>{let N=J.dataset.baseKey;if(!N)return;let M=U[N];if(J.type==="checkbox")J.checked=Boolean(M);else J.value=M===null||M===void 0?"":String(M)})})}),document.querySelectorAll("input").forEach((Q)=>{if(Q.type==="checkbox"||Q.type==="radio")Q.disabled=!0;else Q.readOnly=!0}),document.querySelectorAll("textarea").forEach((Q)=>{Q.readOnly=!0}),document.querySelectorAll("select").forEach((Q)=>{Q.disabled=!0}),document.querySelectorAll(".form-toolbar button, .add-row-btn, .remove-row-btn").forEach((Q)=>{Q.disabled=!0})}var c$=J0(()=>{v0()});function M0($){return document.getElementById($)}function p$(){if(!M0("weba-l2-keywrap-tool"))return;let H=M0("kwp-recipient-sk"),Q=M0("kwp-credential-id"),X=M0("kwp-prf-salt"),q=M0("kwp-aad"),Z=M0("kwp-kid"),Y=M0("kwp-status"),U=M0("kwp-output"),G=M0("kwp-generate-salt"),L=M0("kwp-wrap");if(!H||!Q||!X||!Y||!U||!L)return;G?.addEventListener("click",()=>{let J=new Uint8Array(32);crypto.getRandomValues(J),X.value=F0(J)}),L.addEventListener("click",async()=>{Y.textContent="Waiting for passkey...",L.disabled=!0;try{if(!H.value||!Q.value||!X.value)throw new Error("Missing required fields.");let J=N0(H.value.trim()),N=N0(X.value.trim()),M=await I0(Q.value.trim(),N),K=q?.value?N0(q.value.trim()):void 0,R=await Z4({recipientSk:J,prfKey:M,aad:K}),x={alg:"WebAuthn-PRF-AESGCM-v1",kid:Z?.value||"issuer#passkey-1",credential_id:Q.value.trim(),prf_salt:F0(N),wrapped_key:F0(R),...K?{aad:F0(K)}:{}};U.textContent=JSON.stringify(x,null,2),Y.textContent="Key wrap ready."}catch(J){console.error(J),Y.textContent="Key wrap failed."}finally{L.disabled=!1}})}var u$=J0(()=>{v0()});var A8={};Q8(A8,{wrapRecipientPrivateKey:()=>Z4,unwrapRecipientPrivateKey:()=>Y4,selectEpochKey:()=>tQ,loadL2Config:()=>sQ,getPaddingTargetSize:()=>gQ,fetchPreKey:()=>iQ,fetchEpochRegistry:()=>aQ,deriveOrgX25519KeyPair:()=>uQ,deriveKeyPairFromPrf:()=>lQ,decryptLayer2Envelope:()=>q4,buildLayer2Envelope:()=>nQ,b64urlEncode:()=>F0,b64urlDecode:()=>N0,ReplayGuard:()=>U4,LocalStorageReplayStore:()=>d$});class d${key;nonces;constructor($="weba_l2_nonces"){this.key=$,this.nonces=new Set,this.load()}load(){let $=localStorage.getItem(this.key);if($)try{let H=JSON.parse($);if(Array.isArray(H))this.nonces=new Set(H)}catch(H){console.error("Failed to load replay store from localStorage",H)}}save(){try{localStorage.setItem(this.key,JSON.stringify(Array.from(this.nonces)))}catch($){console.error("Failed to save replay store to localStorage",$)}}async has($){return this.nonces.has($)}async add($){this.nonces.add($),this.save()}async reset(){this.nonces.clear(),this.save()}}async function gQ($){return await W0(),D8($)}function cQ(){let $=localStorage.getItem("weba_l2_ed25519_sk");if($)return N0($);let H=new Uint8Array(32);return crypto.getRandomValues(H),localStorage.setItem("weba_l2_ed25519_sk",F0(H)),H}function F0($){if(typeof Buffer!=="undefined")return Buffer.from($).toString("base64").replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/g,"");let H="";return $.forEach((X)=>{H+=String.fromCharCode(X)}),btoa(H).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/g,"")}function N0($){let H=$.length%4===0?"":"=".repeat(4-$.length%4),Q=$.replace(/-/g,"+").replace(/_/g,"/")+H;if(typeof Buffer!=="undefined")return new Uint8Array(Buffer.from(Q,"base64"));let X=atob(Q),q=new Uint8Array(X.length);for(let Z=0;Z<X.length;Z+=1)q[Z]=X.charCodeAt(Z);return q}function pQ($){let H=l$.default($);if(H===void 0)throw new Error("Failed to canonicalize JSON");return H}async function W0(){await n0()}async function uQ($){await W0();let H=$.keyPolicy??"campaign+layer1";if(H==="campaign+layer1"&&!$.layer1Ref)throw new Error("layer1_ref is required for campaign+layer1 policy");let Q=JSON.stringify({domain:"weba-l2/org-x25519",campaign_id:$.campaignId,key_policy:H,layer1_ref:H==="campaign+layer1"?$.layer1Ref:void 0}),X=new TextEncoder().encode(Q),q=U0($.orgRootKey,void 0,X,32);return{publicKey:s0(q),privateKey:q,keyPolicy:H}}async function lQ($){await W0();let H=new TextEncoder().encode("weba-l2/user-x25519"),Q=U0($,void 0,H,32);return{publicKey:s0(Q),privateKey:Q}}async function dQ($,H,Q,X){let q=await crypto.subtle.importKey("raw",H,"AES-GCM",!1,["encrypt"]),Z=await crypto.subtle.encrypt({name:"AES-GCM",iv:Q,additionalData:X},q,$);return new Uint8Array(Z)}async function Z4($){await W0();let H=U0($.prfKey,void 0,new TextEncoder().encode("weba-l2/prk"),32),Q=U0(H,void 0,new TextEncoder().encode("weba-l2/kw"),32),X=U0(H,void 0,new TextEncoder().encode("weba-l2/kw-iv"),12),q=$.aad??new Uint8Array;return dQ($.recipientSk,Q,X,q)}async function oQ($,H,Q,X){let q=await crypto.subtle.importKey("raw",H,"AES-GCM",!1,["decrypt"]),Z=await crypto.subtle.decrypt({name:"AES-GCM",iv:Q,additionalData:X},q,$);return new Uint8Array(Z)}async function nQ($){await W0();let H=$.user_sk||cQ(),Q=new Date().toISOString(),X=$.user_kid||"user#sig-1",q={...$.config,recipient_pqc:$.config.recipient_pqc||void 0},Z=i0(pQ($.layer2_plain),H,X,JSON.stringify(q),Q);return JSON.parse(Z)}function sQ(){let $=document.getElementById("weba-l2-config");if(!$||!$.textContent)return null;try{return JSON.parse($.textContent)}catch{return null}}class U4{seenNonces=new Set;store;constructor($){this.store=$}async checkAndMark($){if(this.store){if(await this.store.has($))return!1;return await this.store.add($),!0}if(this.seenNonces.has($))return!1;return this.seenNonces.add($),!0}async reset(){if(this.store)await this.store.reset();this.seenNonces.clear()}}async function q4($,H,Q){if(await W0(),$.layer2.enc!=="HPKE-v1")throw new Error(`Unsupported layer2.enc: ${$.layer2.enc}`);if(!Q?.skipReplayCheck){let Z=Q?.replayGuard;if(!Z)console.warn("SECURITY WARNING: No ReplayGuard provided to decryptLayer2Envelope. Using in-memory ephemeral store. Replays will only be detected within this page session."),Z=new U4;if(!await Z.checkAndMark($.meta.nonce))throw new Error("Security Error: Replay detected (nonce used).")}let X=JSON.stringify($),q=Q?.pqcRecipientSk;try{let Z=a0(X,H,q);return JSON.parse(Z)}catch(Z){let Y=Z instanceof Error?Z.message:String(Z);if(Y.includes("Missing PQC KEM")||Y.includes("AAD mismatch"))throw new Error(Y);throw new Error("Decryption failed")}}async function iQ($){try{let H=await fetch($);if(!H.ok)throw new Error(`Pre-key fetch failed: ${H.status}`);return await H.json()}catch(H){return console.error("Failed to fetch pre-key",H),null}}async function aQ($){try{let H=await fetch($);if(!H.ok)return null;return await H.json()}catch(H){return console.warn("Failed to fetch epoch registry:",H),null}}function tQ($){let H=new Date;return $.keys.find((X)=>{let q=new Date(X.validFrom),Z=new Date(X.validUntil);return H>=q&&H<=Z})||null}async function Y4($){await W0();let H=U0($.prfKey,void 0,new TextEncoder().encode("weba-l2/prk"),32),Q=U0(H,void 0,new TextEncoder().encode("weba-l2/kw"),32),X=U0(H,void 0,new TextEncoder().encode("weba-l2/kw-iv"),12),q=$.keywrap.aad?N0($.keywrap.aad):new Uint8Array,Z=N0($.keywrap.wrapped_key);return oQ(Z,Q,X,q)}var l$;var v0=J0(()=>{l$=H8(X8(),1);_0();X4();c$();u$();if(typeof window!=="undefined")window.initL2Viewer=g$,window.initKeywrapTool=p$});class x8{runAutoCopy(){document.querySelectorAll("[data-copy-from]").forEach(($)=>{if(!$.dataset.dirty){let H=$.dataset.copyFrom;if(H){let q=($.closest("tr")||document).querySelector(`[data-base-key="${H}"], [data-json-path="${H}"]`);if(q&&q.value!==$.value)$.value=q.value,$.dispatchEvent(new Event("input",{bubbles:!0}))}}})}recalculate(){document.querySelectorAll("[data-formula]").forEach(($)=>{let H=$.dataset.formula;if(!H)return;let Q=$.closest("tr"),X=$.closest("table"),q=(Y)=>{let U=0,G="none";if(Q){let L=`[data-base-key="${Y}"], [data-json-path="${Y}"]`,J=Q.querySelector(L);if(J){if(G="row-input",J.value!=="")U=parseFloat(J.value)}}if(G==="none"){let L=document.querySelector(`[data-json-path="${Y}"]`);if(L){if(G="static-input",L.value!=="")U=parseFloat(L.value)}}return U},Z=H.replace(/SUM\(([a-zA-Z0-9_\-\u0080-\uFFFF]+)\)/g,(Y,U)=>{let G=0,L=X||document,J=L.querySelectorAll(`[data-base-key="${U}"], [data-json-path="${U}"]`);if(J.length===0&&L!==document)J=document.querySelectorAll(`[data-base-key="${U}"], [data-json-path="${U}"]`);return J.forEach((N)=>{let M=parseFloat(N.value);if(!isNaN(M))G+=M}),G});Z=Z.replace(/([a-zA-Z_\u0080-\uFFFF][a-zA-Z0-9_\-\u0080-\uFFFF]*)/g,(Y)=>{if(["Math","round","floor","ceil","abs","min","max"].includes(Y))return Y;return String(q(Y))});try{let Y=new Function("return "+Z)();if(typeof Y==="number"&&!isNaN(Y))$.value=Number.isInteger(Y)?Y:Y.toFixed(0);else $.value=""}catch(Y){console.error("Calc Error:",Y),$.value="Err"}}),this.runAutoCopy()}}var D$=H8(X8(),1);var R8;try{R8=new TextDecoder}catch($){}var E,P0,z=0;var A4=[],QH=105,XH=57342,qH=57343,O4=57337;var K4=6,E0={},k0=112810000,O0=16810000;var E8=A4,V8=0,y={},n,Z8,U8=0,y0=0,t,q0,a=[],j8=[],Q0,H0,b0,z4={useRecords:!1,mapsAsObjects:!0},m0=!1,P4=2;try{new Function("")}catch($){P4=1/0}class K0{constructor($){if($){if(($.keyMap||$._keyMap)&&!$.useRecords)$.useRecords=!1,$.mapsAsObjects=!0;if($.useRecords===!1&&$.mapsAsObjects===void 0)$.mapsAsObjects=!0;if($.getStructures)$.getShared=$.getStructures;if($.getShared&&!$.structures)($.structures=[]).uninitialized=!0;if($.keyMap){this.mapKey=new Map;for(let[H,Q]of Object.entries($.keyMap))this.mapKey.set(Q,H)}}Object.assign(this,$)}decodeKey($){return this.keyMap?this.mapKey.get($)||$:$}encodeKey($){return this.keyMap&&this.keyMap.hasOwnProperty($)?this.keyMap[$]:$}encodeKeys($){if(!this._keyMap)return $;let H=new Map;for(let[Q,X]of Object.entries($))H.set(this._keyMap.hasOwnProperty(Q)?this._keyMap[Q]:Q,X);return H}decodeKeys($){if(!this._keyMap||$.constructor.name!="Map")return $;if(!this._mapKey){this._mapKey=new Map;for(let[Q,X]of Object.entries(this._keyMap))this._mapKey.set(X,Q)}let H={};return $.forEach((Q,X)=>H[Y0(this._mapKey.has(X)?this._mapKey.get(X):X)]=Q),H}mapDecode($,H){let Q=this.decode($);if(this._keyMap)switch(Q.constructor.name){case"Array":return Q.map((X)=>this.decodeKeys(X))}return Q}decode($,H){if(E)return R4(()=>{return J8(),this?this.decode($,H):K0.prototype.decode.call(z4,$,H)});P0=H>-1?H:$.length,z=0,V8=0,y0=0,Z8=null,E8=A4,t=null,E=$;try{H0=$.dataView||($.dataView=new DataView($.buffer,$.byteOffset,$.byteLength))}catch(Q){if(E=null,$ instanceof Uint8Array)throw Q;throw new Error("Source must be a Uint8Array or Buffer but was a "+($&&typeof $=="object"?$.constructor.name:typeof $))}if(this instanceof K0){if(y=this,Q0=this.sharedValues&&(this.pack?new Array(this.maxPrivatePackedValues||16).concat(this.sharedValues):this.sharedValues),this.structures)return n=this.structures,q8();else if(!n||n.length>0)n=[]}else{if(y=z4,!n||n.length>0)n=[];Q0=null}return q8()}decodeMultiple($,H){let Q,X=0;try{let q=$.length;m0=!0;let Z=this?this.decode($,q):S8.decode($,q);if(H){if(H(Z)===!1)return;while(z<q)if(X=z,H(q8())===!1)return}else{Q=[Z];while(z<q)X=z,Q.push(q8());return Q}}catch(q){throw q.lastPosition=X,q.values=Q,q}finally{m0=!1,J8()}}}function q8(){try{let $=m();if(t){if(z>=t.postBundlePosition){let H=new Error("Unexpected bundle position");throw H.incomplete=!0,H}z=t.postBundlePosition,t=null}if(z==P0){if(n=null,E=null,q0)q0=null}else if(z>P0){let H=new Error("Unexpected end of CBOR data");throw H.incomplete=!0,H}else if(!m0)throw new Error("Data read, but end of buffer not reached");return $}catch($){if(J8(),$ instanceof RangeError||$.message.startsWith("Unexpected end of buffer"))$.incomplete=!0;throw $}}function m(){let $=E[z++],H=$>>5;if($=$&31,$>23)switch($){case 24:$=E[z++];break;case 25:if(H==7)return JH();$=H0.getUint16(z),z+=2;break;case 26:if(H==7){let Q=H0.getFloat32(z);if(y.useFloat32>2){let X=G8[(E[z]&127)<<1|E[z+1]>>7];return z+=4,(X*Q+(Q>0?0.5:-0.5)>>0)/X}return z+=4,Q}$=H0.getUint32(z),z+=4;break;case 27:if(H==7){let Q=H0.getFloat64(z);return z+=8,Q}if(H>1){if(H0.getUint32(z)>0)throw new Error("JavaScript does not support arrays, maps, or strings with length over 4294967295");$=H0.getUint32(z+4)}else if(y.int64AsNumber)$=H0.getUint32(z)*4294967296,$+=H0.getUint32(z+4);else $=H0.getBigUint64(z);z+=8;break;case 31:switch(H){case 2:case 3:throw new Error("Indefinite length not supported for byte or text strings");case 4:let Q=[],X,q=0;while((X=m())!=E0){if(q>=k0)throw new Error(`Array length exceeds ${k0}`);Q[q++]=X}return H==4?Q:H==3?Q.join(""):Buffer.concat(Q);case 5:let Z;if(y.mapsAsObjects){let Y={},U=0;if(y.keyMap)while((Z=m())!=E0){if(U++>=O0)throw new Error(`Property count exceeds ${O0}`);Y[Y0(y.decodeKey(Z))]=m()}else while((Z=m())!=E0){if(U++>=O0)throw new Error(`Property count exceeds ${O0}`);Y[Y0(Z)]=m()}return Y}else{if(b0)y.mapsAsObjects=!0,b0=!1;let Y=new Map;if(y.keyMap){let U=0;while((Z=m())!=E0){if(U++>=O0)throw new Error(`Map size exceeds ${O0}`);Y.set(y.decodeKey(Z),m())}}else{let U=0;while((Z=m())!=E0){if(U++>=O0)throw new Error(`Map size exceeds ${O0}`);Y.set(Z,m())}}return Y}case 7:return E0;default:throw new Error("Invalid major type for indefinite length "+H)}default:throw new Error("Unknown token "+$)}switch(H){case 0:return $;case 1:return~$;case 2:return UH($);case 3:if(y0>=z)return Z8.slice(z-U8,(z+=$)-U8);if(y0==0&&P0<140&&$<32){let q=$<16?F4($):ZH($);if(q!=null)return q}return YH($);case 4:if($>=k0)throw new Error(`Array length exceeds ${k0}`);let Q=new Array($);for(let q=0;q<$;q++)Q[q]=m();return Q;case 5:if($>=O0)throw new Error(`Map size exceeds ${k0}`);if(y.mapsAsObjects){let q={};if(y.keyMap)for(let Z=0;Z<$;Z++)q[Y0(y.decodeKey(m()))]=m();else for(let Z=0;Z<$;Z++)q[Y0(m())]=m();return q}else{if(b0)y.mapsAsObjects=!0,b0=!1;let q=new Map;if(y.keyMap)for(let Z=0;Z<$;Z++)q.set(y.decodeKey(m()),m());else for(let Z=0;Z<$;Z++)q.set(m(),m());return q}case 6:if($>=O4){let q=n[$&8191];if(q){if(!q.read)q.read=I8(q);return q.read()}if($<65536){if($==qH){let Z=j0(),Y=m(),U=m();T8(Y,U);let G={};if(y.keyMap)for(let L=2;L<Z;L++){let J=y.decodeKey(U[L-2]);G[Y0(J)]=m()}else for(let L=2;L<Z;L++){let J=U[L-2];G[Y0(J)]=m()}return G}else if($==XH){let Z=j0(),Y=m();for(let U=2;U<Z;U++)T8(Y++,m());return m()}else if($==O4)return CH();if(y.getShared){if(f8(),q=n[$&8191],q){if(!q.read)q.read=I8(q);return q.read()}}}}let X=a[$];if(X)if(X.handlesRead)return X(m);else return X(m());else{let q=m();for(let Z=0;Z<j8.length;Z++){let Y=j8[Z]($,q);if(Y!==void 0)return Y}return new G0(q,$)}case 7:switch($){case 20:return!1;case 21:return!0;case 22:return null;case 23:return;case 31:default:let q=(Q0||A0())[$];if(q!==void 0)return q;throw new Error("Unknown token "+$)}default:if(isNaN($)){let q=new Error("Unexpected end of CBOR data");throw q.incomplete=!0,q}throw new Error("Unknown CBOR token "+$)}}var D4=/^[a-zA-Z_$][a-zA-Z\d_$]*$/;function I8($){if(!$)throw new Error("Structure is required in record definition");function H(){let Q=E[z++];if(Q=Q&31,Q>23)switch(Q){case 24:Q=E[z++];break;case 25:Q=H0.getUint16(z),z+=2;break;case 26:Q=H0.getUint32(z),z+=4;break;default:throw new Error("Expected array header, but got "+E[z-1])}let X=this.compiledReader;while(X){if(X.propertyCount===Q)return X(m);X=X.next}if(this.slowReads++>=P4){let Z=this.length==Q?this:this.slice(0,Q);if(X=y.keyMap?new Function("r","return {"+Z.map((Y)=>y.decodeKey(Y)).map((Y)=>D4.test(Y)?Y0(Y)+":r()":"["+JSON.stringify(Y)+"]:r()").join(",")+"}"):new Function("r","return {"+Z.map((Y)=>D4.test(Y)?Y0(Y)+":r()":"["+JSON.stringify(Y)+"]:r()").join(",")+"}"),this.compiledReader)X.next=this.compiledReader;return X.propertyCount=Q,this.compiledReader=X,X(m)}let q={};if(y.keyMap)for(let Z=0;Z<Q;Z++)q[Y0(y.decodeKey(this[Z]))]=m();else for(let Z=0;Z<Q;Z++)q[Y0(this[Z])]=m();return q}return $.slowReads=0,H}function Y0($){if(typeof $==="string")return $==="__proto__"?"__proto_":$;if(typeof $==="number"||typeof $==="boolean"||typeof $==="bigint")return $.toString();if($==null)return $+"";throw new Error("Invalid property name type "+typeof $)}var YH=w8;function w8($){let H;if($<16){if(H=F4($))return H}if($>64&&R8)return R8.decode(E.subarray(z,z+=$));let Q=z+$,X=[];H="";while(z<Q){let q=E[z++];if((q&128)===0)X.push(q);else if((q&224)===192){let Z=E[z++]&63;X.push((q&31)<<6|Z)}else if((q&240)===224){let Z=E[z++]&63,Y=E[z++]&63;X.push((q&31)<<12|Z<<6|Y)}else if((q&248)===240){let Z=E[z++]&63,Y=E[z++]&63,U=E[z++]&63,G=(q&7)<<18|Z<<12|Y<<6|U;if(G>65535)G-=65536,X.push(G>>>10&1023|55296),G=56320|G&1023;X.push(G)}else X.push(q);if(X.length>=4096)H+=$0.apply(String,X),X.length=0}if(X.length>0)H+=$0.apply(String,X);return H}var $0=String.fromCharCode;function ZH($){let H=z,Q=new Array($);for(let X=0;X<$;X++){let q=E[z++];if((q&128)>0){z=H;return}Q[X]=q}return $0.apply(String,Q)}function F4($){if($<4)if($<2)if($===0)return"";else{let H=E[z++];if((H&128)>1){z-=1;return}return $0(H)}else{let H=E[z++],Q=E[z++];if((H&128)>0||(Q&128)>0){z-=2;return}if($<3)return $0(H,Q);let X=E[z++];if((X&128)>0){z-=3;return}return $0(H,Q,X)}else{let H=E[z++],Q=E[z++],X=E[z++],q=E[z++];if((H&128)>0||(Q&128)>0||(X&128)>0||(q&128)>0){z-=4;return}if($<6)if($===4)return $0(H,Q,X,q);else{let Z=E[z++];if((Z&128)>0){z-=5;return}return $0(H,Q,X,q,Z)}else if($<8){let Z=E[z++],Y=E[z++];if((Z&128)>0||(Y&128)>0){z-=6;return}if($<7)return $0(H,Q,X,q,Z,Y);let U=E[z++];if((U&128)>0){z-=7;return}return $0(H,Q,X,q,Z,Y,U)}else{let Z=E[z++],Y=E[z++],U=E[z++],G=E[z++];if((Z&128)>0||(Y&128)>0||(U&128)>0||(G&128)>0){z-=8;return}if($<10)if($===8)return $0(H,Q,X,q,Z,Y,U,G);else{let L=E[z++];if((L&128)>0){z-=9;return}return $0(H,Q,X,q,Z,Y,U,G,L)}else if($<12){let L=E[z++],J=E[z++];if((L&128)>0||(J&128)>0){z-=10;return}if($<11)return $0(H,Q,X,q,Z,Y,U,G,L,J);let N=E[z++];if((N&128)>0){z-=11;return}return $0(H,Q,X,q,Z,Y,U,G,L,J,N)}else{let L=E[z++],J=E[z++],N=E[z++],M=E[z++];if((L&128)>0||(J&128)>0||(N&128)>0||(M&128)>0){z-=12;return}if($<14)if($===12)return $0(H,Q,X,q,Z,Y,U,G,L,J,N,M);else{let K=E[z++];if((K&128)>0){z-=13;return}return $0(H,Q,X,q,Z,Y,U,G,L,J,N,M,K)}else{let K=E[z++],R=E[z++];if((K&128)>0||(R&128)>0){z-=14;return}if($<15)return $0(H,Q,X,q,Z,Y,U,G,L,J,N,M,K,R);let x=E[z++];if((x&128)>0){z-=15;return}return $0(H,Q,X,q,Z,Y,U,G,L,J,N,M,K,R,x)}}}}}function UH($){return y.copyBuffers?Uint8Array.prototype.slice.call(E,z,z+=$):E.subarray(z,z+=$)}var W4=new Float32Array(1),Y8=new Uint8Array(W4.buffer,0,4);function JH(){let $=E[z++],H=E[z++],Q=($&127)>>2;if(Q===31){if(H||$&3)return NaN;return $&128?-1/0:1/0}if(Q===0){let X=(($&3)<<8|H)/16777216;return $&128?-X:X}return Y8[3]=$&128|(Q>>1)+56,Y8[2]=($&7)<<5|H>>3,Y8[1]=H<<5,Y8[0]=0,W4[0]}var YX=new Array(4096);class G0{constructor($,H){this.value=$,this.tag=H}}a[0]=($)=>{return new Date($)};a[1]=($)=>{return new Date(Math.round($*1000))};a[2]=($)=>{let H=BigInt(0);for(let Q=0,X=$.byteLength;Q<X;Q++)H=BigInt($[Q])+(H<<BigInt(8));return H};a[3]=($)=>{return BigInt(-1)-a[2]($)};a[4]=($)=>{return+($[1]+"e"+$[0])};a[5]=($)=>{return $[1]*Math.exp($[0]*Math.log(2))};var T8=($,H)=>{$=$-57344;let Q=n[$];if(Q&&Q.isShared)(n.restoreStructures||(n.restoreStructures=[]))[$]=Q;n[$]=H,H.read=I8(H)};a[QH]=($)=>{let H=$.length,Q=$[1];T8($[0],Q);let X={};for(let q=2;q<H;q++){let Z=Q[q-2];X[Y0(Z)]=$[q]}return X};a[14]=($)=>{if(t)return t[0].slice(t.position0,t.position0+=$);return new G0($,14)};a[15]=($)=>{if(t)return t[1].slice(t.position1,t.position1+=$);return new G0($,15)};var GH={Error,RegExp};a[27]=($)=>{return(GH[$[0]]||Error)($[1],$[2])};var x4=($)=>{if(E[z++]!=132){let Q=new Error("Packed values structure must be followed by a 4 element array");if(E.length<z)Q.incomplete=!0;throw Q}let H=$();if(!H||!H.length){let Q=new Error("Packed values structure must be followed by a 4 element array");throw Q.incomplete=!0,Q}return Q0=Q0?H.concat(Q0.slice(H.length)):H,Q0.prefixes=$(),Q0.suffixes=$(),$()};x4.handlesRead=!0;a[51]=x4;a[K4]=($)=>{if(!Q0)if(y.getShared)f8();else return new G0($,K4);if(typeof $=="number")return Q0[16+($>=0?2*$:-2*$-1)];let H=new Error("No support for non-integer packed references yet");if($===void 0)H.incomplete=!0;throw H};a[28]=($)=>{if(!q0)q0=new Map,q0.id=0;let H=q0.id++,Q=z,X=E[z],q;if(X>>5==4)q=[];else q={};let Z={target:q};q0.set(H,Z);let Y=$();if(Z.used){if(Object.getPrototypeOf(q)!==Object.getPrototypeOf(Y))z=Q,q=Y,q0.set(H,{target:q}),Y=$();return Object.assign(q,Y)}return Z.target=Y,Y};a[28].handlesRead=!0;a[29]=($)=>{let H=q0.get($);return H.used=!0,H.target};a[258]=($)=>new Set($);(a[259]=($)=>{if(y.mapsAsObjects)y.mapsAsObjects=!1,b0=!0;return $()}).handlesRead=!0;function V0($,H){if(typeof $==="string")return $+H;if($ instanceof Array)return $.concat(H);return Object.assign({},$,H)}function A0(){if(!Q0)if(y.getShared)f8();else throw new Error("No packed values available");return Q0}var LH=1399353956;j8.push(($,H)=>{if($>=225&&$<=255)return V0(A0().prefixes[$-224],H);if($>=28704&&$<=32767)return V0(A0().prefixes[$-28672],H);if($>=1879052288&&$<=2147483647)return V0(A0().prefixes[$-1879048192],H);if($>=216&&$<=223)return V0(H,A0().suffixes[$-216]);if($>=27647&&$<=28671)return V0(H,A0().suffixes[$-27639]);if($>=1811940352&&$<=1879048191)return V0(H,A0().suffixes[$-1811939328]);if($==LH)return{packedValues:Q0,structures:n.slice(0),version:H};if($==55799)return H});var BH=new Uint8Array(new Uint16Array([1]).buffer)[0]==1,_8=[Uint8Array,Uint8ClampedArray,Uint16Array,Uint32Array,typeof BigUint64Array=="undefined"?{name:"BigUint64Array"}:BigUint64Array,Int8Array,Int16Array,Int32Array,typeof BigInt64Array=="undefined"?{name:"BigInt64Array"}:BigInt64Array,Float32Array,Float64Array],NH=[64,68,69,70,71,72,77,78,79,85,86];for(let $=0;$<_8.length;$++)MH(_8[$],NH[$]);function MH($,H){let Q="get"+$.name.slice(0,-5),X;if(typeof $==="function")X=$.BYTES_PER_ELEMENT;else $=null;for(let q=0;q<2;q++){if(!q&&X==1)continue;let Z=X==2?1:X==4?2:X==8?3:0;a[q?H:H-4]=X==1||q==BH?(Y)=>{if(!$)throw new Error("Could not find typed array for code "+H);if(!y.copyBuffers){if(X===1||X===2&&!(Y.byteOffset&1)||X===4&&!(Y.byteOffset&3)||X===8&&!(Y.byteOffset&7))return new $(Y.buffer,Y.byteOffset,Y.byteLength>>Z)}return new $(Uint8Array.prototype.slice.call(Y,0).buffer)}:(Y)=>{if(!$)throw new Error("Could not find typed array for code "+H);let U=new DataView(Y.buffer,Y.byteOffset,Y.byteLength),G=Y.length>>Z,L=new $(G),J=U[Q];for(let N=0;N<G;N++)L[N]=J.call(U,N<<Z,q);return L}}}function CH(){let $=j0(),H=z+m();for(let X=2;X<$;X++){let q=j0();z+=q}let Q=z;return z=H,t=[w8(j0()),w8(j0())],t.position0=0,t.position1=0,t.postBundlePosition=z,z=Q,m()}function j0(){let $=E[z++]&31;if($>23)switch($){case 24:$=E[z++];break;case 25:$=H0.getUint16(z),z+=2;break;case 26:$=H0.getUint32(z),z+=4;break}return $}function f8(){if(y.getShared){let $=R4(()=>{return E=null,y.getShared()})||{},H=$.structures||[];if(y.sharedVersion=$.version,Q0=y.sharedValues=$.packedValues,n===!0)y.structures=n=H;else n.splice.apply(n,[0,H.length].concat(H))}}function R4($){let H=P0,Q=z,X=V8,q=U8,Z=y0,Y=Z8,U=E8,G=q0,L=t,J=new Uint8Array(E.slice(0,P0)),N=n,M=y,K=m0,R=$();return P0=H,z=Q,V8=X,U8=q,y0=Z,Z8=Y,E8=U,q0=G,t=L,E=J,m0=K,n=N,y=M,H0=new DataView(E.buffer,E.byteOffset,E.byteLength),R}function J8(){E=null,q0=null,n=null}var G8=new Array(147);for(let $=0;$<256;$++)G8[$]=+("1e"+Math.floor(45.15-$*0.30103));var S8=new K0({useRecords:!1}),L8=S8.decode,OH=S8.decodeMultiple;var B8;try{B8=new TextEncoder}catch($){}var y8,_4,M8=typeof globalThis==="object"&&globalThis.Buffer,g0=typeof M8!=="undefined",v8=g0?M8.allocUnsafeSlow:Uint8Array,E4=g0?M8:Uint8Array,V4=256,j4=g0?4294967296:2144337920;var h8,C,l,B=0,z0,r=null,KH=61440,zH=/[\u0080-\uFFFF]/,X0=Symbol("record-id");class C8 extends K0{constructor($){super($);this.offset=0;let H,Q,X,q,Z,Y;$=$||{};let U=E4.prototype.utf8Write?function(O,V,A){return C.utf8Write(O,V,A)}:B8&&B8.encodeInto?function(O,V){return B8.encodeInto(O,C.subarray(V)).written}:!1,G=this,L=$.structures||$.saveStructures,J=$.maxSharedStructures;if(J==null)J=L?128:0;if(J>8190)throw new Error("Maximum maxSharedStructure is 8190");let N=$.sequential;if(N)J=0;if(!this.structures)this.structures=[];if(this.saveStructures)this.saveShared=this.saveStructures;let M,K,R=$.sharedValues,x;if(R){x=Object.create(null);for(let O=0,V=R.length;O<V;O++)x[R[O]]=O}let j=[],g=0,u=0;this.mapEncode=function(O,V){if(this._keyMap&&!this._mapped)switch(O.constructor.name){case"Array":O=O.map((A)=>this.encodeKeys(A));break}return this.encode(O,V)},this.encode=function(O,V){if(!C)C=new v8(8192),l=new DataView(C.buffer,0,8192),B=0;if(z0=C.length-10,z0-B<2048)C=new v8(C.length),l=new DataView(C.buffer,0,C.length),z0=C.length-10,B=0;else if(V===g8)B=B+7&2147483640;if(Q=B,G.useSelfDescribedHeader)l.setUint32(B,3654940416),B+=3;if(Y=G.structuredClone?new Map:null,G.bundleStrings&&typeof O!=="string")r=[],r.size=1/0;else r=null;if(X=G.structures,X){if(X.uninitialized){let P=G.getShared()||{};G.structures=X=P.structures||[],G.sharedVersion=P.version;let W=G.sharedValues=P.packedValues;if(W){x={};for(let I=0,v=W.length;I<v;I++)x[W[I]]=I}}let A=X.length;if(A>J&&!N)A=J;if(!X.transitions){X.transitions=Object.create(null);for(let P=0;P<A;P++){let W=X[P];if(!W)continue;let I,v=X.transitions;for(let h=0,b=W.length;h<b;h++){if(v[X0]===void 0)v[X0]=P;let c=W[h];if(I=v[c],!I)I=v[c]=Object.create(null);v=I}v[X0]=P|1048576}}if(!N)X.nextId=A}if(q)q=!1;if(Z=X||[],K=x,$.pack){let A=new Map;if(A.values=[],A.encoder=G,A.maxValues=$.maxPrivatePackedValues||(x?16:1/0),A.objectMap=x||!1,A.samplingPackedValues=M,N8(O,A),A.values.length>0){C[B++]=216,C[B++]=51,B0(4);let P=A.values;F(P),B0(0),B0(0),K=Object.create(x||null);for(let W=0,I=P.length;W<I;W++)K[P[W]]=W}}h8=V&b8;try{if(h8)return;if(F(O),r)w4(Q,F);if(G.offset=B,Y&&Y.idsToInsert){if(B+=Y.idsToInsert.length*2,B>z0)f(B);G.offset=B;let A=PH(C.subarray(Q,B),Y.idsToInsert);return Y=null,A}if(V&g8)return C.start=Q,C.end=B,C;return C.subarray(Q,B)}finally{if(X){if(u<10)u++;if(X.length>J)X.length=J;if(g>1e4){if(X.transitions=null,u=0,g=0,j.length>0)j=[]}else if(j.length>0&&!N){for(let A=0,P=j.length;A<P;A++)j[A][X0]=void 0;j=[]}}if(q&&G.saveShared){if(G.structures.length>J)G.structures=G.structures.slice(0,J);let A=C.subarray(Q,B);if(G.updateSharedData()===!1)return G.encode(O);return A}if(V&RH)B=Q}},this.findCommonStringsToPack=()=>{if(M=new Map,!x)x=Object.create(null);return(O)=>{let V=O&&O.threshold||4,A=this.pack?O.maxPrivatePackedValues||16:0;if(!R)R=this.sharedValues=[];for(let[P,W]of M)if(W.count>V)x[P]=A++,R.push(P),q=!0;while(this.saveShared&&this.updateSharedData()===!1);M=null}};let F=(O)=>{if(B>z0)C=f(B);var V=typeof O,A;if(V==="string"){if(K){let v=K[O];if(v>=0){if(v<16)C[B++]=v+224;else if(C[B++]=198,v&1)F(15-v>>1);else F(v-16>>1);return}else if(M&&!$.pack){let h=M.get(O);if(h)h.count++;else M.set(O,{count:1})}}let P=O.length;if(r&&P>=4&&P<1024){if((r.size+=P)>KH){let h,b=(r[0]?r[0].length*3+r[1].length:0)+10;if(B+b>z0)C=f(B+b);if(C[B++]=217,C[B++]=223,C[B++]=249,C[B++]=r.position?132:130,C[B++]=26,h=B-Q,B+=4,r.position)w4(Q,F);r=["",""],r.size=0,r.position=h}let v=zH.test(O);r[v?0:1]+=O,C[B++]=v?206:207,F(P);return}let W;if(P<32)W=1;else if(P<256)W=2;else if(P<65536)W=3;else W=5;let I=P*3;if(B+I>z0)C=f(B+I);if(P<64||!U){let v,h,b,c=B+W;for(v=0;v<P;v++)if(h=O.charCodeAt(v),h<128)C[c++]=h;else if(h<2048)C[c++]=h>>6|192,C[c++]=h&63|128;else if((h&64512)===55296&&((b=O.charCodeAt(v+1))&64512)===56320)h=65536+((h&1023)<<10)+(b&1023),v++,C[c++]=h>>18|240,C[c++]=h>>12&63|128,C[c++]=h>>6&63|128,C[c++]=h&63|128;else C[c++]=h>>12|224,C[c++]=h>>6&63|128,C[c++]=h&63|128;A=c-B-W}else A=U(O,B+W,I);if(A<24)C[B++]=96|A;else if(A<256){if(W<2)C.copyWithin(B+2,B+1,B+1+A);C[B++]=120,C[B++]=A}else if(A<65536){if(W<3)C.copyWithin(B+3,B+2,B+2+A);C[B++]=121,C[B++]=A>>8,C[B++]=A&255}else{if(W<5)C.copyWithin(B+5,B+3,B+3+A);C[B++]=122,l.setUint32(B,A),B+=4}B+=A}else if(V==="number")if(!this.alwaysUseFloat&&O>>>0===O)if(O<24)C[B++]=O;else if(O<256)C[B++]=24,C[B++]=O;else if(O<65536)C[B++]=25,C[B++]=O>>8,C[B++]=O&255;else C[B++]=26,l.setUint32(B,O),B+=4;else if(!this.alwaysUseFloat&&O>>0===O)if(O>=-24)C[B++]=31-O;else if(O>=-256)C[B++]=56,C[B++]=~O;else if(O>=-65536)C[B++]=57,l.setUint16(B,~O),B+=2;else C[B++]=58,l.setUint32(B,~O),B+=4;else{let P;if((P=this.useFloat32)>0&&O<4294967296&&O>=-2147483648){C[B++]=250,l.setFloat32(B,O);let W;if(P<4||(W=O*G8[(C[B]&127)<<1|C[B+1]>>7])>>0===W){B+=4;return}else B--}C[B++]=251,l.setFloat64(B,O),B+=8}else if(V==="object")if(!O)C[B++]=246;else{if(Y){let W=Y.get(O);if(W){if(C[B++]=216,C[B++]=29,C[B++]=25,!W.references){let I=Y.idsToInsert||(Y.idsToInsert=[]);W.references=[],I.push(W)}W.references.push(B-Q),B+=2;return}else Y.set(O,{offset:B-Q})}let P=O.constructor;if(P===Object)w(O);else if(P===Array){if(A=O.length,A<24)C[B++]=128|A;else B0(A);for(let W=0;W<A;W++)F(O[W])}else if(P===Map){if(this.mapsAsObjects?this.useTag259ForMaps!==!1:this.useTag259ForMaps)C[B++]=217,C[B++]=1,C[B++]=3;if(A=O.size,A<24)C[B++]=160|A;else if(A<256)C[B++]=184,C[B++]=A;else if(A<65536)C[B++]=185,C[B++]=A>>8,C[B++]=A&255;else C[B++]=186,l.setUint32(B,A),B+=4;if(G.keyMap)for(let[W,I]of O)F(G.encodeKey(W)),F(I);else for(let[W,I]of O)F(W),F(I)}else{for(let W=0,I=y8.length;W<I;W++){let v=_4[W];if(O instanceof v){let h=y8[W],b=h.tag;if(b==null)b=h.getTag&&h.getTag.call(this,O);if(b<24)C[B++]=192|b;else if(b<256)C[B++]=216,C[B++]=b;else if(b<65536)C[B++]=217,C[B++]=b>>8,C[B++]=b&255;else if(b>-1)C[B++]=218,l.setUint32(B,b),B+=4;h.encode.call(this,O,F,f);return}}if(O[Symbol.iterator]){if(h8){let W=new Error("Iterable should be serialized as iterator");throw W.iteratorNotHandled=!0,W}C[B++]=159;for(let W of O)F(W);C[B++]=255;return}if(O[Symbol.asyncIterator]||k8(O)){let W=new Error("Iterable/blob should be serialized as iterator");throw W.iteratorNotHandled=!0,W}if(this.useToJSON&&O.toJSON){let W=O.toJSON();if(W!==O)return F(W)}w(O)}}else if(V==="boolean")C[B++]=O?245:244;else if(V==="bigint"){if(O<BigInt(1)<<BigInt(64)&&O>=0)C[B++]=27,l.setBigUint64(B,O);else if(O>-(BigInt(1)<<BigInt(64))&&O<0)C[B++]=59,l.setBigUint64(B,-O-BigInt(1));else if(this.largeBigIntToFloat)C[B++]=251,l.setFloat64(B,Number(O));else{if(O>=BigInt(0))C[B++]=194;else C[B++]=195,O=BigInt(-1)-O;let P=[];while(O)P.push(Number(O&BigInt(255))),O>>=BigInt(8);m8(new Uint8Array(P.reverse()),f);return}B+=8}else if(V==="undefined")C[B++]=247;else throw new Error("Unknown type: "+V)},w=this.useRecords===!1?this.variableMapSize?(O)=>{let V=Object.keys(O),A=Object.values(O),P=V.length;if(P<24)C[B++]=160|P;else if(P<256)C[B++]=184,C[B++]=P;else if(P<65536)C[B++]=185,C[B++]=P>>8,C[B++]=P&255;else C[B++]=186,l.setUint32(B,P),B+=4;let W;if(G.keyMap)for(let I=0;I<P;I++)F(G.encodeKey(V[I])),F(A[I]);else for(let I=0;I<P;I++)F(V[I]),F(A[I])}:(O)=>{C[B++]=185;let V=B-Q;B+=2;let A=0;if(G.keyMap){for(let P in O)if(typeof O.hasOwnProperty!=="function"||O.hasOwnProperty(P))F(G.encodeKey(P)),F(O[P]),A++}else for(let P in O)if(typeof O.hasOwnProperty!=="function"||O.hasOwnProperty(P))F(P),F(O[P]),A++;C[V+++Q]=A>>8,C[V+Q]=A&255}:(O,V)=>{let A,P=Z.transitions||(Z.transitions=Object.create(null)),W=0,I=0,v,h;if(this.keyMap){h=Object.keys(O).map((c)=>this.encodeKey(c)),I=h.length;for(let c=0;c<I;c++){let M4=h[c];if(A=P[M4],!A)A=P[M4]=Object.create(null),W++;P=A}}else for(let c in O)if(typeof O.hasOwnProperty!=="function"||O.hasOwnProperty(c)){if(A=P[c],!A){if(P[X0]&1048576)v=P[X0]&65535;A=P[c]=Object.create(null),W++}P=A,I++}let b=P[X0];if(b!==void 0)b&=65535,C[B++]=217,C[B++]=b>>8|224,C[B++]=b&255;else{if(!h)h=P.__keys__||(P.__keys__=Object.keys(O));if(v===void 0){if(b=Z.nextId++,!b)b=0,Z.nextId=1;if(b>=V4)Z.nextId=(b=J)+1}else b=v;if(Z[b]=h,b<J){C[B++]=217,C[B++]=b>>8|224,C[B++]=b&255,P=Z.transitions;for(let c=0;c<I;c++){if(P[X0]===void 0||P[X0]&1048576)P[X0]=b;P=P[h[c]]}P[X0]=b|1048576,q=!0}else{if(P[X0]=b,l.setUint32(B,3655335680),B+=3,W)g+=u*W;if(j.length>=V4-J)j.shift()[X0]=void 0;if(j.push(P),B0(I+2),F(57344+b),F(h),V)return;for(let c in O)if(typeof O.hasOwnProperty!=="function"||O.hasOwnProperty(c))F(O[c]);return}}if(I<24)C[B++]=128|I;else B0(I);if(V)return;for(let c in O)if(typeof O.hasOwnProperty!=="function"||O.hasOwnProperty(c))F(O[c])},f=(O)=>{let V;if(O>16777216){if(O-Q>j4)throw new Error("Encoded buffer would be larger than maximum buffer size");V=Math.min(j4,Math.round(Math.max((O-Q)*(O>67108864?1.25:2),4194304)/4096)*4096)}else V=(Math.max(O-Q<<2,C.length-1)>>12)+1<<12;let A=new v8(V);if(l=new DataView(A.buffer,0,V),C.copy)C.copy(A,0,Q,O);else A.set(C.slice(Q,O));return B-=Q,Q=0,z0=A.length-10,C=A},S=100,T=1000;this.encodeAsIterable=function(O,V){return R0(O,V,o)},this.encodeAsAsyncIterable=function(O,V){return R0(O,V,N4)};function*o(O,V,A){let P=O.constructor;if(P===Object){let W=G.useRecords!==!1;if(W)w(O,!0);else I4(Object.keys(O).length,160);for(let I in O){let v=O[I];if(!W)F(I);if(v&&typeof v==="object")if(V[I])yield*o(v,V[I]);else yield*d(v,V,I);else F(v)}}else if(P===Array){let W=O.length;B0(W);for(let I=0;I<W;I++){let v=O[I];if(v&&(typeof v==="object"||B-Q>S))if(V.element)yield*o(v,V.element);else yield*d(v,V,"element");else F(v)}}else if(O[Symbol.iterator]&&!O.buffer){C[B++]=159;for(let W of O)if(W&&(typeof W==="object"||B-Q>S))if(V.element)yield*o(W,V.element);else yield*d(W,V,"element");else F(W);C[B++]=255}else if(k8(O))I4(O.size,64),yield C.subarray(Q,B),yield O,C0();else if(O[Symbol.asyncIterator])C[B++]=159,yield C.subarray(Q,B),yield O,C0(),C[B++]=255;else F(O);if(A&&B>Q)yield C.subarray(Q,B);else if(B-Q>S)yield C.subarray(Q,B),C0()}function*d(O,V,A){let P=B-Q;try{if(F(O),B-Q>S)yield C.subarray(Q,B),C0()}catch(W){if(W.iteratorNotHandled)V[A]={},B=Q+P,yield*o.call(this,O,V[A]);else throw W}}function C0(){S=T,G.encode(null,b8)}function R0(O,V,A){if(V&&V.chunkThreshold)S=T=V.chunkThreshold;else S=100;if(O&&typeof O==="object")return G.encode(null,b8),A(O,G.iterateProperties||(G.iterateProperties={}),!0);return[G.encode(O)]}async function*N4(O,V){for(let A of o(O,V,!0)){let P=A.constructor;if(P===E4||P===Uint8Array)yield A;else if(k8(A)){let W=A.stream().getReader(),I;while(!(I=await W.read()).done)yield I.value}else if(A[Symbol.asyncIterator])for await(let W of A)if(C0(),W)yield*N4(W,V.async||(V.async={}));else yield G.encode(W);else yield A}}}useBuffer($){C=$,l=new DataView(C.buffer,C.byteOffset,C.byteLength),B=0}clearSharedData(){if(this.structures)this.structures=[];if(this.sharedValues)this.sharedValues=void 0}updateSharedData(){let $=this.sharedVersion||0;this.sharedVersion=$+1;let H=this.structures.slice(0),Q=new c8(H,this.sharedValues,this.sharedVersion),X=this.saveShared(Q,(q)=>(q&&q.version||0)==$);if(X===!1)Q=this.getShared()||{},this.structures=Q.structures||[],this.sharedValues=Q.packedValues,this.sharedVersion=Q.version,this.structures.nextId=this.structures.length;else H.forEach((q,Z)=>this.structures[Z]=q);return X}}function I4($,H){if($<24)C[B++]=H|$;else if($<256)C[B++]=H|24,C[B++]=$;else if($<65536)C[B++]=H|25,C[B++]=$>>8,C[B++]=$&255;else C[B++]=H|26,l.setUint32(B,$),B+=4}class c8{constructor($,H,Q){this.structures=$,this.packedValues=H,this.version=Q}}function B0($){if($<24)C[B++]=128|$;else if($<256)C[B++]=152,C[B++]=$;else if($<65536)C[B++]=153,C[B++]=$>>8,C[B++]=$&255;else C[B++]=154,l.setUint32(B,$),B+=4}var DH=typeof Blob==="undefined"?function(){}:Blob;function k8($){if($ instanceof DH)return!0;let H=$[Symbol.toStringTag];return H==="Blob"||H==="File"}function N8($,H){switch(typeof $){case"string":if($.length>3){if(H.objectMap[$]>-1||H.values.length>=H.maxValues)return;let X=H.get($);if(X){if(++X.count==2)H.values.push($)}else if(H.set($,{count:1}),H.samplingPackedValues){let q=H.samplingPackedValues.get($);if(q)q.count++;else H.samplingPackedValues.set($,{count:1})}}break;case"object":if($)if($ instanceof Array)for(let X=0,q=$.length;X<q;X++)N8($[X],H);else{let X=!H.encoder.useRecords;for(var Q in $)if($.hasOwnProperty(Q)){if(X)N8(Q,H);N8($[Q],H)}}break;case"function":console.log($)}}var AH=new Uint8Array(new Uint16Array([1]).buffer)[0]==1;_4=[Date,Set,Error,RegExp,G0,ArrayBuffer,Uint8Array,Uint8ClampedArray,Uint16Array,Uint32Array,typeof BigUint64Array=="undefined"?function(){}:BigUint64Array,Int8Array,Int16Array,Int32Array,typeof BigInt64Array=="undefined"?function(){}:BigInt64Array,Float32Array,Float64Array,c8];y8=[{tag:1,encode($,H){let Q=$.getTime()/1000;if((this.useTimestamp32||$.getMilliseconds()===0)&&Q>=0&&Q<4294967296)C[B++]=26,l.setUint32(B,Q),B+=4;else C[B++]=251,l.setFloat64(B,Q),B+=8}},{tag:258,encode($,H){let Q=Array.from($);H(Q)}},{tag:27,encode($,H){H([$.name,$.message])}},{tag:27,encode($,H){H(["RegExp",$.source,$.flags])}},{getTag($){return $.tag},encode($,H){H($.value)}},{encode($,H,Q){m8($,Q)}},{getTag($){if($.constructor===Uint8Array){if(this.tagUint8Array||g0&&this.tagUint8Array!==!1)return 64}},encode($,H,Q){m8($,Q)}},L0(68,1),L0(69,2),L0(70,4),L0(71,8),L0(72,1),L0(77,2),L0(78,4),L0(79,8),L0(85,4),L0(86,8),{encode($,H){let Q=$.packedValues||[],X=$.structures||[];if(Q.values.length>0){C[B++]=216,C[B++]=51,B0(4);let q=Q.values;H(q),B0(0),B0(0),packedObjectMap=Object.create(sharedPackedObjectMap||null);for(let Z=0,Y=q.length;Z<Y;Z++)packedObjectMap[q[Z]]=Z}if(X){l.setUint32(B,3655335424),B+=3;let q=X.slice(0);q.unshift(57344),q.push(new G0($.version,1399353956)),H(q)}else H(new G0($.version,1399353956))}}];function L0($,H){if(!AH&&H>1)$-=4;return{tag:$,encode:function Q(X,q){let Z=X.byteLength,Y=X.byteOffset||0,U=X.buffer||X;q(g0?M8.from(U,Y,Z):new Uint8Array(U,Y,Z))}}}function m8($,H){let Q=$.byteLength;if(Q<24)C[B++]=64+Q;else if(Q<256)C[B++]=88,C[B++]=Q;else if(Q<65536)C[B++]=89,C[B++]=Q>>8,C[B++]=Q&255;else C[B++]=90,l.setUint32(B,Q),B+=4;if(B+Q>=C.length)H(B+Q);C.set($.buffer?$:new Uint8Array($),B),B+=Q}function PH($,H){let Q,X=H.length*2,q=$.length-X;H.sort((Z,Y)=>Z.offset>Y.offset?1:-1);for(let Z=0;Z<H.length;Z++){let Y=H[Z];Y.id=Z;for(let U of Y.references)$[U++]=Z>>8,$[U]=Z&255}while(Q=H.pop()){let Z=Q.offset;$.copyWithin(Z+X,Z,q),X-=2;let Y=Z+X;$[Y++]=216,$[Y++]=28,q=Z}return $}function w4($,H){l.setUint32(r.position+$,B-r.position-$+1);let Q=r;r=null,H(Q[0]),H(Q[1])}var p8=new C8({useRecords:!1}),FH=p8.encode,WH=p8.encodeAsIterable,xH=p8.encodeAsAsyncIterable;var g8=512,RH=1024,b8=2048;var K$="123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz",KQ="eddsa-jcs-2022",zQ=237,DQ=4608;function t8($){return Array.from($).map((H)=>H.toString(16).padStart(2,"0")).join("")}function z$($){let H=new Uint8Array($.length/2);for(let Q=0;Q<H.length;Q++)H[Q]=parseInt($.substring(Q*2,Q*2+2),16);return H}function AQ($){if($.length===0)return"";let H=[0];for(let q of $){let Z=q;for(let Y=0;Y<H.length;Y++){let U=H[Y]*256+Z;H[Y]=U%58,Z=Math.floor(U/58)}while(Z>0)H.push(Z%58),Z=Math.floor(Z/58)}let Q=0;for(let q of $){if(q!==0)break;Q+=1}let X=K$[0].repeat(Q);for(let q=H.length-1;q>=0;q--)X+=K$[H[q]];return X}function A$($){return`z${AQ($)}`}function PQ($){let H=[],Q=$;while(Q>=128)H.push(Q&127|128),Q>>=7;return H.push(Q),new Uint8Array(H)}function FQ($,H){let X=PQ(H==="p256"?DQ:zQ),q=new Uint8Array(X.length+$.length);return q.set(X,0),q.set($,X.length),`did:key:${A$(q)}`}class P${usePasskey=!0;credentialId=null;publicKey=null;publicKeyType="ed25519";edPrivateKey=null;constructor(){this.loadKey()}loadKey(){if(typeof localStorage==="undefined")return;let $=localStorage.getItem("weba_passkey_id"),H=localStorage.getItem("weba_passkey_pub");if($&&H){this.credentialId=$,this.publicKey=z$(H),this.publicKeyType="p256",this.usePasskey=!0;return}let Q=localStorage.getItem("weba_private_key");if(Q)this.edPrivateKey=z$(Q),this.publicKeyType="ed25519",this.usePasskey=!1}resetKey(){if(typeof localStorage!=="undefined")localStorage.removeItem("weba_passkey_id"),localStorage.removeItem("weba_passkey_pub"),localStorage.removeItem("weba_private_key");this.credentialId=null,this.publicKey=null,this.edPrivateKey=null}async register(){try{let $=prompt("Enter a name for this Passkey:","demo-user")||"User";console.log(`Registering Passkey for ${$}...`);let H=await S4($),Q=new Uint8Array(H.response.attestationObject),q=L8(Q).authData,Z=new DataView(q.buffer,q.byteOffset,q.byteLength),Y=53,U=Z.getUint16(Y);Y+=2,Y+=U;let G=q.slice(Y),L=L8(G),J=L.get(-2),N=L.get(-3);if(!J||!N)throw new Error("Invalid COSE Key: x or y missing");let M=new Uint8Array(65);if(M[0]=4,M.set(J,1),M.set(N,33),this.credentialId=H.rawId,this.publicKey=M,this.publicKeyType="p256",this.usePasskey=!0,typeof localStorage!=="undefined")localStorage.setItem("weba_passkey_id",this.credentialId),localStorage.setItem("weba_passkey_pub",t8(this.publicKey));return console.log("Passkey Registered:",this.credentialId),!0}catch($){return console.warn("Passkey registration failed, falling back to Ed25519",$),this.generateEdKey(),!1}}async generateEdKey(){let{initWasm:$,ed25519GenerateKeyPair:H}=await Promise.resolve().then(() => (_0(),a8));await $(fetch("/assets/weba_crypto_wasm_bg.wasm"));let{privateKey:Q,publicKey:X}=H();if(this.edPrivateKey=Q,this.publicKey=X,this.publicKeyType="ed25519",this.usePasskey=!1,typeof localStorage!=="undefined")localStorage.setItem("weba_private_key",t8(this.edPrivateKey))}getIssuerDid(){if(!this.publicKey)return"";return FQ(this.publicKey,this.publicKeyType)}getPublicKey(){return this.publicKey?t8(this.publicKey):""}async sign($,H="authentication"){if(!this.publicKey)await this.register();let Q=D$.default($),X=new TextEncoder().encode(Q);if(this.usePasskey&&this.credentialId){let q=await crypto.subtle.digest("SHA-256",X),Z=await v4(this.credentialId,q);return{...$,proof:{type:"PasskeySignature2025",created:new Date().toISOString(),verificationMethod:this.getIssuerDid(),proofPurpose:H,proofValue:Z.signature,"srn:authenticatorData":Z.authenticatorData,"srn:clientDataJSON":Z.clientDataJSON,"srn:credentialId":Z.id}}}else{if(!this.edPrivateKey)await this.generateEdKey();let{initWasm:q,ed25519Sign:Z}=await Promise.resolve().then(() => (_0(),a8));await q(fetch("/assets/weba_crypto_wasm_bg.wasm"));let Y=Z(this.edPrivateKey,X);return{...$,proof:{type:"DataIntegrityProof",cryptosuite:KQ,created:new Date().toISOString(),verificationMethod:this.getIssuerDid(),proofPurpose:H,proofValue:A$(Y)}}}}async derivePrf($){if(!this.credentialId)return null;try{return await I0(this.credentialId,$)}catch(H){return console.error("PRF derivation failed",H),null}}}var f0=new P$;function WQ($){$.querySelectorAll("input").forEach((Q)=>{if(Q.type==="checkbox"||Q.type==="radio")Q.checked=!1,Q.removeAttribute("checked");else Q.value="",Q.removeAttribute("value")}),$.querySelectorAll("textarea").forEach((Q)=>{Q.value="",Q.textContent=""}),$.querySelectorAll("select").forEach((Q)=>{Q.selectedIndex=-1,Q.querySelectorAll("option").forEach((X)=>X.removeAttribute("selected"))}),$.getElementById("json-ld")?.remove(),$.getElementById("data-layer")?.remove();let H=$.getElementById("json-debug");if(H)H.textContent=""}function xQ($,H){let Q=JSON.stringify(H,null,2),X=$.createElement("script");X.type="application/ld+json",X.id="weba-user-vc",X.textContent=Q,$.body.appendChild(X);let q=$.createElement("div");q.className="weba-user-verification no-print",q.style.cssText="margin-top:2rem;padding:1rem;border:1px solid #10b981;border-radius:8px;background:#f0fdf4;font-size:0.85rem;",q.innerHTML=`
    <details>
      <summary style="cursor: pointer; display: flex; align-items: center; gap: 0.5rem; color: #047857; font-weight: 600;">
        <span></span> 
      </summary>
      <div style="padding: 1rem 0;">
        <pre style="background: #1e1e1e; color: #d4d4d4; padding: 1rem; border-radius: 6px; overflow-x: auto; font-size: 0.8rem; line-height: 1.4;"></pre>
      </div>
    </details>
  `;let Z=q.querySelector("pre");if(Z)Z.textContent=Q;$.body.appendChild(q)}function RQ($,H){let Q=$.createElement("script");Q.id="weba-l2-envelope",Q.type="application/json",Q.textContent=JSON.stringify(H,null,2),$.body.appendChild(Q)}function EQ($,H){let Q=$.getElementById("weba-draft-state");if(Q)Q.remove();let X=$.createElement("script");X.id="weba-draft-state",X.type="application/json",X.textContent=JSON.stringify(H,null,2),$.body.appendChild(X)}function VQ($,H){let Q=new Date,X=Q.getFullYear()+("0"+(Q.getMonth()+1)).slice(-2)+("0"+Q.getDate()).slice(-2)+"-"+("0"+Q.getHours()).slice(-2)+("0"+Q.getMinutes()).slice(-2),q=Math.random().toString(36).substring(2,8);return`${$}_${X}_${H}_${q}.html`}function jQ($,H){let X=new DOMParser().parseFromString($,"text/html");if(H?.stripPlaintext)WQ(X);if(H?.embeddedVc)xQ(X,H.embeddedVc);if(H?.l2Envelope)RQ(X,H.l2Envelope);if(H?.draftState)EQ(X,H.draftState);return X.documentElement.outerHTML}function F$($){let H=jQ($.documentHtml,$.options),Q=new Blob([H],{type:"text/html"}),X=URL.createObjectURL(Q),q=document.createElement("a");if(q.href=X,q.download=VQ($.title,$.filenameSuffix),q.click(),$.isFinal)setTimeout(()=>window.location.reload(),1000)}class e0{formId;static DRAFT_STATE_VERSION=1;static L2_REPLAY_STORE_KEY="weba_l2_nonces";currentSecurityTier="standard";constructor(){this.formId="WebA_"+window.location.pathname}updateSecurityUI($){this.currentSecurityTier=$;let H=new CustomEvent("weba-security-tier-change",{detail:{tier:$}});window.dispatchEvent(H)}updateJsonLd(){let $={};document.querySelectorAll("[data-json-path]").forEach((X)=>{let q=X.dataset.jsonPath;if(q)if(X.type==="tel")$[q]=X.value.replace(/[^0-9]/g,"");else $[q]=X.value}),document.querySelectorAll('[type="radio"]:checked').forEach((X)=>{$[X.name]=X.value}),document.querySelectorAll("table.data-table.dynamic").forEach((X)=>{let q=X.dataset.tableKey;if(q){let Z=[];X.querySelectorAll("tbody tr").forEach((Y)=>{let U={},G=!1;if(Y.querySelectorAll("[data-base-key]").forEach((L)=>{if(L.type==="checkbox"){if(U[L.dataset.baseKey]=L.checked,L.checked)G=!0}else if(U[L.dataset.baseKey]=L.value,L.value)G=!0}),G)Z.push(U)}),$[q]=Z}});let H=document.getElementById("json-ld");if(H)H.textContent=JSON.stringify($,null,2);let Q=document.getElementById("json-debug");if(Q)Q.textContent=JSON.stringify($,null,2);return $}getL2Config(){return window.webaL2Config||null}async signAndDownload(){let $=this.updateJsonLd(),H=window,Q=H.generatedJsonStructure&&H.generatedJsonStructure.name||"Response",X=window.location.href.split("#")[0],q=this.getL2Config(),Z=document.getElementById("weba-l2-encrypt");if(!!(q?.enabled&&(Z?Z.checked:q.default_enabled))){if(!q?.recipient_kid||!q?.recipient_x25519||!q?.layer1_ref){alert("L2 encryption config is missing required fields.");return}let G={...q},L="offline";if(q.prekey_url)try{let{fetchPreKey:M}=await Promise.resolve().then(() => (v0(),A8)),K=await M(q.prekey_url);if(K){if(console.log("Tier 3 Active: Using dynamic pre-key",K.kid),G.recipient_kid=K.kid,G.recipient_x25519=K.recipient_x25519,K.recipient_pqc)G.recipient_pqc=K.recipient_pqc;L="high"}}catch(M){console.warn("Tier 3 Failed. Falling back to Tier 2.")}if(L==="offline"&&q.epoch_registry_url)try{let{fetchEpochRegistry:M,selectEpochKey:K}=await Promise.resolve().then(() => (v0(),A8)),R=await M(q.epoch_registry_url);if(R){let x=K(R);if(x)console.log("Tier 2 Active: Using epoch key",x.kid),G.recipient_kid=x.kid,G.recipient_x25519=x.publicKey,L="standard"}}catch(M){console.warn("Tier 2 Failed. Falling back to Tier 1.")}if(L==="offline")console.log("Tier 1 Active: Using static master key (Offline Mode)");this.updateSecurityUI(L);let J=q.user_kid,N=document.getElementById("weba-guest-did-opt");if(N&&N.checked)try{let{getOrCreateGuestDid:M}=await Promise.resolve().then(() => (X4(),y$)),{did:K,isReused:R}=await M();J=K,console.log(`Using Guest DID: ${K} (Reused: ${R})`)}catch(M){if(console.error("Guest DID creation failed:",M),!confirm("Failed to create/retrieve Guest DID for replies. Continue with anonymous submission?"))return}try{let{buildLayer2Envelope:M}=await Promise.resolve().then(() => (v0(),A8)),K=await M({layer2_plain:$,config:G,user_kid:J||"anonymous"});this.downloadHtml("submit",!0,{l2Envelope:K,stripPlaintext:!0})}catch(M){console.error(M),alert("L2 encryption failed. Please check your recipient key settings.")}return}if(!f0.getPublicKey()){if(!await f0.register()){alert("Key registration failed.");return}}let U={"@context":["https://www.w3.org/2018/credentials/v1"],type:["VerifiableCredential","WebAFormResponse"],issuer:f0.getIssuerDid(),issuanceDate:new Date().toISOString(),credentialSubject:{id:`urn:uuid:${crypto.randomUUID()}`,type:"WebAFormResponse",templateId:X,answers:$}};try{let G=new Set;document.querySelectorAll("[data-json-path]").forEach((M)=>G.add(M.dataset.jsonPath)),document.querySelectorAll('[type="radio"]').forEach((M)=>G.add(M.name)),document.querySelectorAll("table.data-table.dynamic").forEach((M)=>G.add(M.dataset.tableKey));let L=[],J=U.credentialSubject.answers;for(let M in J)if(!G.has(M)&&!M.startsWith("@")&&M!=="type"&&M!=="templateId"&&M!=="id")L.push(M);if(L.length>0){if(!confirm(`WARNING: HMP Variance Detected.

The following hidden fields will be signed but are not visible in the form UI:
- ${L.join(`
- `)}

Continue signing?`))return}let N=await f0.sign(U);this.downloadHtml("submitted",!0,{embeddedVc:N})}catch(G){console.error(G),alert("Signing failed. Please ensure you are in a secure context (HTTPS/localhost).")}}saveToLS(){let $=this.updateJsonLd();localStorage.setItem(this.formId,JSON.stringify($))}restoreFromLS(){let $=localStorage.getItem(this.formId);if(!$)return;try{let H=JSON.parse($);document.querySelectorAll("[data-json-path]").forEach((Q)=>{let X=Q.dataset.jsonPath;if(H[X]!==void 0)Q.value=H[X]}),document.querySelectorAll("table.data-table.dynamic").forEach((Q)=>{let X=Q.dataset.tableKey,q=H[X];if(Array.isArray(q)){let Z=Q.querySelector("tbody");if(!Z)return;let Y=Z.querySelectorAll(".template-row");q.forEach((U,G)=>{let L;if(G===0)L=Z.querySelector(".template-row");else{let J=Z.querySelector(".template-row");if(J){L=J.cloneNode(!0),L.classList.remove("template-row");let N=L.querySelector(".remove-row-btn");if(N)N.style.visibility="visible";Z.appendChild(L)}}if(L)L.querySelectorAll("input, select").forEach((J)=>{let N=J.dataset.baseKey;if(N&&U[N]!==void 0)if(J.type==="checkbox")J.checked=!!U[N];else J.value=U[N]})})}})}catch(H){console.error(H)}}clearData(){if(confirm("Clear all saved data? / "))localStorage.removeItem(this.formId),window.location.reload()}bakeValues(){this.updateJsonLd(),document.querySelectorAll("input, textarea, select").forEach(($)=>{if($.closest(".template-row"))return;if($.type==="checkbox"||$.type==="radio")if($.checked)$.setAttribute("checked","checked");else $.removeAttribute("checked");else if($.setAttribute("value",$.value),$.tagName==="TEXTAREA")$.textContent=$.value})}downloadHtml($,H,Q){let X=window,q=X.generatedJsonStructure&&X.generatedJsonStructure.name||"web-a-form";F$({documentHtml:document.documentElement.outerHTML,title:q,filenameSuffix:$,isFinal:H,...Q?{options:Q}:{}})}buildDraftState(){let $=this.updateJsonLd(),H=new Date().toISOString(),Q=localStorage.getItem(e0.L2_REPLAY_STORE_KEY),X;if(Q)try{let q=JSON.parse(Q);if(Array.isArray(q))X=q.filter((Z)=>typeof Z==="string")}catch(q){console.warn("Failed to parse L2 replay store for draft",q)}return{version:e0.DRAFT_STATE_VERSION,savedAt:H,formId:this.formId,formData:$,...X?{l2State:{replayNonces:X}}:{}}}saveDraft(){let $=this.buildDraftState();this.bakeValues(),this.downloadHtml("draft",!1,{draftState:$})}submitDocument(){this.bakeValues(),document.querySelectorAll(".search-suggestions").forEach(($)=>$.remove()),this.downloadHtml("submit",!0)}}class J4{calc;data;constructor($,H){this.calc=$,this.data=H,this.initSecuritySignal()}initSecuritySignal(){window.addEventListener("weba-security-tier-change",($)=>{this.updateSecurityBadge($.detail.tier)})}updateSecurityBadge($){let H=document.getElementById("weba-security-signal");if(!H)return;let Q=(navigator.language||"").toLowerCase().startsWith("ja"),X={high:Q?":  (True PFS)":"Security: HIGH (True PFS)",standard:Q?":  (Epoch-Based)":"Security: STANDARD (Epoch)",offline:Q?":  (Offline/Static)":"Security: BASIC (Offline)"};H.textContent=X[$],H.className=`security-badge tier-${$}`;let q=document.createElement("span");q.className="status-dot",H.prepend(q)}applyI18n(){let $={en:{add_row:"+ Add Row",work_save_btn:"Save",clear_btn:"Clear",sign_btn:"Submit"},ja:{add_row:"+ ",work_save_btn:"",clear_btn:"",sign_btn:""}},H=(navigator.language||"en").startsWith("ja")?"ja":"en",Q=$[H]||$.en;document.querySelectorAll("[data-i18n]").forEach((X)=>{let q=X.dataset.i18n;if(Q[q])X.textContent=Q[q]})}initTelFormatter(){document.querySelectorAll('input[type="tel"]').forEach(($)=>{if($.value)$.value=this.formatTelDisplay($.value);$.addEventListener("input",(H)=>{let Q=H.target.selectionStart,X=H.target.value,q=X.replace(/[^0-9]/g,""),Z=this.formatTelDisplay(q);if(Z!==X){H.target.value=Z;let Y=Z.length-X.length;H.target.setSelectionRange(Q+Y,Q+Y)}}),$.addEventListener("blur",(H)=>{let Q=H.target.value.replace(/[^0-9]/g,"");$.dataset.cleanValue=Q})})}formatTelDisplay($){let H=$.replace(/[^0-9]/g,"");if(H.length===0)return"";if(H.length===11&&H.startsWith("0"))return H.replace(/^(\d{3})(\d{4})(\d{4})$/,"$1-$2-$3");else if(H.length===10&&H.startsWith("0"))if(H.startsWith("0120")||H.startsWith("0800"))return H.replace(/^(\d{4})(\d{3})(\d{3})$/,"$1-$2-$3");else if(["03","04","06"].includes(H.substring(0,2)))return H.replace(/^(\d{2})(\d{4})(\d{4})$/,"$1-$2-$3");else return H.replace(/^(\d{3})(\d{3})(\d{4})$/,"$1-$2-$3");return H}initTables(){document.querySelectorAll(".data-table.dynamic tbody, .dynamic-container").forEach(($)=>{this.renumberRows($)})}renumberRows($){let H=Array.from($.querySelectorAll("tr"));if(H.length===0)H=Array.from($.querySelectorAll(".dynamic-row"));H.filter((X)=>{return X.tagName!=="TR"||X.querySelectorAll("td").length>0}).forEach((X,q)=>{let Z=q+1;X.querySelectorAll(".auto-num").forEach((Y)=>{if(Y.value!=Z)Y.value=Z.toString(),Y.dispatchEvent(new Event("input",{bubbles:!0}))})})}removeTableRow($){let H=$.closest("tr")||$.closest(".dynamic-row");if(!H)return;let Q=H.parentElement;if(H.classList.contains("template-row"))H.querySelectorAll("input").forEach((X)=>{if(X.type==="checkbox")X.checked=!1;else X.value=""});else{if(H.remove(),Q)this.renumberRows(Q);this.calc.recalculate(),this.data.updateJsonLd()}}addTableRow($,H){let Q=document.getElementById("tbl_"+H);if(!Q)return;let X=Q.querySelector("tbody")||Q;if(!X)return;let q=X.querySelector(".template-row");if(!q)return;let Z=q.cloneNode(!0);Z.classList.remove("template-row"),Z.querySelectorAll("input").forEach((U)=>{if(U.type==="checkbox")U.checked=U.hasAttribute("checked");else U.value=U.getAttribute("value")||""});let Y=Z.querySelector(".remove-row-btn");if(Y)Y.style.visibility="visible";Z.querySelectorAll("[data-copy-from]").forEach((U)=>{let G=U.dataset.copyFrom;if(G){let L=Z.querySelector(`[data-base-key="${G}"]`);if(L&&L.value)U.value=L.value}}),X.appendChild(Z),this.renumberRows(X),this.calc.recalculate()}switchTab($,H){document.querySelectorAll(".tab-btn").forEach((X)=>X.classList.remove("active")),document.querySelectorAll(".tab-content").forEach((X)=>X.classList.remove("active")),$.classList.add("active");let Q=document.getElementById(H);if(Q)Q.classList.add("active")}updateVisibility(){document.querySelectorAll("[data-show-if]").forEach(($)=>{let H=$.dataset.showIf;if(!H)return;let Q=H.match(/^([a-zA-Z0-9_]+)\s*(==|!=)\s*(['"]?)(.*?)\3$/),X=!0;if(Q){let[Z,Y,U,G,L]=Q,J=document.querySelector(`[data-json-path="${Y}"]`);if(!J){let N=$.closest("tr");if(N)J=N.querySelector(`[data-json-path="${Y}"]`)}if(J){let N=(J.type==="checkbox"||J.type==="radio")&&J.checked?"true":(J.type==="checkbox"||J.type==="radio")&&!J.checked?"false":J.value;if(J.type==="radio"){let K=J.name,R=document.querySelector(`input[name="${K}"]:checked`)}let M=J.value;if(J.type==="checkbox")M=J.checked?"true":"false";if(J.type==="radio"){let K=J.name,R=document.querySelector(`input[name="${K}"]:checked`);M=R?R.value:""}if(U==="==")X=M==L;if(U==="!=")X=M!=L}else X=!1}else{let Z=H.trim(),Y=document.querySelector(`[data-json-path="${Z}"]`);if(Y)if(Y.type==="checkbox")X=Y.checked;else X=!!Y.value;else X=!1}let q=$.closest(".form-row");if(q)q.style.display=X?"":"none",q.querySelectorAll("input, select, textarea").forEach((Y)=>{Y.disabled=!X});else if($.style.display=X?"":"none",$ instanceof HTMLInputElement||$ instanceof HTMLSelectElement||$ instanceof HTMLTextAreaElement)$.disabled=!X})}}function h0($){let H=($.dataset.jsonPath||$.dataset.baseKey||$.name||$.id||"").toLowerCase(),Q=[".","_","-"];for(let X of Q){if(!H.includes(X))continue;let q=H.split(X);if(q.length<2)continue;let Z=q[q.length-1];return{group:q.slice(0,-1).join(X),separator:X,fieldType:Z,raw:H}}return{group:null,separator:null,fieldType:H,raw:H}}function P8($,H){if(!$.group||!H.group)return!1;return $.group===H.group&&$.separator===H.separator}function x0($){if(!$)return null;if($.match(/zip|postal|postcode|/))return"zip";if($.match(/pref|/))return"pref";if($.match(/city||/))return"city";if($.match(/town|||/))return"town";if($.match(/address|/)&&!$.match(/detail|sub||building|room|mansion|house/))return"address";return null}function n$(){console.log("Web/A Runtime Booting...");let $=new x8,H=new e0,Q=new J4($,H),X=window,q=()=>{if(X.postalLookup&&!X.__postalInitialized)X.__postalInitialized=!0,X.postalLookup.autoInit().then(()=>console.log("\uD83D\uDCEE Postal lookup ready."))},Z=()=>{if(X.lgLookup&&!X.__lgInitialized)X.__lgInitialized=!0,X.lgLookup.autoInit().then(()=>console.log("\uD83C\uDFDB LG lookup ready."))};(async()=>{let L=X.__WEBA_MANIFEST;if(L&&L.blobs){let N=L.blobs.find((M)=>M.id==="weba-structure");if(N&&N.urls){console.log("[Runtime] Found weba-structure in manifest");for(let M of N.urls)try{let K;if(M.startsWith("#")){let x=document.querySelector(M);if(!x||!x.textContent)continue;let j=atob(x.textContent.trim()),g=new Uint8Array(j.length);for(let F=0;F<j.length;F++)g[F]=j.charCodeAt(F);let u=new Blob([g]).stream().pipeThrough(new DecompressionStream("gzip"));K=await new Response(u).text()}else{let x=await fetch(M);if(!x.ok)continue;K=await x.text()}let R=JSON.parse(K);return console.log("[Runtime] Structure data loaded from blob. Keys:",Object.keys(R)),R}catch(K){console.warn("[Runtime] Failed to load structure from:",M,K)}}}let J=document.getElementById("weba-structure");if(J)return console.log("[Runtime] Loading structure from direct element"),await o$(J);return console.warn("[Runtime] weba-structure not found in manifest or DOM"),null})().then((L)=>{if(L){if(X.generatedJsonStructure=L,console.log("[Runtime] generatedJsonStructure set"),Q.applyI18n(),Q.initTelFormatter(),$.recalculate(),Q.updateVisibility(),G4(),X.SearchEngine&&typeof X.SearchEngine.init==="function")console.log("[Runtime] Calling SearchEngine.init()..."),X.SearchEngine.init().catch((J)=>console.error("SearchEngine init failed:",J))}else console.warn("[Runtime] Failed to load structure data")}).catch((L)=>{console.error("[Runtime] Error loading structure:",L)});let U=document.getElementById("weba-l2-config");if(U)o$(U).then((L)=>{if(L)X.webaL2Config=L,$X(L),HX(L)});if(X.saveDraft=()=>H.saveDraft(),X.submitDocument=()=>H.submitDocument(),X.signAndDownload=()=>H.signAndDownload(),X.clearData=()=>H.clearData(),X.removeTableRow=(L)=>Q.removeTableRow(L),X.addTableRow=(L,J)=>Q.addTableRow(L,J),X.switchTab=(L,J)=>Q.switchTab(L,J),X.recalculate=()=>$.recalculate(),H.restoreFromLS(),Q.applyI18n(),Q.initTables(),$.recalculate(),X.initL2Viewer)X.initL2Viewer();if(X.initKeywrapTool)X.initKeywrapTool();if(X.initAggregatorBrowser)X.initAggregatorBrowser();q(),Z();let G;document.addEventListener("input",(L)=>{let J=L.target;if(!J||J.tagName!=="INPUT")return;if(L.isTrusted)J.dataset.dirty="true";let N=(J.dataset.jsonPath||J.name||"").toLowerCase(),M=J.value.trim(),K=X.postalLookup,R=J.classList.contains("search-input");if(K&&K.isReady()&&!R){N=(J.dataset.jsonPath||J.dataset.baseKey||J.name||J.id||"").toLowerCase();let j=(J.placeholder||"").toLowerCase(),g=J.dataset.autofill||"",u="";if(g.startsWith("postal:"))u=g.replace("postal:","");else if(N.match(/zip|postal|postcode|/)&&!N.match(/pref|city|town|address|||/)||j.match(/|zip|postal/))u="zip";else if(N.match(/pref|/))u="pref";else if(N.match(/city|/))u="city";else if(N.match(/town||/))u="town";else if(N.match(/address|/))u="address";if(u){let F=J.getAttribute("list");if(!F){F=`dl-${Math.random().toString(36).substr(2,5)}`,J.setAttribute("list",F);let f=document.createElement("datalist");f.id=F,document.body.appendChild(f)}let w=document.getElementById(F);if(u==="zip"){let f=M.replace(/[^0-9]/g,"");if(w&&f.length>=3){let S=K.suggest(f,50);w.innerHTML=S.map((T)=>`<option value="${T.zip.substring(0,3)}-${T.zip.substring(3)}">${T.pref}${T.city}${T.town}</option><option value="${T.zip}">${T.pref}${T.city}${T.town}</option>`).join("")}if(f.length===7){let S=K.lookup(f);if(S)eQ(J,S,J.closest("tr")||J.closest(".dynamic-row")||J.closest(".address-group")||J.closest("table")||J.closest("form")||document.body)}}else if(u==="pref"){if(w&&M.length>=1){let f=K.suggestByAddress(M,50),S=[...new Set(f.map((T)=>T.pref))].slice(0,10);w.innerHTML=S.map((T)=>`<option value="${T}">${T}</option>`).join("")}}else if(u==="city"){if(w&&M.length>=1){let f=K.suggestByAddress(M,50),S=[...new Set(f.map((T)=>T.city))].slice(0,20);w.innerHTML=S.map((T)=>`<option value="${T}">${T}</option>`).join("")}}else if(u==="town"||u==="address"){if(w&&M.length>=2){let f=K.suggestByAddress(M,30);w.innerHTML=f.map((S)=>`<option value="${S.town}">${S.pref}${S.city}${S.town}</option>`).join("")}}}}let x=X.lgLookup;if(x&&x.isReady()&&!R){let j=J.dataset.autofill||"",g=(F)=>{let w=F.closest("tr")||F.closest(".dynamic-row")||F.closest(".group")||F.closest("form")||document.body,f=Array.from(w.querySelectorAll("input, select, textarea")),S=null,T=null,o=null;return f.forEach((d)=>{let C0=d.dataset.autofill||"",R0=(d.dataset.jsonPath||d.name||d.id||"").toLowerCase();if(C0==="lg"||R0.match(/lg_code|lgcode|/))S=d;else if(C0==="lg:pref"||R0.match(/pref|/))T=d;else if(C0==="lg:city"||R0.match(/city|/))o=d}),{codeField:S,prefField:T,cityField:o}},u=(F,w)=>{let{codeField:f,prefField:S,cityField:T}=g(w);[{field:f,value:F.code},{field:S,value:F.pref},{field:T,value:F.city}].forEach(({field:o,value:d})=>{if(o&&o!==w&&d&&o.value!==d)o.value=d,o.dataset.dirty="true",o.style.backgroundColor="#e0f2fe",setTimeout(()=>{o.style.backgroundColor=""},500),o.dispatchEvent(new Event("input",{bubbles:!0})),o.dispatchEvent(new Event("change",{bubbles:!0}))})};if(j==="lg"){let F=J.getAttribute("list");if(!F){F=`dl-lg-${Math.random().toString(36).substr(2,5)}`,J.setAttribute("list",F);let S=document.createElement("datalist");S.id=F,document.body.appendChild(S)}let w=document.getElementById(F),f=M.replace(/[^0-9]/g,"");if(w&&f.length>=2&&f.length<6){let S=x.suggest(f,30);w.innerHTML=S.map((T)=>`<option value="${T.code}">${T.pref} ${T.city}</option>`).join("")}if(f.length===6){let S=x.lookup(f);if(S)u(S,J)}}else if(j==="lg:pref"){let F=J.getAttribute("list");if(!F){F=`dl-lg-pref-${Math.random().toString(36).substr(2,5)}`,J.setAttribute("list",F);let f=document.createElement("datalist");f.id=F,document.body.appendChild(f)}let w=document.getElementById(F);if(w&&M.length>=1){let S=x.getUniquePrefectures().filter((T)=>T.includes(M)).slice(0,20);w.innerHTML=S.map((T)=>`<option value="${T}">${T}</option>`).join("")}}else if(j==="lg:city"){let F=J.getAttribute("list");if(!F){F=`dl-lg-city-${Math.random().toString(36).substr(2,5)}`,J.setAttribute("list",F);let f=document.createElement("datalist");f.id=F,document.body.appendChild(f)}let w=document.getElementById(F);if(w&&M.length>=1){let{prefField:f}=g(J),S=f?f.value.trim():"",T;if(S)T=x.suggestCitiesByPref(S,M,30),w.innerHTML=T.map((d)=>`<option value="${d.city}">${d.city}</option>`).join("");else T=x.suggestByCity(M,void 0,30),w.innerHTML=T.map((d)=>`<option value="${d.city}">${d.pref} ${d.city}</option>`).join("");let o=T.find((d)=>d.city===M);if(o)u(o,J)}}}if(J.classList.contains("search-input")&&X.SearchEngine);if(N)(J.closest("tr")||J.closest(".dynamic-row")||J.closest(".group")||document).querySelectorAll(`[data-copy-from="${N}"]`).forEach((g)=>{if(!g.dataset.dirty&&g.value!==J.value)g.value=J.value,g.dispatchEvent(new Event("input",{bubbles:!0}))});$.recalculate(),Q.updateVisibility(),H.updateJsonLd(),G4(),clearTimeout(G),G=setTimeout(()=>H.saveToLS(),1000)}),setTimeout(G4,500),document.addEventListener("change",(L)=>{let J=L.target;if(!J||J.tagName!=="INPUT")return;let N=J.dataset.autofill||"",M=X.lgLookup;if(M&&M.isReady()&&N==="lg:city"){let K=J.value.trim();if(!K)return;let R=J.closest("tr")||J.closest(".dynamic-row")||J.closest(".group")||J.closest("form")||document.body,x=Array.from(R.querySelectorAll("input, select, textarea")),j=null;x.forEach((w)=>{let f=w.dataset.autofill||"",S=(w.dataset.jsonPath||w.name||w.id||"").toLowerCase();if(f==="lg:pref"||S.match(/pref|/))j=w});let g=j?j.value.trim():"",F=(g?M.suggestCitiesByPref(g,K,50):M.suggestByCity(K,void 0,50)).find((w)=>w.city===K);if(F)x.forEach((w)=>{if(w===J)return;let f=w.dataset.autofill||"",S=(w.dataset.jsonPath||w.name||w.id||"").toLowerCase(),T="";if(f==="lg"||S.match(/lg_code|lgcode|/))T=F.code;else if(f==="lg:pref"||S.match(/pref|/))T=F.pref;if(T&&w.value!==T)w.value=T,w.dataset.dirty="true",w.style.backgroundColor="#e0f2fe",setTimeout(()=>{w.style.backgroundColor=""},500),w.dispatchEvent(new Event("input",{bubbles:!0})),w.dispatchEvent(new Event("change",{bubbles:!0}))}),$.recalculate(),Q.updateVisibility(),H.updateJsonLd()}}),console.log("Web/A Runtime Ready.")}function rQ(){let $=window;if(!$.generatedJsonStructure||!$.generatedJsonStructure.fields)return!1;let H=Array.from(document.querySelectorAll("input, select, textarea"));for(let Q of H){if(Q.offsetParent===null)continue;let X=Q.dataset.jsonPath||Q.name;if(!X)continue;let q=$.generatedJsonStructure.fields.find((Z)=>Z.key===X);if(q&&q.required){if(Q.type==="checkbox"){if(!Q.checked)return console.log(`[Validation] Required Checkbox missing: ${X}`),!1}else if(Q.type==="radio"){let Z=document.getElementsByName(Q.name),Y=!1;for(let U=0;U<Z.length;U++)if(Z[U].checked){Y=!0;break}if(!Y)return console.log(`[Validation] Required Radio missing: ${X}`),!1}else if(!Q.value.trim())return console.log(`[Validation] Required Field empty: ${X}`),!1}}return!0}function G4(){let $=document.getElementById("btn-submit");if(!$)return;let H=rQ();$.disabled=!H,$.style.opacity=H?"1":"0.5",$.style.cursor=H?"pointer":"not-allowed",$.title=H?"":"Please fill in all required fields"}function eQ($,H,Q,X=!1){let q=h0($);if(!q.group){console.warn("[fillAddress] :",q.raw);return}let Y=Array.from(Q.querySelectorAll("input, select, textarea")).map((J)=>({element:J,parsed:h0(J)})).filter(({parsed:J})=>P8(q,J)),U=Y.some(({element:J,parsed:N})=>{if(J===$)return!1;return x0(N.fieldType||"")==="pref"}),G=Y.some(({element:J,parsed:N})=>{if(J===$)return!1;return x0(N.fieldType||"")==="city"}),L=Y.some(({element:J,parsed:N})=>{if(J===$)return!1;return x0(N.fieldType||"")==="town"});Y.forEach(({element:J,parsed:N})=>{if(J===$)return;let M=x0(N.fieldType||""),K="";if(X&&M==="zip")K=H.zip.substring(0,3)+"-"+H.zip.substring(3);else if(M==="pref")K=H.pref;else if(M==="city")K=H.city;else if(M==="town")K=H.town;else if(M==="address"){if(!U&&!G&&!L)K=`${H.pref}${H.city}${H.town}`;else if(U&&!G&&!L)K=`${H.city}${H.town}`;else if(!L)K=H.town}if(K&&J.value!==K)J.value=K,J.dataset.dirty="true",J.style.backgroundColor="#e0f2fe",setTimeout(()=>{J.style.backgroundColor=""},500),J.dispatchEvent(new Event("input",{bubbles:!0})),J.dispatchEvent(new Event("change",{bubbles:!0}))})}async function o$($){if(!$.textContent)return null;let H=$.textContent.trim();if($.type==="application/x-gzip")try{let Q=atob(H),X=new Uint8Array(Q.length);for(let Z=0;Z<Q.length;Z++)X[Z]=Q.charCodeAt(Z);let q=new Blob([X]).stream().pipeThrough(new DecompressionStream("gzip"));H=await new Response(q).text()}catch(Q){return null}try{return JSON.parse(H)}catch(Q){return null}}function $X($){let H=document.querySelector(".form-toolbar");if(!H)return;let Q=document.createElement("div");Q.id="weba-security-signal",Q.className="security-badge",H.appendChild(Q),(async()=>{let X="offline";if($.prekey_url)try{if((await fetch($.prekey_url,{method:"HEAD"})).ok)X="high"}catch(q){}window.dispatchEvent(new CustomEvent("weba-security-tier-change",{detail:{tier:X}}))})()}function HX($){if(!$?.enabled||!window.PublicKeyCredential)return;let H=document.querySelector('button[onclick*="signAndDownload"]');if(H&&H.parentElement){let Q=document.createElement("div");Q.className="weba-guest-opt no-print",Q.style.cssText="display:flex;align-items:center;gap:6px;margin-right:12px;",Q.innerHTML='<input type="checkbox" id="weba-guest-did-opt"><label for="weba-guest-did-opt" style="font-size:13px;color:#555;cursor:pointer;"> (Passkey)</label>',H.parentElement.insertBefore(Q,H)}}var F8=["","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","",""];class s${data={};initialized=!1;instanceId=Math.random().toString(36).substring(7);constructor(){console.log("[PostalLookup] New instance created:",this.instanceId)}async loadFromBase64($){try{let H=atob($),Q=new Uint8Array(H.length);for(let q=0;q<H.length;q++)Q[q]=H.charCodeAt(q);let X;if(Q[0]===31&&Q[1]===139)if(typeof DecompressionStream!=="undefined"){let q=new DecompressionStream("gzip"),Z=new Blob([Q]).stream().pipeThrough(q);X=await new Response(Z).text()}else throw new Error("DecompressionStream not supported");else X=new TextDecoder().decode(Q);this.data=JSON.parse(X),this.initialized=!0,console.log("\uD83D\uDCEE Postal lookup initialized:",Object.keys(this.data).length,"prefixes","[Instance:",this.instanceId+"]")}catch(H){console.error("Failed to load postal data:",H)}}async loadFromManifest(){let $=window.__WEBA_MANIFEST;if(!$||!$.blobs)return!1;let H=$.blobs.find((Q)=>Q.id==="jp-postal");if(!H||!H.urls||H.urls.length===0)return!1;for(let Q of H.urls)try{if(Q.startsWith("#")){let X=document.querySelector(Q);if(X&&X.textContent){if(console.log("\uD83D\uDCEE Loading postal data from embedded source:",Q),await this.loadFromBase64(X.textContent.trim()),this.initialized)return this._activeDigest=H.digest,!0}}else{console.log("\uD83D\uDCEE Loading postal data from network:",Q);let X=await fetch(Q);if(!X.ok)continue;let q=await X.blob(),Z,Y=new Uint8Array(await q.slice(0,2).arrayBuffer());if(Y[0]===31&&Y[1]===139)if(typeof DecompressionStream!=="undefined"){let U=new DecompressionStream("gzip"),G=q.stream().pipeThrough(U);Z=await new Response(G).text()}else throw new Error("DecompressionStream not supported");else Z=await q.text();return this.data=JSON.parse(Z),this.initialized=!0,this._activeDigest=H.digest,console.log("\uD83D\uDCEE Postal lookup initialized via Network:",Object.keys(this.data).length,"prefixes"),!0}}catch(X){console.warn(`Failed to load postal from ${Q}:`,X)}return!1}async autoInit(){if(this.initialized){console.log("\uD83D\uDCEE Postal lookup already initialized, skipping");return}if(await this.loadFromManifest())return;let $=document.getElementById("weba-postal-data");if($&&$.textContent)await this.loadFromBase64($.textContent.trim());else console.warn("No postal data found in document")}getActiveDigest(){return this._activeDigest||null}lookup($){if(!this.initialized)return null;let H=$.replace(/[^0-9]/g,"");if(H.length!==7)return null;let Q=H.substring(0,3),X=H.substring(3),q=this.data[Q];if(!q)return null;let Z=q.t.find(([Y])=>Y===X);if(!Z)return null;return{zip:H,pref:F8[q.p-1],city:Z[1],town:Z[2]}}suggest($,H=50){if(!this.initialized)return[];let Q=$.replace(/[^0-9]/g,"");if(Q.length<3)return[];let X=Q.substring(0,3),q=Q.substring(3),Z=[],Y=this.data[X];if(Y){for(let[U,G,L]of Y.t)if(!q||U.startsWith(q)){if(Z.push({zip:X+U,pref:F8[Y.p-1],city:G,town:L}),Z.length>=H)return Z}}return Z}getPrefixCandidates($){if(!this.initialized)return[];let H=$.replace(/[^0-9]/g,"");if(H.length!==3)return[];let Q=this.data[H];if(!Q)return[];return Q.t.map(([X,q,Z])=>({zip:H+X,pref:F8[Q.p-1],city:q,town:Z}))}suggestByAddress($,H=30){if(!this.initialized||$.length<2)return[];let Q=[],X=$.trim();for(let q in this.data){if(!Object.prototype.hasOwnProperty.call(this.data,q))continue;let Z=this.data[q];if(!Z)continue;let Y=F8[Z.p-1]||"";for(let[U,G,L]of Z.t)if((Y+G+L).includes(X)){if(Q.push({zip:q+U,pref:Y,city:G,town:L}),Q.length>=H)return Q}}return Q}isReady(){return this.initialized}}var L4=new s$;if(typeof window!=="undefined")if(!window.postalLookup)console.log("[PostalLookup] Registering instance to window:",L4.instanceId),window.postalLookup=L4;else console.log("[PostalLookup] window.postalLookup already exists, skipping registration. Existing instance:",window.postalLookup.instanceId,"New instance:",L4.instanceId);function $8($){if(!$)return"";return $.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;")}class B4{suggestionsVisible=!1;activeSearchInput=null;globalBox=null;postalReady=!1;constructor(){}async initPostalLookup(){try{let $=window.postalLookup;if($){if(await $.autoInit(),this.postalReady=$.isReady(),this.postalReady)console.log("\uD83D\uDCEE Postal lookup enabled")}}catch($){console.warn("Postal lookup not available:",$)}}async init(){console.log("Initializing Search Engine (Bundle)..."),await this.initPostalLookup();let H=window.generatedJsonStructure;if(H){if(H.masterDataRefs)await this.loadMasterDataFromBlobs(H);if(H.masterData){let Q=Object.keys(H.masterData);console.log("Master Data Keys available:",Q.join(", "))}}this.setupEventDelegation(),console.log("Search Engine ready. Postal enabled:",this.postalReady)}async loadMasterDataFromBlobs($){let H=window.__WEBA_MANIFEST;if(!H||!H.blobs)return;let Q=$.masterDataRefs;$.masterData=$.masterData||{};for(let[X,q]of Object.entries(Q)){let Z=H.blobs.find((Y)=>Y.digest===q);if(!Z||!Z.urls)continue;for(let Y of Z.urls)try{let U;if(Y.startsWith("#")){let G=document.querySelector(Y);if(!G||!G.textContent)continue;let L=atob(G.textContent.trim()),J=new Uint8Array(L.length);for(let M=0;M<L.length;M++)J[M]=L.charCodeAt(M);let N=new Blob([J]).stream().pipeThrough(new DecompressionStream("gzip"));U=await new Response(N).text()}else{let G=await fetch(Y);if(!G.ok)continue;U=await G.text()}$.masterData[X]=JSON.parse(U),console.log(`\uD83D\uDCEE Master data '${X}' loaded from blob:`,q);break}catch(U){console.warn(`Failed to load master data blob ${X} from ${Y}:`,U)}}}normalize($){if(!$)return"";let H=$.toString().toLowerCase();return H=H.replace(/[---]/g,(Q)=>{return String.fromCharCode(Q.charCodeAt(0)-65248)}),H=H.replace(/[-]/g,(Q)=>String.fromCharCode(Q.charCodeAt(0)-65248)),H.trim()}clean($){if(!$)return"";let H=this.normalize($);return H=H.replace(/(|||||npo||)/g,""),H=H.replace(/(\(\)|\(\)|\(\))/g,""),H.trim()}toIndex($){let H=parseInt($||"",10);return Number.isFinite(H)?H-1:-1}isPostalField($){if(($.dataset.autofill||"").startsWith("postal:"))return!0;let Q=($.dataset.jsonPath||$.dataset.baseKey||$.name||$.id||"").toLowerCase(),X=($.placeholder||"").toLowerCase(),q=Q.match(/zip|postal|postcode|/)&&!Q.match(/pref|city|town|address|||/),Z=X.match(/|zip|postal/);return Boolean(q||Z)}handlePostalInput($){if(console.log("[SearchEngine] handlePostalInput - postalReady:",this.postalReady),!this.postalReady){console.log("[SearchEngine] Postal not ready, hiding suggestions"),this.hideSuggestions();return}let H=$.value.replace(/[^0-9]/g,"");if(console.log("[SearchEngine] Cleaned postal value:",H),H.length<3){console.log("[SearchEngine] Value too short (<3), hiding suggestions"),this.hideSuggestions();return}let Q=window.postalLookup;if(!Q){console.log("[SearchEngine] ERROR: postalLookup not found on window");return}if(H.length===7){console.log("[SearchEngine] 7-digit zip, doing lookup");let q=Q.lookup(H);if(console.log("[SearchEngine] Lookup result:",q),q)this.fillPostalData($,q,!0),this.hideSuggestions();return}console.log("[SearchEngine] Partial zip, getting suggestions");let X=Q.suggest(H,50);if(console.log("[SearchEngine] Got",X.length,"suggestions"),X.length>0)this.renderPostalSuggestions($,X);else this.hideSuggestions()}renderPostalSuggestions($,H){let Q="";H.forEach((U)=>{let G=U.zip.substring(0,3)+"-"+U.zip.substring(3),L=`${U.pref} ${U.city} ${U.town}`,J=$8(JSON.stringify(U));Q+=`<div class="suggestion-item postal-item" data-postal="${J}" style="padding:6px 8px; cursor:pointer; border-bottom:1px solid #eee; font-size:14px; color:#333; display:flex; gap:12px; align-items:center;">
                <span style="color:#3b82f6; flex-shrink:0; min-width:85px;">${G}</span>
                <span style="color:#666; flex-grow:1; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">${$8(L)}</span>
            </div>`});let X=this.getGlobalBox();X.innerHTML=Q;let q=$.getBoundingClientRect(),Z=window.scrollY||document.documentElement.scrollTop,Y=window.scrollX||document.documentElement.scrollLeft;X.style.width=Math.max(q.width,400)+"px",X.style.left=q.left+Y+"px",X.style.top=q.bottom+Z+"px",X.style.maxHeight="360px",X.style.overflowY="auto",X.querySelectorAll(".suggestion-item").forEach((U)=>{U.onmouseenter=()=>U.style.background="#f0f8ff",U.onmouseleave=()=>U.style.background="white"}),X.style.display="block",this.suggestionsVisible=!0}fillPostalData($,H,Q=!1){if(Q)$.value=H.zip.substring(0,3)+"-"+H.zip.substring(3);let X=h0($);if(!X.group){console.warn("[fillPostalData] :",X.raw,": sender.zip, sender_zip, sender-zip");return}console.log("[fillPostalData] Source field group:",X.group,"separator:",X.separator);let q=$.closest(".dynamic-row")||$.closest(".address-group")||$.closest("table")||$.closest("form")||$.closest(".form-row")?.parentElement||document,Z=q===document?"document":$.closest("tr")?"tr":$.closest(".dynamic-row")?"dynamic-row":$.closest(".address-group")?"address-group":$.closest("table")?"table":$.closest("form")?"form":"form-row";console.log("[fillPostalData] Container type:",Z,"Source group:",X.group);let U=Array.from(q.querySelectorAll("input, select, textarea")).map((K)=>({element:K,parsed:h0(K)})).filter(({parsed:K})=>P8(X,K));console.log("[fillPostalData] Found",U.length,"fields in same group:",X.group);let G=new Map;for(let{element:K,parsed:R}of U){if(K===$)continue;let x=x0(R.fieldType||"");if(x&&!G.has(x))G.set(x,K)}let L=G.get("pref");if(L)L.value=H.pref,L.dispatchEvent(new Event("input",{bubbles:!0})),console.log("[fillPostalData] Filled pref:",L.dataset.jsonPath||L.name);let J=G.get("city");if(J)J.value=H.city,J.dispatchEvent(new Event("input",{bubbles:!0})),console.log("[fillPostalData] Filled city:",J.dataset.jsonPath||J.name);let N=G.get("town");if(N)N.value=H.town,N.dispatchEvent(new Event("input",{bubbles:!0})),console.log("[fillPostalData] Filled town:",N.dataset.jsonPath||N.name);let M=G.get("address");if(M){let K="";if(!L&&!J&&!N)K=`${H.pref}${H.city}${H.town}`;else if(L&&!J&&!N)K=`${H.city}${H.town}`;else if(!N)K=H.town;if(K)M.value=K,M.dispatchEvent(new Event("input",{bubbles:!0})),console.log("[fillPostalData] Filled address:",M.dataset.jsonPath||M.name,"=",K)}if(G.size===0)console.warn("[fillPostalData] :",X.group)}getGlobalBox(){if(this.globalBox&&!document.body.contains(this.globalBox))this.globalBox=null;if(!this.globalBox){if(this.globalBox=document.getElementById("web-a-search-suggestions"),!this.globalBox)this.globalBox=document.createElement("div"),this.globalBox.id="web-a-search-suggestions",this.globalBox.className="search-suggestions",Object.assign(this.globalBox.style,{display:"none",position:"absolute",background:"white",border:"1px solid #ccc",boxShadow:"0 4px 6px rgba(0,0,0,0.1)",zIndex:"9999",borderRadius:"4px"}),document.body.appendChild(this.globalBox)}return this.globalBox}hideSuggestions(){let $=this.getGlobalBox();if($)$.style.display="none";this.suggestionsVisible=!1,this.activeSearchInput=null}setupEventDelegation(){console.log("[SearchEngine] Setting up event delegation"),document.addEventListener("click",($)=>{if(this.suggestionsVisible&&!$.target.closest("#web-a-search-suggestions")&&$.target!==this.activeSearchInput)this.hideSuggestions()}),document.addEventListener("scroll",()=>{if(this.suggestionsVisible)this.hideSuggestions()},!0),document.body.addEventListener("input",($)=>{if(console.log("[SearchEngine] Input event on:",$.target.tagName,"classList:",$.target.classList.value),$.target.classList.contains("search-input"))console.log("[SearchEngine] Target has search-input class, handling"),this.handleSearchInput($.target);else console.log("[SearchEngine] Target does not have search-input class, ignoring")}),document.body.addEventListener("click",($)=>{let Q=$.target?.closest?.(".suggestion-item");if(Q)this.handleSelection(Q)})}handleSearchInput($){this.activeSearchInput=$;let H=window;if(console.log("[SearchEngine] handleSearchInput called for:",$.dataset.jsonPath||$.name,"value:",$.value),this.isPostalField($)){console.log("[SearchEngine] Detected as postal field, calling handlePostalInput"),this.handlePostalInput($);return}let Q=$.dataset.masterSrc,X=$.dataset.suggestSource;if(!Q&&!X)return;let q=this.toIndex($.dataset.masterLabelIndex),Z=this.toIndex($.dataset.masterValueIndex),Y=$.value;if(!Y){this.hideSuggestions();return}let U=[],G=this.normalize(Y);if(X==="column"){let L=$.dataset.baseKey,J=$.closest("table");if(J&&L){let N=new Set;J.querySelectorAll(`[data-base-key="${L}"]`).forEach((M)=>{if(M===$)return;let K=M.value;if(K&&this.normalize(K).includes(G)){if(!N.has(K))N.add(K),U.push({val:K,row:[K],label:K,score:10})}})}}else if(Q){if(console.log("[SearchEngine] Master search requested. srcKey:",Q),console.log("[SearchEngine] generatedJsonStructure exists?",!!H.generatedJsonStructure),H.generatedJsonStructure){if(console.log("[SearchEngine] masterData exists?",!!H.generatedJsonStructure.masterData),H.generatedJsonStructure.masterData)console.log("[SearchEngine] Available master keys:",Object.keys(H.generatedJsonStructure.masterData))}if(!H.generatedJsonStructure||!H.generatedJsonStructure.masterData)return;let L=H.generatedJsonStructure.masterData;if(!L[Q]){console.log("[SearchEngine] Master key not found:",Q);return}L[Q].forEach((N,M)=>{if(M===0)return;if(N.some((R)=>this.normalize(R||"").includes(G))){let R=q>=0?N[q]||"":"",x=Z>=0?N[Z]||"":"",j=Z>=0?x:q>=0?R:N[1]||N[0]||"";U.push({val:j,row:N,label:R,score:10,idx:M})}})}this.renderSuggestions($,U,q)}renderSuggestions($,H,Q){if(H.length===0){this.hideSuggestions();return}let X=H.slice(0,10),q="";X.forEach((L)=>{let J=$8(JSON.stringify(L.row)),N=Q>=0?L.label||L.row.join(" : "):L.row.join(" : ");q+=`<div class="suggestion-item" data-val="${$8(L.val)}" data-row="${J}" style="padding:8px; cursor:pointer; border-bottom:1px solid #eee; font-size:14px; color:#333;">${$8(N)}</div>`});let Z=this.getGlobalBox();Z.innerHTML=q;let Y=$.getBoundingClientRect(),U=window.scrollY||document.documentElement.scrollTop,G=window.scrollX||document.documentElement.scrollLeft;Z.style.width=Math.max(Y.width,200)+"px",Z.style.left=Y.left+G+"px",Z.style.top=Y.bottom+U+"px",Z.style.maxHeight="300px",Z.style.overflowY="auto",Z.querySelectorAll(".suggestion-item").forEach((L)=>{L.onmouseenter=()=>L.style.background="#f0f8ff",L.onmouseleave=()=>L.style.background="white"}),Z.style.display="block",this.suggestionsVisible=!0}handleSelection($){if(!this.activeSearchInput)return;if($.classList.contains("postal-item")){let Z=$.dataset.postal;if(Z)try{let Y=JSON.parse(Z);this.fillPostalData(this.activeSearchInput,Y,!0)}catch(Y){console.error("Failed to parse postal data:",Y)}this.hideSuggestions();return}let H=window,Q=this.activeSearchInput,X=$.dataset.val||"",q=$.dataset.row||"[]";try{let Z=JSON.parse(q),Y=Q.dataset.masterSrc,U=Y?H.generatedJsonStructure.masterData[Y][0]:[],G=!1;if(U.length>0&&Z.length>0){let L=Q.closest("tr");if(L){let J=Array.from(L.querySelectorAll("input, select, textarea"));U.forEach((N,M)=>{if(!N)return;let K=Z[M];this.fillField(J,N,K,Q,()=>{G=!0})})}}if(!G)Q.value=X,Q.dispatchEvent(new Event("input",{bubbles:!0}))}catch(Z){console.error(Z)}this.hideSuggestions()}fillField($,H,Q,X,q){let Z=this.normalize(H),Y=$.find((U)=>{let G=U.dataset.baseKey||U.dataset.jsonPath,L=this.normalize(U.getAttribute("placeholder")||"");return G&&this.normalize(G)===Z||L===Z});if(Y){if(Y.value=Q||"",Y.dispatchEvent(new Event("input",{bubbles:!0})),Y===X)q()}}}var i$=new B4;window.GlobalSearch=i$;window.SearchEngine=i$;n$();
